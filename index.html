console.log("--- V100 FINAL FULL CODE ---");

/**
 * OSINFOHUB ‚Äì EDGE INTEL BRAIN (V100)
 * Stack: Cloudflare Workers + KV + Groq + Resend
 *
 * STATUS: üü¢ LIVE & COMPLETE
 * - DATA: 100% Full City List (Restored).
 * - DATA: 100% Full Source List.
 * - ENGINE: Stable V97 Logic (JSON Scrubber + 8b Model).
 * - EMAIL: Pro Format.
 */

// --- CONFIGURATION ---
const BATCH_SIZE = 6; 
const EMAIL_THRESHOLD = 3; 

const CORS = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Methods": "GET,POST,OPTIONS",
  "Access-Control-Allow-Headers": "Content-Type,secret",
};

// --- EMAIL SETTINGS ---
const EMAIL_FROM = "OSINT Alerts <onboarding@resend.dev>";
const ADMIN_EMAIL = "vssmaximus@gmail.com";

// --- MASTER FEED LIST ---
const SOURCES = [
  // --- INDIA STRATEGIC ---
  "https://news.google.com/rss/search?q=India+security+safety&hl=en-IN&gl=IN&ceid=IN:en",
  "https://www.indiatoday.in/rss/home",
  "https://www.hindustantimes.com/feeds/rss/india-news/rssfeed.xml",
  "https://www.thehindu.com/news/national/feeder/default.rss",
  "https://timesofindia.indiatimes.com/rssfeedstopstories.cms",

  // --- STRATEGIC & GOVT ---
  "https://www.osac.gov/Content/RSS/Alerts",
  "https://www.gov.uk/government/organisations/foreign-commonwealth-development-office.atom",
  
  // --- APJC ---
  "https://www.straitstimes.com/news/singapore/rss.xml",
  "https://www.channelnewsasia.com/api/v1/rss-outbound-feed?_format=xml",
  "https://e.vnexpress.net/rss/news.rss",
  "https://www.inquirer.net/fullfeed",
  "https://www.bangkokpost.com/rss/data/topstories.xml",
  "https://www.rnz.co.nz/rss/news.xml",
  "https://news.google.com/rss/search?q=New+Zealand+Security&hl=en-NZ&gl=NZ&ceid=NZ:en",
  "https://www.abc.net.au/news/feed/45910/rss.xml",
  "https://www.japantimes.co.jp/feed",
  "https://www.scmp.com/rss/91/feed",
  "http://www.koreaherald.com/rss/rss_1.xml",
  "https://focustaiwan.tw/rss/news",

  // --- AMER / EMEA ---
  "https://globalnews.ca/feed/",
  "https://mexiconewsdaily.com/feed/",
  "https://en.mercopress.com/rss",
  "https://www.riotimesonline.com/feed/",
  "https://www.theguardian.com/world/rss",
  "https://www.france24.com/en/rss",
  "https://rss.dw.com/rdf/rss-en-all",
  "https://www.aljazeera.com/xml/rss/all.xml",

  // --- LOGISTICS ---
  "https://www.freightwaves.com/feed",
  "https://www.supplychaindive.com/feeds/news/",
  "https://gcaptain.com/feed/",
  "https://www.porttechnology.org/feed/",
  "https://www.logisticsmgmt.com/rss/Logistics_Mgmt",
  "https://newsroom.fmglobal.com/rss/supply-chain",

  // --- CYBER ---
  "https://www.cisa.gov/cybersecurity-advisories/all.xml",
  "https://therecord.media/feed",
  "https://www.theregister.com/security/headlines.atom",
  "https://www.gdacs.org/Content/feeds/all.xml",
  "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/4.5_week.atom"
];

// --- NOISE BLOCKER ---
const IGNORE_REGEX = /sport|hockey|soccer|football|cricket|tennis|nfl|nba|f1|champions league|celebrity|movie|gossip|arts|culture|review|recipe|festivals|concert|fashion|royal|lifestyle|horoscope|bowler|wicket|batsman|ipl|innings|match/i;

// --- FALLBACK REGEX ---
const RISK_REGEX = /shooting|gunman|active shooter|attack|terror|hostage|kidnap|bomb|explosion|riot|protest|unrest|coup|cartel|siege|killed|dead|injured|death|fatal|earthquake|tsunami|flood|cyclone|typhoon|hurricane|tornado|volcano|ransomware|data breach|cyber|malware|outage|blackout|grid failure|strike|port closed|airport closed|cargo|supply chain|logistics|embargo|pandemic|outbreak|quarantine|fire|arrest|crash|derailment|warning|alert|crisis|emergency|risk|threat|security|disruption|delay|police|military|conflict|tension|border|jail|court|crime|law|sentence|blockade|sanction|tariff|trade war/i;

// --- SMART PACK DEFINITIONS ---
const SMART_PACKS = {
  PHYSICAL: {
    include: ["active shooter", "shots fired", "shooting", "gunman", "armed suspect", "armed attack", "stabbing", "hostage", "kidnap", "bomb", "ied", "explosion", "terror", "militant", "extremist", "assassination", "ambush", "riot", "looting", "arson", "civil unrest", "violent protest", "clashes", "lockdown", "evacuation", "curfew", "martial law", "manhunt", "swat", "navy", "army", "military", "defense", "carrier", "warship"],
    boosters: ["mass casualty", "multiple dead", "fatalities", "injured", "school", "campus", "mall", "airport", "metro", "station"]
  },
  CYBER: {
    include: ["ransomware", "data breach", "security breach", "compromised", "malware", "trojan", "botnet", "phishing", "zero-day", "exploit", "backdoor", "ddos", "cyber attack", "hacker", "leak"],
    boosters: ["operations halted", "systems offline", "critical infrastructure", "data leaked", "production outage"]
  },
  INFRASTRUCTURE: {
    include: ["power outage", "blackout", "grid failure", "load shedding", "water outage", "telecom", "internet outage", "cloud outage", "data center", "service disruption", "smog", "pollution", "visibility"],
    boosters: ["nationwide", "critical services", "emergency services", "indefinite"]
  },
  DISASTER: {
    include: ["earthquake", "tsunami", "volcano", "cyclone", "typhoon", "hurricane", "tornado", "storm", "flood", "wildfire", "bushfire", "landslide", "blizzard", "quake", "magnitude"],
    boosters: ["evacuation", "destroyed", "damaged", "warning"]
  },
  LOGISTICS: {
    include: ["port closed", "airport closed", "flight cancellations", "shipping delays", "congestion", "vessel collision", "derailment", "train crash", "bridge collapse", "road closure", "border closure", "strike", "work stoppage", "embargo", "sanctions", "blockade", "tariff", "trade war"],
    boosters: ["indefinite", "halted", "shutdown", "disruption"]
  }
};

// --- CITY LOOKUP (FULL RESTORED) ---
const CITY_COORDS = {
  "round rock": { lat: 30.5083, lng: -97.6788 },
  "austin": { lat: 30.2672, lng: -97.7431 },
  "hopkinton": { lat: 42.2287, lng: -71.5226 },
  "franklin": { lat: 42.0834, lng: -71.3967 },
  "apex": { lat: 35.7327, lng: -78.8503 },
  "eden prairie": { lat: 44.8617, lng: -93.4168 },
  "draper": { lat: 40.5240, lng: -111.8950 },
  "nashville": { lat: 36.1627, lng: -86.7816 },
  "oklahoma city": { lat: 35.4676, lng: -97.5164 },
  "santa clara": { lat: 37.3541, lng: -121.9552 },
  "mclean": { lat: 38.9295, lng: -77.2268 },
  "el paso": { lat: 31.8385, lng: -106.5278 },
  "new york": { lat: 40.7128, lng: -74.0060 },
  "san francisco": { lat: 37.7749, lng: -122.4194 },
  "bangalore": { lat: 12.9716, lng: 77.5946 },
  "bengaluru": { lat: 12.9716, lng: 77.5946 },
  "delhi": { lat: 28.6139, lng: 77.2090 },
  "mumbai": { lat: 19.0760, lng: 72.8777 },
  "hyderabad": { lat: 17.3850, lng: 78.4867 },
  "chennai": { lat: 13.0827, lng: 80.2707 },
  "pune": { lat: 18.5204, lng: 73.8567 },
  "gurugram": { lat: 28.4595, lng: 77.0266 },
  "noida": { lat: 28.5355, lng: 77.3910 },
  "london": { lat: 51.5074, lng: -0.1278 },
  "bracknell": { lat: 51.4160, lng: -0.7540 },
  "dublin": { lat: 53.3498, lng: -6.2603 },
  "limerick": { lat: 52.6638, lng: -8.6267 },
  "cork": { lat: 51.8985, lng: -8.4756 },
  "glasgow": { lat: 55.8642, lng: -4.2518 },
  "paris": { lat: 48.8566, lng: 2.3522 },
  "montpellier": { lat: 43.6108, lng: 3.8767 },
  "frankfurt": { lat: 50.1109, lng: 8.6821 },
  "halle": { lat: 51.4820, lng: 11.9700 },
  "amsterdam": { lat: 52.3676, lng: 4.9041 },
  "lodz": { lat: 51.7285, lng: 19.4967 },
  "casablanca": { lat: 33.5731, lng: -7.5898 },
  "cairo": { lat: 30.0444, lng: 31.2357 },
  "dubai": { lat: 25.2048, lng: 55.2708 },
  "tel aviv": { lat: 32.0853, lng: 34.7818 },
  "herzliya": { lat: 32.1644, lng: 34.7961 },
  "haifa": { lat: 32.7940, lng: 34.9896 },
  "singapore": { lat: 1.3521, lng: 103.8198 },
  "sydney": { lat: -33.8688, lng: 151.2093 },
  "melbourne": { lat: -37.8136, lng: 144.9631 },
  "auckland": { lat: -36.8485, lng: 174.7633 },
  "wellington": { lat: -41.2865, lng: 174.7762 },
  "tokyo": { lat: 35.6762, lng: 139.6503 },
  "kawasaki": { lat: 35.5300, lng: 139.6960 },
  "taipei": { lat: 25.0330, lng: 121.5654 },
  "shanghai": { lat: 31.2304, lng: 121.4737 },
  "beijing": { lat: 39.9042, lng: 116.4074 },
  "chengdu": { lat: 30.5728, lng: 104.0668 },
  "xiamen": { lat: 24.4798, lng: 118.0894 },
  "penang": { lat: 5.4164, lng: 100.3327 },
  "cyberjaya": { lat: 2.9213, lng: 101.6559 },
  "panama city": { lat: 8.9824, lng: -79.5199 },
  "mexico city": { lat: 19.4326, lng: -99.1332 },
  "sao paulo": { lat: -23.5505, lng: -46.6333 },
  "hortolandia": { lat: -22.8583, lng: -47.2208 },
  "porto alegre": { lat: -30.0346, lng: -51.2177 }
};

// --- SCORING ENGINE ---
function calculateSmartScore(text) {
  let score = 0;
  let matches = [];
  const lowerText = text.toLowerCase();
  for (const [pack, data] of Object.entries(SMART_PACKS)) {
    for (const word of data.include) {
      if (lowerText.includes(word)) {
        score += 1;
        matches.push(pack);
      }
    }
    for (const word of data.boosters) {
      if (lowerText.includes(word)) {
        score += 3;
      }
    }
  }
  return { score, matches: [...new Set(matches)] };
}

// --- SELF-HEALING URL SANITIZER ---
function cleanUrl(url) {
    let clean = url.trim();
    if (clean.startsWith("[")) {
        const match = clean.match(/\((https?:\/\/[^\)]+)\)/);
        if (match) return match[1];
        const match2 = clean.match(/\[(https?:\/\/[^\]]+)\]/);
        if (match2) return match2[1];
    }
    return clean;
}

export default {
  async fetch(req, env, ctx) {
    if (req.method === "OPTIONS") return new Response(null, { headers: CORS });
    const url = new URL(req.url);

    if (url.pathname === "/api/incidents") {
      const data = await env.INTEL_KV.get("incidents");
      return new Response(data || "[]", { headers: { ...CORS, "Content-Type": "application/json" } });
    }

    if (url.pathname === "/api/ingest" && req.method === "POST") {
      const secret = req.headers.get("secret");
      if (!secret || secret !== env.INGEST_SECRET) {
        return new Response("Unauthorized", { status: 403, headers: CORS });
      }
      ctx.waitUntil(runIngestion(env));
      return new Response("Ingestion triggered", { headers: CORS });
    }
    return new Response("osinfohub online", { headers: CORS });
  },

  async scheduled(event, env, ctx) {
    ctx.waitUntil(runIngestion(env));
  },
};

async function runIngestion(env) {
  console.log("--- V100 FINAL FULL CODE ACTIVE ---");
  let totalItems = 0;
  let regexHits = 0;
  let aiSuccess = 0;

  if (!env.GROQ_API_KEY) {
    console.log("CRITICAL ERROR: GROQ_API_KEY is missing.");
    return;
  }

  const existing = (await env.INTEL_KV.get("incidents", { type: "json" })) || [];
  const seen = new Set(existing.map((i) => i.id));
  const fresh = [];

  const shuffled = [...SOURCES].sort(() => 0.5 - Math.random());
  const batch = shuffled.slice(0, BATCH_SIZE);

  for (const rawSrc of batch) {
    const src = cleanUrl(rawSrc); // SANITIZE
    console.log(`Checking: ${src}`);
    
    // Safety check for valid URL format
    try { new URL(src); } catch(e) { console.log(`Skipping Bad URL: ${src}`); continue; }

    try {
      const resp = await fetch(src, {
        headers: {
          "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
          "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
        },
      });

      if (!resp.ok) {
        console.log(`Error ${resp.status} fetching ${src}`);
        continue;
      }

      const xml = await resp.text();
      // BRUTE FORCE PARSER
      const items = parseUniversal(xml).slice(0, 5);
      console.log(`> Found ${items.length} items.`);

      for (const item of items) {
        totalItems++;
        const id = stableId(item.link || item.title);
        
        if (seen.has(id)) {
            continue; 
        }
        seen.add(id);

        const text = `${item.title} ${item.summary}`.trim();
        
        // 1. NOISE BLOCKER
        if (IGNORE_REGEX.test(text)) continue;

        // 2. INDIA/DELL FORCE BYPASS
        const lowerSrc = src.toLowerCase();
        const isIndia = lowerSrc.includes("india") || lowerSrc.includes("ndtv") || lowerSrc.includes("hindu") || lowerSrc.includes("google") || /dell|bangalore|bengaluru|mumbai|hyderabad/i.test(text);

        // 3. SMART FILTER SCORING
        const smartData = calculateSmartScore(text);
        const smartPass = smartData.score >= 1;
        const riskPass = RISK_REGEX.test(text);

        // 4. DECISION
        const shouldAnalyze = isIndia || smartPass || riskPass;

        if (!shouldAnalyze) {
           console.log(`[Filter Debug] Skipped: ${item.title.slice(0,40)}`);
           continue; 
        }
        
        regexHits++;
        console.log(`AI Analyzing: ${item.title}`);
        
        // 1s DELAY (Speedy but safe)
        await new Promise(r => setTimeout(r, 1000));

        let ai = await callGroq(env.GROQ_API_KEY, text);
        if (!ai) {
            await new Promise(r => setTimeout(r, 1000));
            ai = await callGroq(env.GROQ_API_KEY, text);
        }
        
        if (!ai || typeof ai !== "object") {
             console.log(`> AI Skipped (Failed).`);
             continue;
        }
        
        const schemaOk = 
          typeof ai.summary === "string" &&
          typeof ai.category === "string" &&
          Number.isFinite(parseInt(ai.severity, 10));

        if (!schemaOk) {
          console.log("> AI JSON missing fields");
          continue;
        }

        aiSuccess++;

        const coords = resolveCoords(ai.location, item);
        const prox = proximity(coords.lat, coords.lng);

        // --- N/A FIXER ---
        let cleanCountry = (ai.country || "GLOBAL").toUpperCase();
        if (cleanCountry === "N/A" || cleanCountry === "NONE" || cleanCountry === "UNKNOWN") cleanCountry = "GLOBAL";
        
        let cleanLocation = (ai.location || "UNKNOWN").toUpperCase();
        if (cleanLocation === "N/A" || cleanLocation === "NONE") cleanLocation = "UNKNOWN";

        const incident = {
          id,
          title: item.title,
          link: item.link || "",
          summary: ai.summary || item.summary || "",
          category: ai.category || "UNKNOWN",
          severity: clampInt(ai.severity, 1, 5),
          region: normalizeRegion(ai.region),
          country: cleanCountry,
          location: cleanLocation,
          lat: coords.lat,
          lng: coords.lng,
          nearest_site: prox.site,
          distance_km: prox.dist,
          time: new Date().toISOString(),
          source: src,
          smart_score: smartData.score,
          smart_packs: smartData.matches,
          india_priority: !!isIndia,
        };

        fresh.push(incident);

        console.log(`> Incident Sev: ${incident.severity}`);
        if (incident.severity >= EMAIL_THRESHOLD) {
          console.log(">>> TRIGGERING SRO ALERT");
          await sendEmail(env, incident);
        }
      }
    } catch (e) {
      console.log(`Loop Error: ${e.message}`);
    }
  }

  console.log(`STATS totalItems=${totalItems} regexHits=${regexHits} aiSuccess=${aiSuccess} freshSaved=${fresh.length}`);

  if (fresh.length) {
    const merged = [...fresh, ...existing].slice(0, 200);
    await env.INTEL_KV.put("incidents", JSON.stringify(merged));
  }
}

// --- AI BRAIN (8B MODEL + SCRUBBER) ---
async function callGroq(apiKey, text) {
  if (!apiKey) return null;

  const payload = {
    model: "llama-3.1-8b-instant", // USE 8B INSTANT FOR STABILITY
    temperature: 0,
    max_tokens: 300,
    response_format: { type: "json_object" }, // FORCE JSON
    messages: [
      {
        role: "system",
        content: `You are an SRO Analyst. Scoring: 5=Active Attack/Disaster, 4=Riot/Coup/GridDown, 3=Protest/Arrest/TravelWarning, 1-2=History/Politics/General. 
        
        Generate a concise, 3-sentence summary suitable for a security briefing.
        
        JSON Only: { 
          "summary":"3-4 sentences summarizing the threat and impact", 
          "category":"PHYSICAL|CYBER|WEATHER|SUPPLY|HEALTH", 
          "severity":1-5, 
          "region":"APJC|EMEA|AMER|GLOBAL", 
          "country":"Country Name", 
          "location":"City Name" 
        }`,
      },
      {
        role: "user",
        content: `Input:\n${text.slice(0, 700)}`,
      },
    ],
  };

  try {
    const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
      method: "POST",
      headers: { Authorization: `Bearer ${apiKey}`, "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    
    if (!resp.ok) {
        const err = await resp.text();
        console.log(`GROQ Error: ${err.slice(0,100)}`);
        return null;
    }
    
    const j = await resp.json();
    let content = j.choices[0].message.content;

    // --- JSON SCRUBBER (FIX) ---
    const jsonStart = content.indexOf('{');
    const jsonEnd = content.lastIndexOf('}');
    if (jsonStart !== -1 && jsonEnd !== -1) {
        content = content.substring(jsonStart, jsonEnd + 1);
    }

    return JSON.parse(content);
  } catch (e) {
    console.log("GROQ Exception:", e.message);
    return null;
  }
}

// --- BRUTE FORCE PARSER ---
function parseUniversal(xml) {
  const items = [];
  const rssItems = xml.match(/<item(?:[\s\S]*?)>([\s\S]*?)<\/item>/gi) || [];
  for (const block of rssItems) extract(block);
  const atomEntries = xml.match(/<entry(?:[\s\S]*?)>([\s\S]*?)<\/entry>/gi) || [];
  for (const block of atomEntries) extract(block);

  if (items.length === 0) {
      const titles = xml.match(/<title>([^<]+)<\/title>/gi) || [];
      const links = xml.match(/<link>([^<]+)<\/link>/gi) || [];
      for(let i=0; i<Math.min(titles.length, 10); i++) {
          const t = decodeHtml(titles[i].replace(/<\/?title>/g, ""));
          const l = links[i] ? links[i].replace(/<\/?link>/g, "") : "";
          if (t && t.length > 10) items.push({ title: t, link: l, summary: t });
      }
  }

  function extract(blob) {
    const title = decodeHtml(((blob.match(/<title[^>]*>([\s\S]*?)<\/title>/i) || [])[1] || "")).replace(/<!\[CDATA\[(.*?)\]\]>/g, "$1").trim();
    // LINK SCRUBBER: Removes CDATA from the link too
    let link = (blob.match(/<link[^>]+href=["'](.*?)["']/i) || blob.match(/<link[^>]*>([\s\S]*?)<\/link>/i) || [])[1] || "";
    link = link.replace(/<!\[CDATA\[(.*?)\]\]>/g, "$1").trim();
    
    const summary = decodeHtml(((blob.match(/<description[^>]*>([\s\S]*?)<\/description>/i) || [])[1] || (blob.match(/<summary[^>]*>([\s\S]*?)<\/summary>/i) || [])[1] || "").replace(/<[^>]+>/g, " ").trim());
    const lat = (blob.match(/<geo:lat[^>]*>(.*?)<\/geo:lat>/i) || [])[1];
    const lng = (blob.match(/<geo:long[^>]*>(.*?)<\/geo:long>/i) || [])[1];
    if (title) items.push({ title, link, summary, lat, lng });
  }
  return items;
}

function resolveCoords(locationStr, item) {
  if (item.lat && item.lng) return { lat: parseFloat(item.lat), lng: parseFloat(item.lng) };
  if (!locationStr) return { lat: 0, lng: 0 };
  const key = locationStr.toLowerCase().split(",")[0].trim();
  return CITY_COORDS[key] || { lat: 0, lng: 0 };
}

function proximity(lat, lng) {
  if (!lat || !lng) return { dist: 9999, site: null };
  let bestDist = 9999;
  let bestSite = null;
  for (const name of Object.keys(CITY_COORDS)) {
    const s = CITY_COORDS[name];
    const d = haversine(lat, lng, s.lat, s.lng);
    if (d < bestDist) { bestDist = d; bestSite = name; }
  }
  return { dist: Math.round(bestDist), site: bestSite };
}

function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371; const toRad = (x) => (x * Math.PI) / 180;
  const dLat = toRad(lat2 - lat1); const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
  return 2 * R * Math.asin(Math.sqrt(a));
}

// --- INDUSTRY STANDARD EMAIL SENDER ---
async function sendEmail(env, inc) {
  if (!env.RESEND_API_KEY) return;
  const to = ADMIN_EMAIL;
  
  const emoji = inc.severity === 5 ? "üö® CRITICAL" : "‚ö†Ô∏è ALERT";
  const subject = `${emoji} [${(inc.country || "GLOBAL").toUpperCase()}] ${(inc.location || "UNKNOWN").toUpperCase()} - ${inc.category}: ${inc.title.slice(0, 60)}...`;

  const html = `
    <div style="font-family: Arial, sans-serif; color: #333; line-height: 1.5;">
      <h2 style="color: #d32f2f; margin-top: 0;">${subject}</h2>
      
      <p style="font-size: 14px;"><b>Executive Summary:</b><br>${inc.summary}</p>
      
      <hr style="border: 0; border-top: 1px solid #eee;">
      
      <p style="background-color: #fff3cd; padding: 10px; font-size: 13px; border-left: 4px solid #ffc107;">
        <b>Strategic Context:</b> This event requires monitoring for potential impact to personnel safety, asset security, or supply chain continuity in the <b>${inc.region}</b> region.
      </p>
      
      <p><b>Location:</b> ${inc.location}, ${inc.country} (Dist: ${inc.distance_km}km to nearest Dell Site)</p>
      <p><b>Source:</b> <a href="${inc.link}" style="color: #1976d2;">Read Full Article</a></p>
      
      <p style="font-size: 10px; color: #888; margin-top: 20px;">
        Severity: ${inc.severity}/5 | ID: ${inc.id} | Auto-Generated by OSInfoHub
      </p>
    </div>
  `;

  try {
    await fetch("https://api.resend.com/emails", {
      method: "POST",
      headers: { Authorization: `Bearer ${env.RESEND_API_KEY}`, "Content-Type": "application/json" },
      body: JSON.stringify({ 
        from: EMAIL_FROM, 
        to: [to], 
        subject: subject, 
        html: html 
      }),
    });
    console.log(`‚úÖ EMAIL SENT: ${subject}`);
  } catch (e) {
    console.log("[Email Error]", String(e));
  }
}

function stableId(s) { let h = 0; for (let i = 0; i < s.length; i++) h = (h << 5) - h + s.charCodeAt(i); return String(h); }
function normalizeRegion(r) { const x = String(r || "").toUpperCase().trim(); return (["APJC","EMEA","AMER"].includes(x)) ? x : "GLOBAL"; }
function clampInt(v, min, max) { const n = parseInt(v, 10); return (!Number.isFinite(n)) ? min : Math.max(min, Math.min(max, n)); }
function decodeHtml(s) { return String(s || "").replaceAll("&amp;", "&").replaceAll("&lt;", "<").replaceAll("&gt;", ">").replaceAll("&quot;", '"').replaceAll("&#039;", "'"); }
function escapeHtml(s) { return String(s || "").replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#039;"); }
