<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OS | INFOHUB</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    :root{--dell-blue:#0076CE;--bg-dark:#0f1115}
    body{background:var(--bg-dark);font-family:Inter,sans-serif;padding:20px}
    .app-container{background:#fff;border-radius:16px;padding:0;box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .header-container{display:flex;align-items:center;justify-content:space-between;padding:12px 24px;border-bottom:1px solid #eee}
    .logo-text{font-weight:800;color:#202124}
    .map-wrapper{height:500px;border-radius:12px;overflow:hidden;background:#eef2f6;margin:18px}
    #map{width:100%;height:100%}
    .feed-card{display:block;background:#fff;border:1px solid #eee;border-radius:8px;margin-bottom:12px;text-decoration:none;color:inherit}
    .feed-status-bar{width:6px;flex-shrink:0}
    .feed-content{padding:14px}
    .ftag{padding:3px 8px;border-radius:4px;font-weight:700;font-size:0.75rem;margin-right:8px}
    .ftag-loc{background:#202124;color:#fff}
    .alert-row{padding:12px;border-bottom:1px solid #eee}
    .advisory-box{padding:12px;border-radius:8px;border:1px solid #ddd;margin-top:12px}
    .news-box-alert{margin-top:10px;border-radius:8px;border:1px solid #e6e6e6}
    .news-box-header{background:#f8f9fa;padding:8px 12px;font-weight:700}
    .marker-pin-dell{width:30px;height:30px;background:#1a73e8;border-radius:50% 50% 50% 0;transform:rotate(-45deg);border:2px solid white;display:flex;align-items:center;justify-content:center}
  </style>
</head>
<body>
  <div class="app-container">
    <div class="header-container">
      <div style="display:flex;align-items:center;gap:12px">
        <div style="font-size:1.4rem;color:#1a73e8"><i class="fas fa-shield-alt"></i></div>
        <div class="logo-text">OS <span style="color:var(--dell-blue)">INFOHUB</span></div>
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <div class="clock-date" id="clock-date">Loading...</div>
        <button class="btn btn-sm btn-primary" onclick="manualRefresh()">Refresh</button>
      </div>
    </div>

    <div class="content-area" style="padding:18px">
      <div class="row g-4">
        <div class="col-lg-9">
          <div class="map-wrapper"><div id="map"></div></div>

          <h6 style="margin-left:18px;font-weight:700">Live Intelligence</h6>
          <div id="general-news-feed" style="padding:18px"></div>
        </div>

        <div class="col-lg-3">
          <div class="side-card mb-3" style="padding:14px;border-radius:10px;background:#fff">
            <div style="font-weight:700;margin-bottom:8px"><i class="fas fa-plane"></i> Travel Safety</div>
            <select id="countrySelect" class="form-select" onchange="filterTravel()"><option>Loading...</option></select>
            <div id="travel-advisories"></div>
            <div id="travel-news"></div>
          </div>

          <div class="side-card mb-3" style="padding:14px;border-radius:10px;background:#fff">
            <div style="font-weight:700;margin-bottom:8px"><i class="fas fa-building"></i> Proximity Alerts</div>
            <select id="proxRadius" class="form-select form-select-sm mb-2" onchange="updateProximityRadius()">
              <option value="5">5 KM</option><option value="10">10 KM</option><option value="25">25 KM</option>
              <option value="50" selected>50 KM</option><option value="100">100 KM</option><option value="500">500 KM</option>
            </select>
            <div id="proximity-alerts-container">Scanning assets...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ================= CONFIG ================= */
const WORKER_URL = "https://osinfohub.vssmaximus.workers.dev"; // update if different
const AUTO_REFRESH_MS = 60000;
let INCIDENTS = [], TRAVEL_DATA = [], currentRadius = 50;
let map, layerGroup, incidentLayerGroup;

/* =============== FULL ASSETS (keys must match worker DELL_SITES.key) ===============
   I included the full Dell site list below (keys exactly the same as worker).
   This is the important part: keys must match worker's nearest_site_key.
   ============================================================================= */
const ASSETS = {
  "round rock": { lat: 30.5083, lng: -97.6788, region: "AMER" },
  "austin": { lat: 30.3952, lng: -97.6843, region: "AMER" },
  "hopkinton": { lat: 42.2287, lng: -71.5226, region: "AMER" },
  "franklin": { lat: 42.0834, lng: -71.3967, region: "AMER" },
  "apex": { lat: 35.7327, lng: -78.8503, region: "AMER" },
  "eden prairie": { lat: 44.8617, lng: -93.4168, region: "AMER" },
  "draper": { lat: 40.5240, lng: -111.8950, region: "AMER" },
  "nashville": { lat: 36.1627, lng: -86.7816, region: "AMER" },
  "oklahoma city": { lat: 35.4676, lng: -97.5164, region: "AMER" },
  "santa clara": { lat: 37.3541, lng: -121.9552, region: "AMER" },
  "mclean": { lat: 38.9295, lng: -77.2268, region: "AMER" },
  "el paso": { lat: 31.8385, lng: -106.5278, region: "AMER" },
  "toronto": { lat: 43.6532, lng: -79.3832, region: "AMER" },
  "mexico city": { lat: 19.4326, lng: -99.1332, region: "LATAM" },
  "hortolandia": { lat: -22.8583, lng: -47.2208, region: "LATAM" },
  "sao paulo": { lat: -23.5505, lng: -46.6333, region: "LATAM" },
  "porto alegre": { lat: -30.0346, lng: -51.2177, region: "LATAM" },
  "panama city": { lat: 8.9824, lng: -79.5199, region: "LATAM" },
  "lodz": { lat: 51.7285, lng: 19.4967, region: "EMEA" },
  "limerick": { lat: 52.6638, lng: -8.6267, region: "EMEA" },
  "dublin": { lat: 53.2374, lng: -6.1450, region: "EMEA" },
  "cork": { lat: 51.8985, lng: -8.4756, region: "EMEA" },
  "herzliya": { lat: 32.1644, lng: 34.7961, region: "EMEA" },
  "haifa": { lat: 32.7940, lng: 34.9896, region: "EMEA" },
  "bracknell": { lat: 51.4160, lng: -0.7540, region: "EMEA" },
  "glasgow": { lat: 55.8642, lng: -4.2518, region: "EMEA" },
  "montpellier": { lat: 43.6108, lng: 3.8767, region: "EMEA" },
  "paris": { lat: 48.8566, lng: 2.3522, region: "EMEA" },
  "frankfurt": { lat: 50.1109, lng: 8.6821, region: "EMEA" },
  "halle": { lat: 51.4820, lng: 11.9700, region: "EMEA" },
  "amsterdam": { lat: 52.3676, lng: 4.9041, region: "EMEA" },
  "casablanca": { lat: 33.5731, lng: -7.5898, region: "EMEA" },
  "cairo": { lat: 30.0444, lng: 31.2357, region: "EMEA" },
  "dubai": { lat: 25.2048, lng: 55.2708, region: "EMEA" },
  "bangalore": { lat: 12.9716, lng: 77.5946, region: "APJC" },
  "hyderabad": { lat: 17.3850, lng: 78.4867, region: "APJC" },
  "gurugram": { lat: 28.4595, lng: 77.0266, region: "APJC" },
  "sriperumbudur": { lat: 12.9560, lng: 79.9410, region: "APJC" },
  "singapore": { lat: 1.3521, lng: 103.8198, region: "APJC" },
  "penang": { lat: 5.4164, lng: 100.3327, region: "APJC" },
  "cyberjaya": { lat: 2.9213, lng: 101.6559, region: "APJC" },
  "xiamen": { lat: 24.4798, lng: 118.0894, region: "APJC" },
  "chengdu": { lat: 30.5728, lng: 104.0668, region: "APJC" },
  "shanghai": { lat: 31.2304, lng: 121.4737, region: "APJC" },
  "taipei": { lat: 25.0330, lng: 121.5654, region: "APJC" },
  "tokyo": { lat: 35.6762, lng: 139.6503, region: "APJC" },
  "kawasaki": { lat: 35.5300, lng: 139.6960, region: "APJC" },
  "sydney": { lat: -33.8688, lng: 151.2093, region: "APJC" },
  "melbourne": { lat: -37.8136, lng: 144.9631, region: "APJC" }
};

/* Worker keys -> display names */
const WORKER_SITE_ALIAS = {
  "round rock":"Dell Round Rock HQ","austin":"Dell Austin Parmer","hopkinton":"Dell Hopkinton","franklin":"Dell Franklin",
  "apex":"Dell Apex","eden prairie":"Dell Eden Prairie","draper":"Dell Draper","nashville":"Dell Nashville Hub",
  "oklahoma city":"Dell Oklahoma City","santa clara":"Dell Santa Clara","mclean":"Dell McLean","el paso":"Dell El Paso",
  "toronto":"Dell Toronto","mexico city":"Dell Mexico City","hortolandia":"Dell Hortolândia Mfg","sao paulo":"Dell São Paulo",
  "porto alegre":"Dell Porto Alegre","panama city":"Dell Panama City","lodz":"Dell Lodz Mfg","limerick":"Dell Limerick",
  "dublin":"Dell Dublin Cherrywood","cork":"Dell Cork Campus","herzliya":"Dell Herzliya","haifa":"Dell Haifa",
  "bracknell":"Dell Bracknell","glasgow":"Dell Glasgow","montpellier":"Dell Montpellier","paris":"Dell Paris / Bezons",
  "frankfurt":"Dell Frankfurt","halle":"Dell Halle","amsterdam":"Dell Amsterdam","casablanca":"Dell Casablanca",
  "cairo":"Dell Cairo","dubai":"Dell Dubai","bangalore":"Dell Bangalore","hyderabad":"Dell Hyderabad",
  "gurugram":"Dell Gurugram","sriperumbudur":"Dell Sriperumbudur Mfg","singapore":"Dell Singapore","penang":"Dell Penang",
  "cyberjaya":"Dell Cyberjaya","xiamen":"Dell Xiamen Mfg","chengdu":"Dell Chengdu Mfg","shanghai":"Dell Shanghai",
  "taipei":"Dell Taipei","tokyo":"Dell Tokyo","kawasaki":"Dell Kawasaki","sydney":"Dell Sydney","melbourne":"Dell Melbourne"
};

/* ========== HELPERS ========== */
function escapeHtml(s){return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;")}
function haversineKm(lat1,lon1,lat2,lon2){const R=6371,toRad=x=>x*Math.PI/180;const dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));}

/* ========== BOOT ========== */
document.addEventListener("DOMContentLoaded",async()=>{
  initMap(); startClock(); await loadFromWorker(); await loadTravelAdvisories(); filterNews('Global');
  setInterval(async()=>{ await loadFromWorker(true); filterNews(document.querySelector('.nav-item-custom.active')?.innerText||'Global'); }, AUTO_REFRESH_MS);
});

function startClock(){const tick=()=>{const now=new Date();document.getElementById('clock-time').innerText=now.toLocaleTimeString();document.getElementById('clock-date').innerText=now.toLocaleDateString()};tick();setInterval(tick,1000)}

/* ========= MAP ========= */
function initMap(){
  map=L.map('map',{zoomControl:false}).setView([20,0],2);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{maxZoom:19}).addTo(map);
  layerGroup=L.layerGroup().addTo(map); incidentLayerGroup=L.layerGroup().addTo(map);
  renderAssetsOnMap('Global');
}
function renderAssetsOnMap(region){
  layerGroup.clearLayers();
  const iconFactory = (name)=> L.divIcon({className:'custom-pin',html:`<div class="marker-pin-dell"><i class="fas fa-building"></i></div>`,iconSize:[30,42],iconAnchor:[15,42]});
  for(const [key,a] of Object.entries(ASSETS)){
    if(region!=='Global' && a.region!==region) continue;
    const m = L.marker([a.lat,a.lng],{icon:iconFactory(key)}).addTo(layerGroup);
    const label = (WORKER_SITE_ALIAS[key]||key).toUpperCase();
    m.bindTooltip(`<b>${label}</b>`,{permanent:false,direction:'top',className:'map-tooltip'});
  }
}

/* ========= WORKER FETCH ========= */
async function loadFromWorker(silent=false){
  const status=document.getElementById('feed-count'); if(!silent) status.innerText='REFRESHING...';
  try{
    const res=await fetch(`${WORKER_URL}/api/incidents`,{cache:'no-store'}); if(!res.ok) throw new Error('worker fail');
    const raw=await res.json(); const arr=Array.isArray(raw)?raw:[]; INCIDENTS=arr.map(normaliseWorkerIncident).filter(Boolean);
    INCIDENTS.sort((a,b)=> (getSevDetails(b.severity_text).val-getSevDetails(a.severity_text).val) || (new Date(b.time)-new Date(a.time)));
    status.innerText=`${INCIDENTS.length} ITEMS`;
  }catch(e){ if(!silent) document.getElementById('feed-count').innerText='OFFLINE'; console.error(e) }
}

function normaliseWorkerIncident(item){
  if(!item||!item.title) return null;
  let sevText = item.severity_text ? String(item.severity_text).toUpperCase() : (item.severity ? (Number(item.severity)>=1? (Number(item.severity)>=4?'CRITICAL':Number(item.severity)===3?'HIGH':Number(item.severity)===2?'MODERATE':'LOW') : 'LOW') : 'LOW');
  if(!['CRITICAL','HIGH','MODERATE','LOW'].includes(sevText)) sevText='LOW';
  return {
    id: item.id || (item.title + '|' + (item.link||'')),
    title: item.title,
    summary: item.summary||'',
    category: (item.category||'UNKNOWN').toUpperCase(),
    severity: Number(item.severity||1),
    severity_text: sevText,
    region: (item.region && item.region!=='GLOBAL')?item.region:'Global',
    country: item.country||'GLOBAL',
    location: item.location||'UNKNOWN',
    link: item.link||'#',
    time: item.time||new Date().toISOString(),
    lat: Number(item.lat||0),
    lng: Number(item.lng||0),
    nearest_site_name: item.nearest_site_name||item.nearest_site||'',
    nearest_site_key: item.nearest_site_key||'',
    distance_km: Number(item.distance_km||item.distance||NaN),
    source: item.source||''
  };
}

/* ===== TRAVEL ===== */
async function loadTravelAdvisories(attempt=1){
  const sel=document.getElementById('countrySelect'); if(!sel) return; sel.innerHTML='<option disabled>Loading...</option>';
  try{
    const res=await fetch(`${WORKER_URL}/api/traveladvisories`,{cache:'no-store'}); if(!res.ok) throw new Error('travel fail');
    const json=await res.json(); TRAVEL_DATA=json.advisories||[]; populateCountries();
  }catch(e){ if(attempt<4) setTimeout(()=>loadTravelAdvisories(attempt+1),1200); else document.getElementById('countrySelect').innerHTML='<option disabled>Unavailable</option>' }
}
function populateCountries(){ const sel=document.getElementById('countrySelect'); sel.innerHTML='<option selected disabled>Select Country...</option>'; TRAVEL_DATA.sort((a,b)=>a.country.localeCompare(b.country)).forEach(c=>{const opt=document.createElement('option');opt.value=c.country;opt.text=c.country;sel.appendChild(opt)})}

/* ========== RENDER FEED ========== */
function filterNews(region,el){
  document.querySelectorAll('.nav-item-custom').forEach(n=>n.classList.remove('active')); if(el) el.classList.add('active');
  renderAssetsOnMap(region); renderIncidentsOnMap(region); renderGeneralFeed(region); renderProximityAlerts(region); updateHeadline(region);
}
function renderIncidentsOnMap(region){
  incidentLayerGroup.clearLayers();
  const filtered = region==='Global'?INCIDENTS:INCIDENTS.filter(i=>i.region===region);
  filtered.forEach(i=>{ if(!i.lat||!i.lng) return; const sev=getSevDetails(i.severity_text); const circle=L.circleMarker([i.lat,i.lng],{radius:8,fillColor:sev.color,color:'#fff',weight:2,fillOpacity:0.85}).addTo(incidentLayerGroup); circle.bindPopup(`<b>${escapeHtml(i.title)}</b><br/><small>${escapeHtml(i.country)} • ${escapeHtml(i.location)}</small>`); });
}
function renderGeneralFeed(region){
  const container=document.getElementById('general-news-feed'); const data=(region==='Global')?INCIDENTS:INCIDENTS.filter(i=>i.region===region);
  if(!data||data.length===0){ container.innerHTML=`<div style="padding:30px;text-align:center;color:#999">No incidents</div>`; return; }
  let html='';
  data.forEach(i=>{ const sev=getSevDetails(i.severity_text); html+=`<a class="feed-card" href="${escapeHtml(i.link)}" target="_blank"><div style="display:flex"><div class="feed-status-bar" style="background:${sev.color}"></div><div class="feed-content"><div style="display:flex;align-items:center;margin-bottom:8px"><span class="ftag" style="background:${sev.color};color:#fff">${escapeHtml(i.severity_text)}</span><span class="ftag ftag-loc">${escapeHtml((i.country||'GLOBAL').toUpperCase())}</span><span style="margin-left:auto;font-weight:700">${escapeHtml(i.category)}</span></div><div style="font-weight:700">${escapeHtml(i.title)}</div><div style="margin-top:8px;color:#666;font-size:0.9rem">${escapeHtml(i.summary||'')}</div></div></div></a>` });
  container.innerHTML=html;
}
function updateHeadline(region){
  // optional; not required for proximity fix
}

/* ======= PROXIMITY (FIXED) ======= */
function updateProximityRadius(){ const sel=document.getElementById('proxRadius'); currentRadius = Number(sel.value||50); renderProximityAlerts(document.querySelector('.nav-item-custom.active')?.innerText || 'Global'); }

function renderProximityAlerts(region){
  const container = document.getElementById('proximity-alerts-container'); container.innerHTML = '';
  const incidents = region==='Global' ? INCIDENTS : INCIDENTS.filter(i=>i.region===region);
  const alerts = [];

  for(const inc of incidents){
    if(!inc) continue;

    // 1) Preferred: worker-provided canonical key (nearest_site_key)
    const workerKeyRaw = (inc.nearest_site_key || '').toString().trim().toLowerCase();
    const workerDist = Number(inc.distance_km || inc.distance || NaN);

    if(workerKeyRaw && WORKER_SITE_ALIAS[workerKeyRaw] && Number.isFinite(workerDist) && workerDist <= currentRadius){
      alerts.push({ inc, assetKey: workerKeyRaw, assetName: WORKER_SITE_ALIAS[workerKeyRaw], dist: workerDist });
      continue;
    }

    // 2) If worker didn't provide a usable key, fall back to compute nearest asset from coordinates
    if(!inc.lat || !inc.lng) continue;
    let bestDist = Infinity, bestKey = null;
    for(const [key,s] of Object.entries(ASSETS)){
      const d = haversineKm(inc.lat, inc.lng, s.lat, s.lng);
      if(d < bestDist){ bestDist = d; bestKey = key; }
    }
    if(bestKey && bestDist <= currentRadius){
      alerts.push({ inc, assetKey: bestKey, assetName: WORKER_SITE_ALIAS[bestKey] || bestKey, dist: bestDist });
    }
  }

  // sort by distance then severity
  alerts.sort((a,b)=> (a.dist - b.dist) || (getSevDetails(b.inc.severity_text).val - getSevDetails(a.inc.severity_text).val));

  if(alerts.length===0){ container.innerHTML = `<div style="padding:12px;color:#999;text-align:center">No incidents within ${currentRadius} KM.</div>`; return; }

  let html='';
  for(const a of alerts.slice(0,25)){
    const sev = getSevDetails(a.inc.severity_text);
    html += `<div class="alert-row">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800;color:${sev.color}">${escapeHtml(a.inc.severity_text)} THREAT</div>
        <div style="font-weight:800;color:${sev.color}">${Math.round(a.dist)} KM</div>
      </div>
      <div style="margin-top:8px;font-weight:700">${escapeHtml(a.inc.title)}</div>
      <div style="margin-top:6px;color:#64748b;font-size:0.9rem">Near <b>${escapeHtml((a.assetName||a.assetKey).toUpperCase())}</b></div>
    </div>`;
  }
  container.innerHTML = html;
}

/* ====== TRAVEL FILTER UI ====== */
function filterTravel(){
  const country = document.getElementById('countrySelect').value;
  const adv = TRAVEL_DATA.find(x=>x.country===country);
  const advBox = document.getElementById('travel-advisories');
  const newsBox = document.getElementById('travel-news');
  if(!advBox) return;
  if(!adv){ advBox.innerHTML = `<div style="padding:12px;color:#999">No advisory</div>`; newsBox.innerHTML=''; return;}
  let color='#1a73e8',lvl='LEVEL 1';
  if(adv.level>=4){color='#d93025';lvl='LEVEL 4'} else if(adv.level>=3){color='#e37400';lvl='LEVEL 3'} else if(adv.level>=2){color='#f9ab00';lvl='LEVEL 2'}
  advBox.innerHTML = `<div class="advisory-box" style="border-left:4px solid ${color}"><div style="font-weight:700;color:${color}">${lvl}</div><div style="margin-top:6px">${escapeHtml(adv.text)}</div></div>`;
  const related = INCIDENTS.filter(i=>String(i.country).toUpperCase()===String(country).toUpperCase()).slice(0,3);
  if(related.length){
    let nh=`<div class="news-box-alert"><div class="news-box-header">RECENT INCIDENTS</div>`;
    related.forEach(r=> nh+=`<div class="news-box-item"><div class="news-box-title">${escapeHtml(r.title)}</div></div>`);
    nh+=`</div>`; newsBox.innerHTML = nh;
  } else newsBox.innerHTML = `<div style="padding:12px;color:#137333"><i class="fas fa-check-circle"></i> No recent incidents.</div>`;
}

/* ========= util severity ========= */
function getSevDetails(level){
  const map={CRITICAL:{val:4,color:'#ef4444'},HIGH:{val:3,color:'#f97316'},MODERATE:{val:2,color:'#eab308'},LOW:{val:1,color:'#1a73e8'}};
  return map[level]||{val:0,color:'#64748b'};
}

/* ========== manual and misc ========== */
function manualRefresh(){ loadFromWorker(); filterNews(document.querySelector('.nav-item-custom.active')?.innerText||'Global'); }
function loadHistory(d){ alert('History demo: ' + d); }
function downloadReport(){ alert('Report generation not implemented in this demo'); }

/* ========= load travel wrapper ========= */
async function loadTravelAdvisories(){ await loadTravelAdvisoriesImpl(); }
async function loadTravelAdvisoriesImpl(attempt=1){
  try{
    const res=await fetch(`${WORKER_URL}/api/traveladvisories`,{cache:'no-store'}); if(!res.ok) throw new Error('fail');
    const json=await res.json(); TRAVEL_DATA=json.advisories||[]; populateCountries();
  }catch(e){ if(attempt<4) setTimeout(()=>loadTravelAdvisoriesImpl(attempt+1),1200); else document.getElementById('countrySelect').innerHTML='<option disabled>Unavailable</option>'}
}
</script>
</body>
</html>
