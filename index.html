<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dell OS | INFOHUB</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

  <style>
    /* (trimmed - keep your production styles here) */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    body { font-family: Inter, sans-serif; margin:24px; background:#0f1115; color:#333; }
    .app-container { background:#fff; border-radius:16px; padding:0; min-height:92vh; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.5); }
    .header-container { padding:15px 32px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #eee; height:90px; }
    .map-wrapper { height:520px; border-radius:12px; overflow:hidden; background:#eef2f6; }
    #map { width:100%; height:100%; }
    .side-card { padding:20px; background:#fff; border-radius:12px; border:1px solid #e6e6e6; }
    .btn-daily { background:#1a73e8;color:#fff;padding:9px 18px;border-radius:8px;font-weight:700; }
    .assets-debug { position: absolute; top:110px; right:18px; z-index:999999; background:#fff; padding:8px 10px; border:1px solid #ddd; border-radius:6px; font-size:13px; display:none; }
    .custom-toast { position:relative; background:rgba(0,0,0,0.85); color:#fff; padding:10px 14px; border-radius:8px; margin-bottom:8px; font-weight:700; }
  </style>
</head>
<body>
  <div class="app-container" id="main-content" role="main">
    <div class="header-container">
      <div style="display:flex;align-items:center;gap:12px;">
        <div style="font-size:1.4rem;color:#1a73e8;"><i class="fas fa-shield-alt"></i></div>
        <div style="font-weight:800;font-size:1.15rem;">OS <span style="color:#0076CE">INFOHUB</span></div>
      </div>
      <div style="display:flex;align-items:center;gap:12px;">
        <div id="btn-refresh" class="btn-daily" data-action="refresh" role="button" tabindex="0"><i class="fas fa-rotate"></i>&nbsp;Refresh</div>
        <div class="btn-daily" data-bs-toggle="modal" data-bs-target="#reportModal" style="background:#202124;">Daily Briefings</div>
        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#adminModal"><i class="fas fa-cog"></i></button>
      </div>
    </div>

    <div class="content-area" style="padding:30px;">
      <div class="row g-4">
        <div class="col-lg-9">
          <div class="map-wrapper" aria-label="Incident Map">
            <div id="map"></div>
          </div>

          <div style="margin-top:18px;">
            <div style="display:flex;align-items:center;gap:10px;">
              <span style="display:inline-block;width:8px;height:8px;background:#1a73e8;border-radius:50%;"></span>
              <strong>Real-time Intelligence Stream</strong>
              <span id="feed-status-label" style="margin-left:8px;background:#e8f0fe;color:#1a73e8;padding:2px 6px;border-radius:4px;font-weight:700;">Connecting‚Ä¶</span>
            </div>

            <div class="critical-alert-bar" style="margin-top:12px;background:#fce8e6;padding:12px;border-left:4px solid #d93025;border-radius:6px;">
              <div id="headline-alert">Loading headline‚Ä¶</div>
              <div id="headline-tags" style="margin-top:6px;"></div>
            </div>

            <div id="general-news-feed" aria-live="polite"><div style="padding:30px;text-align:center;color:#999;">Connecting‚Ä¶</div></div>
          </div>
        </div>

        <div class="col-lg-3">
          <div class="side-card">
            <div style="font-weight:700;margin-bottom:8px;"><i class="fas fa-history"></i> History Search</div>
            <input type="date" id="history-picker" class="form-control" aria-label="History Date" />
            <div id="history-status" style="margin-top:8px;color:#9aa0a6;font-weight:600;">Pick a date to load archived intelligence.</div>

            <div style="margin-top:12px;">
              <button id="btn-return-live" class="btn-daily w-100" data-action="return-live"><i class="fas fa-bolt"></i> Return to Live</button>
            </div>
          </div>

          <div class="side-card" style="margin-top:16px;">
            <div style="font-weight:700;margin-bottom:8px;"><i class="fas fa-plane"></i> Travel Safety Check</div>
            <select id="countrySelect" class="form-select"><option>Loading countries‚Ä¶</option></select>
            <div id="travel-advisories" style="margin-top:12px;"></div>
            <div id="travel-news" style="margin-top:8px;"></div>
          </div>

          <div class="side-card" style="margin-top:16px;">
            <div style="font-weight:700;margin-bottom:8px;">Dell Asset<br/><strong>Proximity Alerts</strong></div>
            <div id="proximity-alerts-container" style="min-height:120px;color:#999;">No threats within 50km.</div>
            <div style="margin-top:8px;text-align:center;"><a href="#" data-action="refresh">REFRESH ALERTS</a></div>
            <div style="margin-top:8px;"><select id="proxRadius" class="form-select"><option value="5">5 KM</option><option value="10">10 KM</option><option value="25">25 KM</option><option value="50" selected>50 KM</option><option value="100">100 KM</option></select></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Reports Modal -->
  <div class="modal fade" id="reportModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Daily Intelligence Briefings</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <label>Report Date</label>
    <input type="date" id="reportDate" class="form-control" />
    <label style="margin-top:12px;">Region</label>
    <select id="reportRegion" class="form-select"><option>Global</option><option>APJC</option><option>AMER</option><option>EMEA</option><option>LATAM</option></select>
    <div style="margin-top:12px;"><button class="btn-daily w-100" data-action="preview-brief">Preview Briefing</button></div>
    <div style="margin-top:8px;"><button class="btn-daily w-100" data-action="download-brief">Download Briefing</button></div>
    <div id="preview-feedback" style="margin-top:8px;display:none;"></div>
    <div id="briefing-preview" style="max-height:48vh;overflow:auto;margin-top:8px;"></div>
  </div></div></div></div>

  <!-- Admin Modal -->
  <div class="modal fade" id="adminModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Admin Controls</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <label>Admin Secret (Session)</label>
    <input type="password" id="adminSecret" class="form-control" />
    <div style="margin-top:8px;" class="form-check"><input id="adminRememberSession" type="checkbox" class="form-check-input" /><label class="form-check-label">Remember for session</label></div>
    <div style="margin-top:12px;display:flex;gap:8px;"><button class="btn btn-primary btn-sm" data-action="admin-save-secret">Save (Session)</button><button class="btn btn-outline-danger btn-sm" data-action="admin-clear-secret">Clear</button></div>
    <hr/>
    <div style="display:grid;gap:8px;">
      <button class="btn btn-warning btn-sm" data-action="admin-trigger-ingest">Trigger Ingestion</button>
      <button class="btn btn-outline-dark btn-sm" data-action="admin-list-briefs">List Stored Briefs (Console)</button>
      <button class="btn btn-outline-secondary btn-sm" data-action="admin-thumbs-status">Thumbs Status (Console)</button>
      <button class="btn btn-secondary btn-sm" data-action="admin-unlock">Force Unlock (Ingest/Travel)</button>
    </div>
    <div id="admin-feedback" style="display:none;margin-top:12px;"></div>
  </div></div></div></div>

  <div id="assets-debug" class="assets-debug" aria-live="polite" style="display:none"></div>

  <!-- Toast Container -->
  <div id="toast-container" style="position:fixed;right:18px;bottom:18px;z-index:10600;"></div>

  <script>
  // Prevent double initialization if the page accidentally includes the script twice
  if (window.__osinfohub_initialized) {
    console.warn('OS INFOHUB already initialized ‚Äî skipping duplicate init.');
  } else {
    window.__osinfohub_initialized = true;

    /* =========================
       CONFIG & STATE
    ========================= */
    const WORKER_URL = "https://osinfohub.vssmaximus.workers.dev";
    const AUTO_REFRESH_MS = 60_000;
    const DEBUG_UI = (new URLSearchParams(location.search).get('debug') === '1') || (localStorage.getItem('osinfohub_debug') === '1');

    const WORLD_COUNTRIES = [
      "Afghanistan","Albania","Algeria","Andorra","Angola","Antigua and Barbuda","Argentina","Armenia","Australia","Austria","Azerbaijan",
      "Bahamas","Bahrain","Bangladesh","Barbados","Belarus","Belgium","Belize","Benin","Bhutan","Bolivia","Bosnia and Herzegovina","Botswana","Brazil","Brunei","Bulgaria","Burkina Faso","Burundi",
      "Cabo Verde","Cambodia","Cameroon","Canada","Central African Republic","Chad","Chile","China","Colombia","Comoros","Congo","Costa Rica","Croatia","Cuba","Cyprus","Czechia",
      "Denmark","Djibouti","Dominica","Dominican Republic",
      "Ecuador","Egypt","El Salvador","Equatorial Guinea","Eritrea","Estonia","Eswatini","Ethiopia",
      "Fiji","Finland","France",
      "Gabon","Gambia","Georgia","Germany","Ghana","Greece","Grenada","Guatemala","Guinea","Guinea-Bissau","Guyana",
      "Haiti","Honduras","Hungary",
      "Iceland","India","Indonesia","Iran","Iraq","Ireland","Israel","Italy",
      "Jamaica","Japan","Jordan",
      "Kazakhstan","Kenya","Kiribati","Kuwait","Kyrgyzstan",
      "Laos","Latvia","Lebanon","Lesotho","Liberia","Libya","Liechtenstein","Lithuania","Luxembourg",
      "Madagascar","Malawi","Malaysia","Maldives","Mali","Malta","Marshall Islands","Mauritania","Mauritius","Mexico","Micronesia","Moldova","Monaco","Mongolia","Montenegro","Morocco","Mozambique","Myanmar",
      "Namibia","Nauru","Nepal","Netherlands","New Zealand","Nicaragua","Niger","Nigeria","North Macedonia","Norway",
      "Oman",
      "Pakistan","Palau","Palestine","Panama","Papua New Guinea","Paraguay","Peru","Philippines","Poland","Portugal",
      "Qatar",
      "Romania","Russia","Rwanda",
      "Saint Kitts and Nevis","Saint Lucia","Saint Vincent and the Grenadines","Samoa","San Marino","Sao Tome and Principe","Saudi Arabia","Senegal","Serbia","Seychelles","Sierra Leone","Singapore","Slovakia","Slovenia","Solomon Islands","Somalia","South Africa","South Korea","South Sudan","Spain","Sri Lanka","Sudan","Suriname","Sweden","Switzerland","Syria",
      "Taiwan","Tajikistan","Tanzania","Thailand","Timor-Leste","Togo","Tonga","Trinidad and Tobago","Tunisia","Turkey","Turkmenistan","Tuvalu",
      "Uganda","Ukraine","United Arab Emirates","United Kingdom","United States","Uruguay","Uzbekistan",
      "Vanuatu","Vatican City","Venezuela","Vietnam",
      "Yemen",
      "Zambia","Zimbabwe"
    ];

    let INCIDENTS = [];
    let PROXIMITY_INCIDENTS = [];
    let PROXIMITY_IDS = new Set();
    let FEED_IS_LIVE = false;
    let currentRadius = 50;
    let DISMISSED_ALERT_IDS = new Set();

    try {
      const raw = sessionStorage.getItem('dismissed_prox_alert_ids');
      if (raw) {
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)) arr.forEach(v => DISMISSED_ALERT_IDS.add(String(v)));
      }
    } catch(e){}

    let TRAVEL_DATA = [];
    let TRAVEL_UPDATED_AT = null;

    let map, assetsClusterGroup, incidentClusterGroup, criticalLayerGroup;

    let ADMIN_SECRET = '';
    let VOTES_LOCAL = {};
    let VOTE_QUEUE = [];

    try {
      const rawVotes = localStorage.getItem('os_v1_votes');
      if (rawVotes) VOTES_LOCAL = JSON.parse(rawVotes) || {};
      const rawQueue = localStorage.getItem('os_v1_vote_queue');
      if (rawQueue) VOTE_QUEUE = JSON.parse(rawQueue) || [];
      const ssec = sessionStorage.getItem('admin_secret');
      if (ssec) ADMIN_SECRET = ssec;
    } catch(e){}

    window.onerror = function(msg, url, line, col, error) {
      console.error("Global Error Caught:", { msg, url, line, col, error });
    };
    window.addEventListener('unhandledrejection', (ev) => { console.error('Unhandled promise rejection:', ev.reason); });

    const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints && navigator.maxTouchPoints > 0);
    let _clusterHoverTimeout = null;

    /* ================ DELL SITES & ASSETS ================ */
    const DELL_SITES = [
      { name: "Dell Round Rock HQ", country: "US", region: "AMER", lat: 30.5083, lon: -97.6788 },
      { name: "Dell Austin Parmer", country: "US", region: "AMER", lat: 30.3952, lon: -97.6843 },
      { name: "Dell Hopkinton", country: "US", region: "AMER", lat: 42.2287, lon: -71.5226 },
      { name: "Dell Franklin", country: "US", region: "AMER", lat: 42.0834, lon: -71.3967 },
      { name: "Dell Apex", country: "US", region: "AMER", lat: 35.7327, lon: -78.8503 },
      { name: "Dell Eden Prairie", country: "US", region: "AMER", lat: 44.8617, lon: -93.4168 },
      { name: "Dell Draper", country: "US", region: "AMER", lat: 40.5240, lon: -111.8950 },
      { name: "Dell Nashville Hub", country: "US", region: "AMER", lat: 36.1627, lon: -86.7816 },
      { name: "Dell Oklahoma City", country: "US", region: "AMER", lat: 35.4676, lon: -97.5164 },
      { name: "Dell Santa Clara", country: "US", region: "AMER", lat: 37.3541, lon: -121.9552 },
      { name: "Dell McLean", country: "US", region: "AMER", lat: 38.9295, lon: -77.2268 },
      { name: "Dell El Paso", country: "US", region: "AMER", lat: 31.8385, lon: -106.5278 },
      { name: "Dell Toronto", country: "CA", region: "AMER", lat: 43.6532, lon: -79.3832 },
      { name: "Dell Mexico City", country: "MX", region: "AMER", lat: 19.4326, lon: -99.1332 },
      { name: "Dell Hortol√¢ndia Mfg", country: "BR", region: "LATAM", lat: -22.8583, lon: -47.2208 },
      { name: "Dell S√£o Paulo", country: "BR", region: "LATAM", lat: -23.5505, lon: -46.6333 },
      { name: "Dell Porto Alegre", country: "BR", region: "LATAM", lat: -30.0346, lon: -51.2177 },
      { name: "Dell Panama City", country: "PA", region: "LATAM", lat: 8.9824, lon: -79.5199 },
      { name: "Dell Lodz Mfg", country: "PL", region: "EMEA", lat: 51.7285, lon: 19.4967 },
      { name: "Dell Limerick", country: "IE", region: "EMEA", lat: 52.6638, lon: -8.6267 },
      { name: "Dell Dublin Cherrywood", country: "IE", region: "EMEA", lat: 53.2374, lon: -6.1450 },
      { name: "Dell Cork Campus", country: "IE", region: "EMEA", lat: 51.8985, lon: -8.4756 },
      { name: "Dell Herzliya", country: "IL", region: "EMEA", lat: 32.1644, lon: 34.7961 },
      { name: "Dell Haifa", country: "IL", region: "EMEA", lat: 32.7940, lon: 34.9896 },
      { name: "Dell Beer Sheva", country: "IL", region: "EMEA", lat: 31.2626, lon: 34.8016 },
      { name: "Dell Bracknell", country: "GB", region: "EMEA", lat: 51.4160, lon: -0.7540 },
      { name: "Dell Glasgow", country: "GB", region: "EMEA", lat: 55.8642, lon: -4.2518 },
      { name: "Dell Montpellier", country: "FR", region: "EMEA", lat: 43.6108, lon: 3.8767 },
      { name: "Dell Paris / Bezons", country: "FR", region: "EMEA", lat: 48.8566, lon: 2.3522 },
      { name: "Dell Frankfurt", country: "DE", region: "EMEA", lat: 50.1109, lon: 8.6821 },
      { name: "Dell Halle", country: "DE", region: "EMEA", lat: 51.4820, lon: 11.9700 },
      { name: "Dell Amsterdam", country: "NL", region: "EMEA", lat: 52.3676, lon: 4.9041 },
      { name: "Dell Casablanca", country: "MA", region: "EMEA", lat: 33.5731, lon: -7.5898 },
      { name: "Dell Cairo", country: "EG", region: "EMEA", lat: 30.0444, lon: 31.2357 },
      { name: "Dell Dubai", country: "AE", region: "EMEA", lat: 25.2048, lon: 55.2708 },
      { name: "Dell Bangalore", country: "IN", region: "APJC", lat: 12.9716, lon: 77.5946 },
      { name: "Dell Hyderabad", country: "IN", region: "APJC", lat: 17.3850, lon: 78.4867 },
      { name: "Dell Gurugram", country: "IN", region: "APJC", lat: 28.4595, lon: 77.0266 },
      { name: "Dell Sriperumbudur Mfg", country: "IN", region: "APJC", lat: 12.9560, lon: 79.9410 },
      { name: "Dell Singapore", country: "SG", region: "APJC", lat: 1.3521, lon: 103.8198 },
      { name: "Dell Penang", country: "MY", region: "APJC", lat: 5.4164, lon: 100.3327 },
      { name: "Dell Cyberjaya", country: "MY", region: "APJC", lat: 2.9213, lon: 101.6559 },
      { name: "Dell Xiamen Mfg", country: "CN", region: "APJC", lat: 24.4798, lon: 118.0894 },
      { name: "Dell Chengdu Mfg", country: "CN", region: "APJC", lat: 30.5728, lon: 104.0668 },
      { name: "Dell Shanghai", country: "CN", region: "APJC", lat: 31.2304, lon: 121.4737 },
      { name: "Dell Taipei", country: "TW", region: "APJC", lat: 25.0330, lon: 121.5654 },
      { name: "Dell Tokyo", country: "JP", region: "APJC", lat: 35.6762, lon: 139.6503 },
      { name: "Dell Kawasaki", country: "JP", region: "APJC", lat: 35.5300, lon: 139.6960 },
      { name: "Dell Sydney", country: "AU", region: "APJC", lat: -33.8688, lon: 151.2093 },
      { name: "Dell Melbourne", country: "AU", region: "APJC", lat: -37.8136, lon: 144.9631 }
    ];
    const ASSETS = {};
    DELL_SITES.forEach(s => { ASSETS[s.name.toLowerCase()] = { name: s.name, lat: Number(s.lat), lng: Number(s.lon), region: s.region, country: s.country }; });

    /* =========================
       UTILITIES
    ========================= */
    function escapeHtml(s){ return String(s||'').replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }
    function escapeAttr(s){ return String(s||'').replace(/"/g,"&quot;").replace(/`/g,"&#096;"); }
    function safeHref(u){ try { const s=String(u||'').trim(); if(!s) return "#"; if(/^(mailto:|tel:)/i.test(s)) return s; const url = new URL(s, location.href); if(!["http:","https:"].includes(url.protocol)) return "#"; return url.href;}catch{return "#";}}
    function safeTime(t){ try{ const d=new Date(t); if(isNaN(d.getTime())) return "Recently"; return d.toLocaleString(); }catch{return "Recently"; } }
    function parseCoord(v){ const n=(v===null||v===undefined)?NaN:parseFloat(String(v).trim()); return Number.isFinite(n)?n:NaN; }

    /* =========================
       SMALL HELPERS: toasts
    ========================= */
    function showToast(msg, isError=false, timeout=3500){
      try {
        const container = document.getElementById('toast-container'); if(!container) return;
        const t = document.createElement('div'); t.className = 'custom-toast' + (isError ? ' error' : '');
        t.textContent = msg;
        container.appendChild(t);
        setTimeout(()=> { t.style.opacity = 1; }, 20);
        setTimeout(()=> {
          t.style.opacity = 0;
          setTimeout(()=> t.remove(), 300);
        }, timeout);
      } catch(e) {}
    }

    /* =========================
       Fetch helper
    ========================= */
    async function fetchWithTimeout(url, opts={}, timeout=15000){
      const controller = new AbortController(); const id = setTimeout(()=>controller.abort(), timeout);
      try { const res = await fetch(url, { ...opts, signal: controller.signal }); return res; } finally { clearTimeout(id); }
    }

    /* =========================
       NORMALISATION & MAP HELPERS
    ========================= */
    function generateId(item){ if(!item) return ''; if(item.id) return String(item.id); const t=String(item.time||item.ts||item.timestamp||''); const title=String(item.title||item.link||''); return `${title}|${t}`; }

    function normaliseWorkerIncident(item) {
      try {
        if (!item || !item.title) return null;
        const title = String(item.title || '').trim();
        if (!title) return null;
        let lat = parseCoord(item.lat);
        let lng = parseCoord(item.lng !== undefined ? item.lng : item.lon);
        if (!Number.isFinite(lat) || !Number.isFinite(lng) || (Math.abs(lat) < 0.0001 && Math.abs(lng) < 0.0001)) {
          const locRaw = String(item.location || item.city || item.country || '').toLowerCase();
          if (locRaw) {
            const key = locRaw.split(',')[0].trim();
            if (key && key.length >= 2 && (typeof CITY_COORDS !== 'undefined') && CITY_COORDS[key]) {
              lat = CITY_COORDS[key].lat; lng = CITY_COORDS[key].lng;
            } else if (key && (typeof COUNTRY_COORDS !== 'undefined') && COUNTRY_COORDS[key]) {
              lat = COUNTRY_COORDS[key].lat; lng = COUNTRY_COORDS[key].lng;
            } else {
              for (const s of DELL_SITES) {
                const sname = s.name.toLowerCase();
                if (sname.includes(key) || key.includes(sname)) { lat = Number(s.lat); lng = Number(s.lon); break; }
              }
            }
          }
          if ((!Number.isFinite(lat) || !Number.isFinite(lng)) && item.country) {
            const cc = String(item.country || '').toLowerCase().split(',')[0].trim();
            if (typeof COUNTRY_COORDS !== 'undefined' && COUNTRY_COORDS[cc]) { lat = COUNTRY_COORDS[cc].lat; lng = COUNTRY_COORDS[cc].lng; }
          }
        }
        if (!Number.isFinite(lat)) lat = 0;
        if (!Number.isFinite(lng)) lng = 0;
        const severity = Number(item.severity || item.level || 1) || 1;
        let regionCanonical = normalizeRegion(item.region || '');
        if ((!regionCanonical || regionCanonical === 'Global') && item.country) {
          const inferred = getRegionByCountry(item.country);
          if (inferred) regionCanonical = inferred;
        }
        if ((!regionCanonical || regionCanonical === 'Global') && (Number.isFinite(lat) && Number.isFinite(lng))) {
          if (lng >= 60 && lng <= 160) regionCanonical = 'APJC';
        }
        if (!regionCanonical || regionCanonical === '') regionCanonical = 'Global';
        return {
          id: generateId(item),
          title,
          summary: item.summary || item.description || '',
          link: item.link || item.url || '#',
          time: item.time || item.ts || new Date().toISOString(),
          severity,
          severity_label: item.severity_label || (severity >= 5 ? 'CRITICAL' : (severity >= 4 ? 'HIGH' : (severity === 3 ? 'MEDIUM' : 'LOW'))),
          region: regionCanonical,
          country: String(item.country || 'GLOBAL'),
          location: item.location || item.city || '',
          lat: lat,
          lng: lng,
          source: item.source || item.source_name || '',
          distance_km: (item.distance_km != null) ? Number(item.distance_km) : null,
          nearest_site_name: item.nearest_site_name || null,
          country_wide: !!item.country_wide,
          category: String(item.category || item.type || '').toUpperCase()
        };
      } catch(e) { console.error('normaliseWorkerIncident error', e, item); return null; }
    }

    /* =========================
       REGION helpers
    ========================= */
    const COUNTRY_TO_REGION = (function(){
      const m = {};
      ['us','united states','usa','canada','mx','mexico'].forEach(k => m[k] = 'AMER');
      ['br','brazil','ar','argentina','cl','chile','co','colombia','pe','peru'].forEach(k => m[k] = 'LATAM');
      ['uk','gb','united kingdom','france','de','germany','it','italy','es','spain','nl','netherlands','be','belgium','ie','ireland'].forEach(k => m[k] = 'EMEA');
      ['cn','china','jp','japan','kr','korea','in','india','sg','singapore','au','australia','nz','new zealand','my','malaysia','id','indonesia','ph','philippines','th','thailand','vn','vietnam'].forEach(k => m[k] = 'APJC');
      return m;
    })();

    function normalizeRegion(raw){
      if (!raw) return 'Global';
      const s = String(raw).trim().toUpperCase();
      if (['GLOBAL','WORLD'].includes(s)) return 'Global';
      if (s.includes('AMER') || s.includes('NORTH AMERICA') || s.includes('UNITED STATES') || s.includes('CANADA')) return 'AMER';
      if (s.includes('LATAM') || s.includes('LATIN')) return 'LATAM';
      if (s.includes('EMEA') || s.includes('EUROPE') || s.includes('AFRICA') || s.includes('MIDDLE EAST')) return 'EMEA';
      if (s.includes('APJC') || s.includes('APAC') || s.includes('ASIA') || s.includes('PACIFIC')) return 'APJC';
      return s;
    }

    function getRegionByCountry(c) {
      if (!c) return null;
      const lower = String(c).toLowerCase().trim();
      if (!lower) return null;
      if (COUNTRY_TO_REGION[lower]) return COUNTRY_TO_REGION[lower];
      const two = lower.length === 2 ? lower : lower.slice(0,2);
      if (COUNTRY_TO_REGION[two]) return COUNTRY_TO_REGION[two];
      for (const k of Object.keys(COUNTRY_TO_REGION)) { if (lower.includes(k)) return COUNTRY_TO_REGION[k]; }
      const cut = lower.split(',')[0].trim();
      if (typeof COUNTRY_COORDS !== 'undefined' && COUNTRY_COORDS[cut]) {
        if (['china','japan','india','australia','singapore','south korea','new zealand','indonesia','philippines','thailand','vietnam','malaysia'].includes(cut)) return 'APJC';
        if (['brazil','argentina','colombia','peru','chile'].includes(cut)) return 'LATAM';
        if (['united states','canada','mexico'].includes(cut)) return 'AMER';
        return 'EMEA';
      }
      return null;
    }

    /* =========================
       LOAD & FILTER
    ========================= */
    async function loadFromWorker(force=false) {
      const lbl = document.getElementById('feed-status-label');
      if (lbl && !force) lbl.textContent = 'Refreshing‚Ä¶';
      try {
        // Use the canonical incidents endpoint (server may support /api/incidents or /api/incidents/live)
        const res = await fetchWithTimeout(`${WORKER_URL}/api/incidents`, {}, 12000);
        if (!res || !res.ok) {
          // try the /live alias as fallback (some deployments use that)
          const alt = await fetchWithTimeout(`${WORKER_URL}/api/incidents/live`, {}, 12000).catch(()=>null);
          if (alt && alt.ok) {
            const json = await alt.json().catch(()=>null) || {};
            applyIncidents(json);
          } else {
            FEED_IS_LIVE = false;
            if (lbl) lbl.textContent = 'Offline';
            showToast('No live incidents returned from server (check server).', true);
          }
          return;
        }
        const raw = await res.json().catch(()=>null) || {};
        applyIncidents(raw);
      } catch (e) {
        console.error('loadFromWorker error', e);
        FEED_IS_LIVE = false;
        const lbl = document.getElementById('feed-status-label');
        if (lbl) lbl.textContent = 'Offline';
        showToast('Unable to fetch live incidents (network).', true);
      }
    }

    function applyIncidents(raw) {
      try {
        const arr = Array.isArray(raw) ? raw : (Array.isArray(raw.incidents) ? raw.incidents : []);
        const cutoff = Date.now() - (48 * 3600 * 1000);
        INCIDENTS = arr.map(normaliseWorkerIncident).filter(Boolean).filter(i => {
          try { const t = new Date(i.time).getTime(); return Number.isFinite(t) ? t >= cutoff : false; } catch { return false; }
        }).sort((a,b)=> new Date(b.time) - new Date(a.time));
        FEED_IS_LIVE = true;
        const lbl = document.getElementById('feed-status-label');
        if (lbl) lbl.textContent = `Live ‚Ä¢ ${INCIDENTS.length} items`;
        // re-render current view
        const active = document.querySelector('.nav-item-custom.active');
        filterNews(active ? active.textContent.trim() : 'Global');
      } catch(e) { console.error('applyIncidents error', e); }
    }

    async function loadProximityFromWorker(force=false) {
      try {
        const res = await fetchWithTimeout(`${WORKER_URL}/api/proximity`, {}, 12000);
        if (!res || !res.ok) {
          PROXIMITY_INCIDENTS = [];
          PROXIMITY_IDS = new Set();
          return;
        }
        const json = await res.json().catch(()=>null) || {};
        const list = Array.isArray(json) ? json : (Array.isArray(json.incidents) ? json.incidents : []);
        const cutoff = Date.now() - (48 * 3600 * 1000);
        PROXIMITY_INCIDENTS = list.map(normaliseWorkerIncident).filter(Boolean).filter(i => {
          try { const t = new Date(i.time).getTime(); return Number.isFinite(t) ? t >= cutoff : false; } catch { return false; }
        });
        PROXIMITY_IDS = new Set(PROXIMITY_INCIDENTS.map(i=>String(i.id)));
      } catch(e) {
        console.error('loadProximityFromWorker error', e);
        PROXIMITY_INCIDENTS = [];
        PROXIMITY_IDS = new Set();
      }
    }

    async function loadHistory(dateIso) {
      // Pause live feed to avoid auto-overwrite
      FEED_IS_LIVE = false;
      const feedLabel = document.getElementById('feed-status-label');
      if (feedLabel) feedLabel.textContent = 'History (paused)';
      const statusEl = document.getElementById('history-status');
      if (statusEl) statusEl.textContent = 'Loading history‚Ä¶';
      try {
        if (!dateIso) { if (statusEl) statusEl.textContent = 'No date provided.'; showToast('No date provided', true); return; }
        const res = await fetchWithTimeout(`${WORKER_URL}/api/incidents/history?date=${encodeURIComponent(dateIso)}`, {}, 15000);
        if (!res || !res.ok) { if (statusEl) statusEl.textContent = `History unavailable for ${dateIso}.`; showToast(`History unavailable for ${dateIso}`, true); return; }
        const data = await res.json().catch(()=>null) || {};
        const arr = Array.isArray(data) ? data : (Array.isArray(data.incidents) ? data.incidents : []);
        INCIDENTS = arr.map(normaliseWorkerIncident).filter(Boolean).sort((a,b)=> new Date(b.time) - new Date(a.time));
        filterNews('Global');
        if (statusEl) statusEl.textContent = `Loaded history for ${dateIso}.`;
        showToast(`History loaded for ${dateIso}`);
      } catch(e) {
        console.error('loadHistory error', e);
        if (statusEl) statusEl.textContent = 'History load failed.';
        showToast('History load failed', true);
      }
    }

    /* =========================
       MAP INIT & RENDERERS
    ========================= */
    function getClusterStats(cluster) {
      const children = cluster.getAllChildMarkers ? cluster.getAllChildMarkers() : [];
      let counts = { critical:0, high:0, medium:0, low:0 };
      let maxSeverity = 0;
      children.forEach(m => {
        const s = Number(m.options.severity || 1);
        if (s >= 5) { counts.critical++; maxSeverity = Math.max(maxSeverity,5); }
        else if (s >= 4) { counts.high++; maxSeverity = Math.max(maxSeverity,4); }
        else if (s === 3) { counts.medium++; maxSeverity = Math.max(maxSeverity,3); }
        else counts.low++;
      });
      return { counts, maxSeverity, childrenCount: children.length };
    }

    function initMap() {
      if (typeof L === 'undefined') { console.warn('Leaflet not present'); return; }
      // bounds
      const southWest = L.latLng(-85,-179.999);
      const northEast = L.latLng(85,179.999);
      const bounds = L.latLngBounds(southWest,northEast);
      map = L.map('map', { scrollWheelZoom:false, zoomControl:false, minZoom:2, maxZoom:19, maxBounds:bounds, maxBoundsViscosity:1.0, worldCopyJump:false }).setView([20,0],2);
      L.control.zoom({ position:'topleft' }).addTo(map);
      const esriLayer = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}", { maxZoom:19, attribution:'Tiles ¬© Esri ‚Äî Esri, USGS, NOAA', keepBuffer:2 });
      esriLayer.addTo(map);

      assetsClusterGroup = L.layerGroup(); map.addLayer(assetsClusterGroup);
      incidentClusterGroup = L.markerClusterGroup({
        chunkedLoading:true, spiderfyOnMaxZoom:true, showCoverageOnHover:false, disableClusteringAtZoom:13,
        maxClusterRadius:50, zoomToBoundsOnClick: !isTouch,
        iconCreateFunction: function(cluster) {
          const {counts,maxSeverity,childrenCount} = getClusterStats(cluster);
          let cls='cluster-blue';
          if (counts.critical + counts.high > 0) cls = (counts.critical>0)?'cluster-red':'cluster-amber';
          if (maxSeverity >=4) cls = 'cluster-red';
          else if (maxSeverity === 3) cls = 'cluster-amber';
          const ariaLabel = escapeAttr(`Cluster of ${childrenCount} incidents. ${counts.critical} Critical, ${counts.high} High.`);
          const html = `<div class="cluster-icon ${cls}" tabindex="0" role="button" aria-label="${ariaLabel}" title="${ariaLabel}" style="width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;"><div class="cluster-count" aria-hidden="true">${childrenCount}</div></div>`;
          return L.divIcon({ html, className:'', iconSize:[40,40], iconAnchor:[20,20] });
        }
      });
      incidentClusterGroup.on('clustermouseover', (e) => {
        clearTimeout(_clusterHoverTimeout);
        _clusterHoverTimeout = setTimeout(()=> {
          const {counts,childrenCount} = getClusterStats(e.layer);
          const summary = `<b>Cluster: ${childrenCount} Incidents</b><br/>${counts.critical ? `<span style="color:#d93025">Critical: ${counts.critical}</span><br/>` : ''}${counts.high ? `<span style="color:#d93025">High: ${counts.high}</span><br/>` : ''}${counts.medium ? `<span style="color:#f9ab00">Medium: ${counts.medium}</span><br/>` : ''}${counts.low ? `<span style="color:#1a73e8">Low: ${counts.low}</span>` : ''}`;
          L.popup({ closeButton:false, offset:[0,-10], className:'map-tooltip' }).setLatLng(e.layer.getLatLng()).setContent(summary).openOn(map);
        }, 80);
      });
      incidentClusterGroup.on('clustermouseout', ()=> { clearTimeout(_clusterHoverTimeout); map.closePopup(); });
      map.addLayer(incidentClusterGroup);
      criticalLayerGroup = L.layerGroup(); map.addLayer(criticalLayerGroup);
    }

    function renderAssetsOnMap(region) {
      if (!assetsClusterGroup || !map) return;
      assetsClusterGroup.clearLayers();
      const assets = Object.values(ASSETS);
      const filtered = (region === "Global") ? assets : assets.filter(a => a.region === region);
      filtered.forEach(a => {
        try {
          const m = L.marker([Number(a.lat), Number(a.lng)], { icon: L.divIcon({ className:'custom-pin', html:'<div class="marker-pin-dell"><i class="fas fa-building"></i></div>', iconSize:[30,42], iconAnchor:[15,42] })});
          m.bindTooltip(escapeHtml(a.name), { className:'map-tooltip', direction:'top' });
          assetsClusterGroup.addLayer(m);
        } catch(e){}
      });
    }

    function renderIncidentsOnMap(region, list) {
      if (!incidentClusterGroup || !criticalLayerGroup || !map) return;
      incidentClusterGroup.clearLayers(); criticalLayerGroup.clearLayers();
      const data = (region === "Global") ? list : list.filter(i=>i.region===region);
      const proxIds = new Set(PROXIMITY_INCIDENTS.map(i => String(i.id)));
      data.forEach(i => {
        try {
          const sev = Number(i.severity || 1);
          const isProx = proxIds.has(String(i.id));
          if (sev < 4 && !isProx) return;
          let lat = Number(i.lat), lng = Number(i.lng);
          if (!Number.isFinite(lat) || !Number.isFinite(lng) || Math.abs(lat)<0.0001 || Math.abs(lng)<0.0001) {
            const c = getCoordsForIncident(i); if (!c) return; lat = c.lat; lng = c.lng;
          }
          const color = (sev >=5) ? '#d93025' : (sev >=4 ? '#d93025' : (sev===3 ? '#f9ab00' : '#1a73e8'));
          const marker = L.marker([lat,lng], { severity:sev, icon: L.divIcon({ html:`<div class="incident-dot" style="background:${color}"></div>`, className:'', iconSize:[12,12], iconAnchor:[8,8] }) })
            .bindPopup(`<b>${escapeHtml(i.title)}</b><br>${escapeHtml(safeTime(i.time))}<br/><a href="${escapeAttr(safeHref(i.link))}" target="_blank" rel="noopener noreferrer">Source</a>`);
          if (sev >=4) criticalLayerGroup.addLayer(marker); else incidentClusterGroup.addLayer(marker);
        } catch(e){}
      });
      try { criticalLayerGroup.bringToFront(); } catch(e){}
      try { assetsClusterGroup.bringToBack(); } catch(e){}
    }

    function renderGeneralFeed(region) {
      const container = document.getElementById('general-news-feed'); if(!container) return;
      const data = (region === "Global") ? INCIDENTS : INCIDENTS.filter(i=>i.region===region);
      if (!data || !data.length) { container.innerHTML = '<div style="padding:30px;text-align:center;color:#999;">No incidents for this region.</div>'; return; }
      let html='';
      data.forEach(i => {
        const sevMeta = mapSeverityToLabel(i.severity);
        const id = generateId(i);
        const localVote = VOTES_LOCAL[id] || null;
        html += `<div class="feed-card" role="article" data-link="${escapeAttr(safeHref(i.link))}" tabindex="0"><div style="width:5px;display:inline-block;vertical-align:top;background:${sevMeta.barClass==='status-bar-crit'?'#d93025':(sevMeta.barClass==='status-bar-warn'?'#f9ab00':'#1a73e8')};height:100%;margin-right:8px;"></div><div style="display:inline-block;width:calc(100% - 20px);"><div style="font-weight:700;">${escapeHtml(i.title)}</div><div style="font-size:0.85rem;color:#5f6368;">${escapeHtml(safeTime(i.time))} ‚Ä¢ ${escapeHtml((i.country||'GLOBAL').toUpperCase())}</div><div style="margin-top:6px;">${escapeHtml(i.summary||'')}</div><div style="text-align:right;margin-top:8px;"><button class="btn-vote ${localVote==='up'?'voted-up':''}" data-action="vote" data-vote="up" data-id="${escapeAttr(id)}">üëç</button><button class="btn-vote ${localVote==='down'?'voted-down':''}" data-action="vote" data-vote="down" data-id="${escapeAttr(id)}">üëé</button></div></div></div>`;
      });
      container.innerHTML = html;
    }

    function mapSeverityToLabel(s) {
      const n = Number(s || 1);
      if (n >= 5) return {label:'CRITICAL', badgeClass:'ftag-crit', barClass:'status-bar-crit'};
      if (n >= 4) return {label:'HIGH', badgeClass:'ftag-crit', barClass:'status-bar-crit'};
      if (n === 3) return {label:'MEDIUM', badgeClass:'ftag-warn', barClass:'status-bar-warn'};
      return {label:'LOW', badgeClass:'ftag-info', barClass:'status-bar-info'};
    }

    function updateProximityRadius() { const el = document.getElementById('proxRadius'); if (el) currentRadius = parseFloat(el.value)||50; const active = document.querySelector('.nav-item-custom.active'); const region = active ? active.textContent.trim() : 'Global'; renderProximityAlerts(region); renderIncidentsOnMap(region, INCIDENTS); }

    function renderProximityAlerts(region) {
      const container = document.getElementById('proximity-alerts-container'); if (!container) return;
      const data = (region === 'Global') ? PROXIMITY_INCIDENTS : PROXIMITY_INCIDENTS.filter(i=>i.region===region);
      const alerts = [];
      data.forEach(inc => {
        try {
          const coords = (Number.isFinite(Number(inc.lat)) && Number.isFinite(Number(inc.lng))) ? {lat:Number(inc.lat),lng:Number(inc.lng)} : getCoordsForIncident(inc);
          if (!coords) return;
          const key = generateId(inc);
          if (DISMISSED_ALERT_IDS.has(String(key))) return;
          let nearest = null;
          if ((inc.distance_km != null) && inc.nearest_site_name) nearest = {dist:Number(inc.distance_km),name:inc.nearest_site_name};
          else {
            for (const asset of Object.values(ASSETS)) {
              const d = haversineKm(coords.lat, coords.lng, asset.lat, asset.lng);
              if (!nearest || d < nearest.dist) nearest = {dist:d, name:asset.name};
            }
          }
          if (!nearest) return;
          if (inc.country_wide || nearest.dist <= currentRadius) alerts.push({inc, nearest, key});
        } catch(e){}
      });
      alerts.sort((a,b)=>a.nearest.dist - b.nearest.dist);
      if (!alerts.length) { container.innerHTML = `<div style="padding:15px;text-align:center;color:#999;">No threats within ${currentRadius}km.</div>`; return; }
      container.innerHTML = alerts.slice(0,25).map(a => {
        const i = a.inc; const sev = Number(i.severity || 1);
        const color = sev >= 4 ? '#d93025' : (sev === 3 ? '#f9ab00' : '#1a73e8');
        const distStr = i.country_wide ? 'Country-wide' : `${Math.round(a.nearest.dist)}km`;
        return `<div class="alert-row" style="padding:12px 0;border-bottom:1px solid #eee;"><div style="display:flex;justify-content:space-between;"><div style="font-weight:700;"><i class="fas fa-exclamation-circle" style="color:${color}"></i>&nbsp;${escapeHtml(i.title)}</div><div style="color:${color};font-weight:700">${escapeHtml(distStr)}</div></div><div style="margin-top:6px;color:#666">Near: <b>${escapeHtml(a.nearest.name)}</b></div><div style="margin-top:8px;color:#444">${escapeHtml(i.summary)}</div><div style="margin-top:8px;"><button class="btn-dismiss" data-action="dismiss-alert" data-id="${escapeAttr(a.key)}">Dismiss</button></div></div>`;
      }).join('');
    }

    /* =========================
       Travel
    ========================= */
    async function loadTravelAdvisories() {
      const sel = document.getElementById('countrySelect');
      if (!sel) return;
      sel.innerHTML = `<option selected disabled>Loading advisories...</option>`;
      try {
        const res = await fetchWithTimeout(`${WORKER_URL}/api/traveladvisories/live`, {}, 12000);
        if (res && res.ok) {
          const data = await res.json();
          TRAVEL_DATA = Array.isArray(data) ? data : [];
          TRAVEL_UPDATED_AT = (data && data.updated_at) ? data.updated_at : new Date().toISOString();
        }
      } catch(e) { console.warn('worker traveladvisories/live failed', e); }
      // Use original capitalization for the option value (server normalisation may accept either, but keep original names)
      sel.innerHTML = `<option selected disabled>Select Country...</option>` + WORLD_COUNTRIES.map(c => `<option value="${escapeAttr(c)}">${escapeHtml(c)}</option>`).join('');
    }

    function getTravelNewsForCountry(country, limit=5) {
      if (!country) return [];
      const c = String(country || '').toLowerCase();
      const matches = INCIDENTS.filter(i => {
        const incCountry = (i.country || '').toLowerCase();
        const loc = (i.location || '').toLowerCase();
        return incCountry.includes(c) || loc.includes(c) || (i.title||'').toLowerCase().includes(c);
      }).slice(0,limit);
      return matches.map(i => ({ title: i.title, summary: i.summary }));
    }

    async function filterTravel() {
      const country = document.getElementById('countrySelect')?.value || '';
      const cont = document.getElementById('travel-advisories');
      const newsCont = document.getElementById('travel-news');
      if (cont) cont.innerHTML = "Loading‚Ä¶";
      if (newsCont) newsCont.innerHTML = "";
      try {
        const res = await fetchWithTimeout(`${WORKER_URL}/api/traveladvisories?country=${encodeURIComponent(country)}`, {}, 12000);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        const adv = data.advisory || data || {};
        const level = Number(adv.level || adv.risk_level || 1);
        const badgeColor = (level >= 4) ? '#d93025' : (level === 3 ? '#f9ab00' : '#1a73e8');
        if (cont) cont.innerHTML = `<div class="advisory-box"><div class="advisory-header"><div class="advisory-label">OFFICIAL ADVISORY</div><div class="advisory-level-badge" style="background:${badgeColor};">LEVEL ${escapeHtml(String(level))}</div></div><div class="advisory-text">${escapeHtml(adv.text || adv.advice || adv.summary || 'No major advisory.')}</div><div class="advisory-updated">Updated: ${escapeHtml(adv.updated || TRAVEL_UPDATED_AT || 'Unknown')}</div></div>`;
        const news = Array.isArray(data.news) ? data.news : (Array.isArray(data.recent_incidents) ? data.recent_incidents : []);
        if (news && news.length) {
          newsCont.innerHTML = `<div class="news-box-alert"><div class="news-box-header">RELATED NEWS</div>${news.slice(0,5).map(n => `<div class="news-box-item"><div class="news-box-title">${escapeHtml(n.title || '')}</div><div class="news-box-summary">${escapeHtml(n.summary || '')}</div></div>`).join('')}</div>`;
        } else {
          const fallback = getTravelNewsForCountry(country, 5);
          if (fallback && fallback.length) newsCont.innerHTML = `<div class="news-box-alert"><div class="news-box-header">RELATED NEWS</div>${fallback.slice(0,5).map(n => `<div class="news-box-item"><div class="news-box-title">${escapeHtml(n.title)}</div><div class="news-box-summary">${escapeHtml(n.summary || '')}</div></div>`).join('')}</div>`;
        }
      } catch(e) {
        if (cont) cont.innerHTML = `<div class="safe-box"><i class="fas fa-info-circle safe-icon"></i><div class="safe-text">Advisory unavailable.</div></div>`;
        console.error('filterTravel error', e);
      }
    }

    /* =========================
       COORD HELPERS
    ========================= */
    function getCoordsForIncident(i) {
      try {
        if (!i) return null;
        const lat = parseCoord(i.lat);
        const lng = parseCoord(i.lng !== undefined ? i.lng : i.lon);
        if (Number.isFinite(lat) && Number.isFinite(lng) && Math.abs(lat) > 0.0001 && Math.abs(lng) > 0.0001) return {lat,lng};
        const locRaw = String(i.location || i.city || '').trim().toLowerCase();
        if (locRaw && locRaw !== 'unknown') {
          const locKey = locRaw.split(',')[0].trim();
          if (locKey.length >= 3) {
            if (typeof CITY_COORDS !== 'undefined' && CITY_COORDS[locKey]) return {lat:CITY_COORDS[locKey].lat, lng:CITY_COORDS[locKey].lng};
            for (const k of Object.keys(CITY_COORDS || {})) {
              if (k.length < 3) continue;
              if (locKey.includes(k) || k.includes(locKey)) return {lat:CITY_COORDS[k].lat, lng:CITY_COORDS[k].lng};
            }
            for (const s of DELL_SITES) {
              const sname = s.name.toLowerCase();
              if (sname.includes(locKey) || locKey.includes(sname)) return {lat:s.lat, lng:s.lon};
            }
          }
        }
        const countryRaw = String(i.country || '').trim().toLowerCase();
        if (countryRaw) {
          const cut = countryRaw.split(',')[0].trim();
          for (const [k,v] of Object.entries(COUNTRY_COORDS || {})) {
            if (k === cut || k === countryRaw) return {lat:v.lat, lng:v.lng};
          }
          const cc = countryRaw.slice(0,2).toLowerCase();
          for (const s of DELL_SITES) {
            const sCode = String(s.country || '').toLowerCase();
            if (sCode === countryRaw || (sCode === cc && countryRaw.length >= 2)) return {lat:s.lat, lng:s.lon};
          }
        }
        return null;
      } catch(e) { return null; }
    }

    function haversineKm(lat1,lon1,lat2,lon2) {
      const R = 6371; const dLat = (lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180;
      const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    /* =========================
       VOTING & ADMIN
    ========================= */
    async function sendVoteToServer(payload) {
      if (!payload || !payload.id) return { ok:false, err:'invalid' };
      // try public
      try {
        const r = await fetch(`${WORKER_URL}/api/thumb/public`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id: payload.id, vote: payload.vote, ts: payload.ts || new Date().toISOString() }) });
        if (r.ok) return { ok:true, via:'public' };
        if (r.status !== 403 && !adminGetSecret()) return { ok:false, status:r.status, text: await r.text().catch(()=>'') };
      } catch(e) { console.warn('Public vote failed', e); }
      const sec = adminGetSecret();
      if (!sec) return { ok:false, err:'no_admin_secret' };
      try {
        const r2 = await fetch(`${WORKER_URL}/api/thumb`, { method:'POST', headers:{ 'Content-Type':'application/json', 'secret': sec }, body: JSON.stringify({ id: payload.id, action: payload.vote, ts: payload.ts || new Date().toISOString() }) });
        const txt = await r2.text().catch(()=>'');
        if (r2.ok) return { ok:true, via:'admin' };
        return { ok:false, status:r2.status, text:txt };
      } catch(e) { return { ok:false, err: e.message || String(e) }; }
    }

    async function enqueueVote(payload) { try { VOTE_QUEUE.push(payload); persistVoteQueue(); } catch(e){} }
    async function flushVoteQueue() {
      if (!VOTE_QUEUE || !VOTE_QUEUE.length) return;
      const q = VOTE_QUEUE.slice();
      for (const p of q) {
        try {
          const r = await sendVoteToServer(p);
          if (r && r.ok) {
            const idx = VOTE_QUEUE.findIndex(x => x.id===p.id && x.ts===p.ts && x.vote===p.vote);
            if (idx >=0) VOTE_QUEUE.splice(idx,1);
            persistVoteQueue();
          } else console.warn('Queued vote not accepted yet', p, r);
        } catch(e) { console.warn('flushVoteQueue error', e); }
      }
    }

    function persistVotes(){ try{ localStorage.setItem('os_v1_votes', JSON.stringify(VOTES_LOCAL)); }catch(e){} }
    function persistVoteQueue(){ try{ localStorage.setItem('os_v1_vote_queue', JSON.stringify(VOTE_QUEUE)); }catch(e){} }

    function applyVoteUIForId(id,vote){ try{ document.querySelectorAll(`.btn-vote[data-id="${escapeAttr(id)}"]`).forEach(btn=>{ btn.classList.remove('voted-up','voted-down'); btn.disabled=false; }); if(!vote) return; document.querySelectorAll(`.btn-vote[data-id="${escapeAttr(id)}"][data-vote="${vote}"]`).forEach(b=>{ if(vote==='up') b.classList.add('voted-up'); if(vote==='down') b.classList.add('voted-down'); }); }catch(e){} }
    function markVoteAcceptedLocally(id,vote){ try{ if(!id) return; VOTES_LOCAL[id]=vote; persistVotes(); applyVoteUIForId(id,vote); }catch(e){} }
    async function voteThumb(id,vote){ if(!id||!vote) return; markVoteAcceptedLocally(id,vote); const payload={ id:String(id), vote:vote, ts: new Date().toISOString() }; try{ const res = await sendVoteToServer(payload); if(res && res.ok) { try{ flushVoteQueue(); }catch(e){} return; } await enqueueVote(payload); adminSetFeedback('Vote queued (will retry).', false); } catch(e) { await enqueueVote(payload); adminSetFeedback('Vote queued (network).', false); } }

    setInterval(()=>{ try{ flushVoteQueue() }catch(e){} }, 30_000);

    function adminGetSecret(){ try{ const s = (sessionStorage.getItem('admin_secret') || ''); return ADMIN_SECRET || s || ''; }catch(e){ return ADMIN_SECRET || ''; } }
    function adminSetFeedback(msg,isError=false){ const fb = document.getElementById('admin-feedback'); if(!fb) return; fb.style.display='block'; fb.className = isError ? 'alert alert-danger mt-3' : 'alert alert-success mt-3'; fb.textContent = String(msg || ''); }

    function adminSaveSecret(){ try{ const el = document.getElementById('adminSecret'); const remember = document.getElementById('adminRememberSession'); const val = el ? String(el.value || '').trim() : ''; if(remember && remember.checked){ try{ sessionStorage.setItem('admin_secret', val); }catch(e){} } else { try{ sessionStorage.removeItem('admin_secret'); }catch(e){} } ADMIN_SECRET = val; adminSetFeedback('Admin secret saved (session).', false); }catch(e){ adminSetFeedback('Save failed', true); } }
    function adminClearSecret(){ try{ sessionStorage.removeItem('admin_secret'); }catch(e){} ADMIN_SECRET=''; const fld = document.getElementById('adminSecret'); if(fld) fld.value=''; adminSetFeedback('Secret cleared.', false); }

    async function adminTriggerIngest(){ const sec = adminGetSecret(); if(!sec) { adminSetFeedback('Set Admin Secret first.', true); return; } adminSetFeedback('Triggering ingestion‚Ä¶'); try{ const res = await fetch(`${WORKER_URL}/api/ingest`, {method:'POST', headers:{ 'secret': sec }}); const txt = await res.text().catch(()=>''); if(!res.ok) { adminSetFeedback(`Ingest failed (HTTP ${res.status}). ${txt}`, true); return; } adminSetFeedback(txt || 'Ingestion triggered.'); }catch(e){ adminSetFeedback('Ingest failed (network).', true); } }

    async function adminUnlock(){ const sec = adminGetSecret(); if(!sec) { adminSetFeedback('Set Admin Secret first.', true); return; } adminSetFeedback('Requesting unlock of ingestion/travel locks‚Ä¶'); try{ const res = await fetch(`${WORKER_URL}/api/unlock`, { method:'POST', headers:{ 'secret': sec }}); const txt = await res.text().catch(()=>''); if(!res.ok){ // fallback attempt
          // try /api/thumb/unblock fallback
          try {
            const res2 = await fetch(`${WORKER_URL}/api/thumb/unblock`, { method:'POST', headers:{ 'Content-Type':'application/json', 'secret': sec }, body: JSON.stringify({}) });
            const txt2 = await res2.text().catch(()=>'');
            if (res2.ok) { adminSetFeedback(txt2 || 'Unlock successful (thumb/unblock).'); return; }
            adminSetFeedback(`Unlock failed (HTTP ${res.status}). ${txt}`, true);
            return;
          } catch(e2) {
            adminSetFeedback(`Unlock failed (HTTP ${res.status}). ${txt}`, true);
            console.warn('adminUnlock fallback failed', e2);
            return;
          }
        } adminSetFeedback(txt || 'Unlock successful.'); } catch(e){ adminSetFeedback('Unlock failed (network).', true); console.error('adminUnlock error', e); } }

    async function adminUnblockItem(id){ const sec = adminGetSecret(); if(!sec) { adminSetFeedback('Set Admin Secret first.', true); return; } if(!id){ adminSetFeedback('Missing id to unblock.', true); return; } adminSetFeedback('Unblocking item...'); try{ const res = await fetch(`${WORKER_URL}/api/thumb/unblock`, { method:'POST', headers:{ 'Content-Type':'application/json','secret':sec }, body: JSON.stringify({ id: String(id) }) }); const txt = await res.text().catch(()=>''); if(!res.ok){ adminSetFeedback(`Unblock failed (HTTP ${res.status}). ${txt}`, true); return; } adminSetFeedback(txt || 'Item unblocked.'); } catch(e){ adminSetFeedback('Unblock failed (network).', true); console.error('adminUnblockItem error', e); } }

    async function adminThumbsStatus(){ const sec = adminGetSecret(); adminSetFeedback('Loading thumbs status‚Ä¶'); try{ const res = await fetch(`${WORKER_URL}/api/thumbs/status`, { method:'GET', headers: {...(sec ? {'secret':sec}:{}) } }); const data = await res.json().catch(()=>null); if(!res.ok){ adminSetFeedback(`Status failed (HTTP ${res.status}).`, true); console.log('thumbs status raw', data); return; } adminSetFeedback('Thumbs status loaded. Check console.'); console.log('Thumbs status:', data); }catch(e){ adminSetFeedback('Status failed (network).', true); console.error(e); } }

    async function adminListBriefs(){ const sec = adminGetSecret(); if(!sec) { adminSetFeedback('Set Admin Secret first.', true); return; } adminSetFeedback('Listing stored briefs‚Ä¶'); try{ const res = await fetch(`${WORKER_URL}/api/dailybrief/list`, { method:'GET', headers: { 'secret': sec } }); const data = await res.json().catch(()=>null); if(!res.ok) { adminSetFeedback(`List failed (HTTP ${res.status}).`, true); console.log('brief list raw', data); return; } adminSetFeedback('Brief list loaded. Check console.'); console.log('Stored briefs:', data); } catch(e){ adminSetFeedback('List failed (network).', true); console.error(e); } }

    /* =========================
       REPORTS / HISTORY helpers
    ========================= */
    async function previewBriefing() {
      try {
        const region = document.getElementById('reportRegion')?.value || 'Global';
        const date = document.getElementById('reportDate')?.value || '';
        const cont = document.getElementById('briefing-preview');
        const fb = document.getElementById('preview-feedback');
        if (fb) { fb.style.display='block'; fb.textContent='Generating preview‚Ä¶'; }
        if (!cont) return;
        let url = `${WORKER_URL}/api/dailybrief?region=${encodeURIComponent(region)}`;
        if (date) url += `&date=${encodeURIComponent(date)}`;
        const res = await fetchWithTimeout(url, {}, 20000);
        if (!res.ok) { if (fb) fb.textContent=`Error: HTTP ${res.status}`; return; }
        const data = await res.json().catch(()=>null) || {};
        const incidents = data.incidents || [];
        if (!incidents.length) cont.innerHTML = `<div class="safe-box"><i class="fas fa-check-circle safe-icon"></i><div class="safe-text">No incidents found for this period.</div></div>`;
        else cont.innerHTML = incidents.slice(0,50).map(i => `<div style="border-bottom:1px solid #eee;padding:8px 0;"><div style="font-weight:700">${escapeHtml(i.title)}</div><div style="font-size:0.85rem;color:#666">${escapeHtml(i.country||'')} ‚Ä¢ ${escapeHtml(safeTime(i.time))}</div><div style="margin-top:6px;">${escapeHtml(i.summary||'')}</div></div>`).join('');
        if (fb) fb.style.display='none';
      } catch(e) { console.error('previewBriefing error', e); const fb = document.getElementById('preview-feedback'); if (fb) fb.style.display='block'; }
    }
    async function downloadReport() {
      const region = document.getElementById('reportRegion')?.value || 'Global';
      const date = document.getElementById('reportDate')?.value || '';
      let url = `${WORKER_URL}/api/dailybrief?region=${encodeURIComponent(region)}&download=true`;
      if (date) url += `&date=${encodeURIComponent(date)}`;
      window.open(url, '_blank', 'noopener');
    }

    /* =========================
       Return to Live functionality
    ========================= */
    async function returnToLive() {
      try {
        const histPicker = document.getElementById('history-picker');
        if (histPicker) histPicker.value = '';
        const histStatus = document.getElementById('history-status');
        if (histStatus) histStatus.textContent = 'Returned to live feed.';
        FEED_IS_LIVE = true;
        const feedLabel = document.getElementById('feed-status-label'); if (feedLabel) feedLabel.textContent = 'Live';
        await Promise.allSettled([ loadFromWorker(true), loadProximityFromWorker(true), loadTravelAdvisories() ]);
        const active = document.querySelector('.nav-item-custom.active');
        filterNews(active ? active.textContent.trim() : 'Global');
        showToast('Returned to Live feed');
      } catch(e) { console.error('returnToLive error', e); showToast('Failed to return to live feed', true); }
    }

    /* =========================
       Manual Refresh
    ========================= */
    async function manualRefresh() {
      const btn = document.getElementById('btn-refresh'); const originalText = btn ? btn.innerHTML : 'Refresh';
      if (btn) { btn.style.opacity='0.7'; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...'; btn.style.pointerEvents='none'; }
      // Keep history state consistent
      const histPicker = document.getElementById('history-picker'); const prevHist = histPicker ? String(histPicker.value || '') : '';
      if (histPicker) histPicker.value = '';
      const histStatus = document.getElementById('history-status'); if (histStatus) histStatus.textContent = 'Pick a date to load archived intelligence.';
      try {
        await Promise.allSettled([ loadFromWorker(false), loadProximityFromWorker(false), loadTravelAdvisories() ]);
        const active = document.querySelector('.nav-item-custom.active'); const region = active ? active.textContent.trim() : 'Global';
        filterNews(region);
        if (prevHist) showToast('Returned to Live feed');
        else showToast('Live feed refreshed');
      } catch(e) { console.error('manualRefresh error', e); showToast('Refresh failed', true); } finally { if (btn) { btn.style.opacity='1'; btn.innerHTML = originalText; btn.style.pointerEvents='auto'; } }
    }

    /* =========================
       CLOCKS
    ========================= */
    function startClock() {
      const container = document.getElementById('multi-clock-container');
      if (!container) return;
      const zones = [{label:"Austin",z:"America/Chicago"},{label:"Ireland",z:"Europe/Dublin"},{label:"India",z:"Asia/Kolkata"},{label:"Singapore",z:"Asia/Singapore"},{label:"Tokyo",z:"Asia/Tokyo"},{label:"Sydney",z:"Australia/Sydney"}];
      if (!container.innerHTML) container.innerHTML = zones.map(z => `<div style="display:inline-block;margin-right:8px;text-align:center;"><div style="font-size:0.6rem;color:#888">${escapeHtml(z.label)}</div><div style="font-family:monospace" id="clk-${escapeAttr(z.label)}">--:--</div></div>`).join('');
      function update() {
        const now = new Date();
        zones.forEach(z => { const el = document.getElementById(`clk-${z.label}`); if (el) el.textContent = now.toLocaleTimeString("en-US", { timeZone: z.z, hour12:false, hour:'2-digit', minute:'2-digit' }); });
      }
      update(); setInterval(update,1000);
    }

    /* =========================
       Event binding & boot
    ========================= */
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // admin secret from session
        try { const s = sessionStorage.getItem('admin_secret') || ''; if (s) { ADMIN_SECRET = s; const fld = document.getElementById('adminSecret'); if (fld) { fld.value = s; document.getElementById('adminRememberSession').checked = true; } } } catch(e){}
        initMap(); startClock();

        // fill countries early (safe)
        const countrySel = document.getElementById('countrySelect');
        if (countrySel) countrySel.innerHTML = `<option selected disabled>Select Country...</option>` + WORLD_COUNTRIES.map(c => `<option value="${escapeAttr(c)}">${escapeHtml(c)}</option>`).join('');

        // Delegated click handler
        document.addEventListener('click', async (ev) => {
          const t = ev.target.closest('[data-action]');
          if (!t) return;
          if (t.tagName === 'A' && (t.getAttribute('href') === '#' || t.getAttribute('href') === '')) ev.preventDefault();
          const action = String(t.dataset.action || '').trim();
          if (!action) return;

          switch(action) {
            case 'filter-region':
              document.querySelectorAll('[data-action="filter-region"]').forEach(el => el.classList.remove('active'));
              t.classList.add('active');
              filterNews(t.dataset.region || t.textContent.trim());
              break;
            case 'refresh': manualRefresh(); break;
            case 'preview-brief': previewBriefing(); break;
            case 'download-brief': downloadReport(); break;
            case 'vote':
              ev.preventDefault(); ev.stopPropagation();
              const id = t.getAttribute('data-id'); const v = t.getAttribute('data-vote');
              await voteThumb(id, v);
              break;
            case 'dismiss-alert':
              ev.preventDefault(); ev.stopPropagation();
              const did = t.getAttribute('data-id'); if (did) dismissAlertById(did); break;
            case 'admin-save-secret': adminSaveSecret(); break;
            case 'admin-clear-secret': adminClearSecret(); break;
            case 'admin-trigger-ingest': adminTriggerIngest(); break;
            case 'admin-unlock': adminUnlock(); break;
            case 'admin-thumbs-status': adminThumbsStatus(); break;
            case 'admin-force-refresh-travel': adminForceRefreshTravel(); break;
            case 'admin-generate-brief': adminGenerateBrief(); break;
            case 'admin-list-briefs': adminListBriefs(); break;
            case 'return-live': returnToLive(); break;
            default: break;
          }
        });

        // click feed-card open
        document.addEventListener('click', (e) => {
          const card = e.target.closest('.feed-card[data-link]');
          if (!card) return;
          if (e.target.closest('a')) return;
          if (e.target.closest('[data-action]')) return;
          const href = card.getAttribute('data-link'); if(!href) return;
          try { window.open(href, '_blank', 'noopener'); } catch(e){}
        });

        // inputs wiring
        const historyPicker = document.getElementById('history-picker'); if (historyPicker) historyPicker.addEventListener('change', (ev) => loadHistory(ev.target.value));
        const proxRad = document.getElementById('proxRadius'); if (proxRad) proxRad.addEventListener('change', updateProximityRadius);
        if (countrySel) countrySel.addEventListener('change', filterTravel);

        // initial load
        await loadFromWorker();
        await loadProximityFromWorker();
        filterNews('Global');
        await loadTravelAdvisories();

        // apply stored votes
        Object.keys(VOTES_LOCAL).forEach(k => applyVoteUIForId(k, VOTES_LOCAL[k]));

        // auto refresh while live
        setInterval(async () => {
          if (FEED_IS_LIVE) {
            await loadFromWorker(true);
            await loadProximityFromWorker(true);
            const active = document.querySelector('.nav-item-custom.active');
            filterNews(active ? active.textContent.trim() : 'Global');
          }
        }, AUTO_REFRESH_MS);

        setTimeout(()=>{ try { flushVoteQueue(); } catch(e) {} }, 1000);
      } catch(e) {
        console.error('Initialization error', e);
        const feed = document.getElementById('general-news-feed');
        if (feed) feed.innerHTML = `<div style="padding:20px;color:#b00;">Application failed to initialize. See console for details.</div>`;
      }
    });

    // Expose helpers for debugging/console
    window.loadTravelAdvisories = loadTravelAdvisories;
    window.filterTravel = filterTravel;
    window.loadHistory = loadHistory;
    window.voteThumb = voteThumb;
    window.flushVoteQueue = flushVoteQueue;
    window.updateProximityRadius = updateProximityRadius;
    window.dismissAlertById = function(id){ DISMISSED_ALERT_IDS.add(String(id)); sessionStorage.setItem('dismissed_prox_alert_ids', JSON.stringify(Array.from(DISMISSED_ALERT_IDS).slice(0,500))); };
    window.manualRefresh = manualRefresh;
    window.filterNews = function(region){ renderAssetsOnMap(region); renderIncidentsOnMap(region, INCIDENTS); renderGeneralFeed(region); updateHeadline(region); renderProximityAlerts(region); };
    window.adminGetSecret = adminGetSecret;
    window.returnToLive = returnToLive;
  } // end guard else
  </script>
</body>
</html>
