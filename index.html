<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OS | INFOHUB</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    :root { --dell-blue: #0076CE; --bg-dark: #0f1115; }
    body { background-color: var(--bg-dark); font-family: 'Inter', sans-serif; padding: 24px; color: #333; }

    /* SEVERITY COLORS */
    .sev-CRITICAL { background-color: #ef4444; color: #fff; border-color:#ef4444; }
    .sev-HIGH     { background-color: #f97316; color: #fff; border-color:#f97316; }
    .sev-MODERATE { background-color: #eab308; color: #000; border-color:#eab308; }
    .sev-LOW      { background-color: #1a73e8; color: #fff; border-color:#1a73e8; }
    .sev-UNKNOWN  { background-color: #64748b; color: #fff; }

    .app-container { background-color: #fff; border-radius: 24px; min-height: 92vh; padding: 0; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .header-container { padding: 15px 32px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f0f0f0; height: 70px; }
    .logo-icon { font-size: 1.6rem; color: #1a73e8; display: flex; align-items: center; }
    .logo-text { font-size: 1.2rem; font-weight: 800; color: #202124; margin-left: 12px; }
    .logo-text span { color: var(--dell-blue); }

    .content-area { padding: 30px; }
    .map-wrapper { position: relative; border-radius: 16px; overflow: hidden; height: 520px; background: #eef2f6; }
    #map { width: 100%; height: 100%; }

    .feed-card { background: #fff; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 15px; padding: 0; display: flex; overflow: hidden; text-decoration: none; color: inherit; }
    .feed-status-bar { width: 5px; flex-shrink: 0; }
    .feed-content { padding: 16px 20px; width: 100%; }
    .feed-tags { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
    .ftag { font-size: 0.7rem; font-weight: 800; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; border: 1px solid #eee; }
    .ftag-loc { background: #202124; color: #fff; }

    .alert-row { padding: 15px 0; border-bottom: 1px solid #f1f1f1; }
    .modal-content { border-radius: 12px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .advisory-box { background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; margin-top: 15px; }
    
    .news-box-alert { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; margin-top: 10px; overflow: hidden; }
    .news-box-header { background: #f8f9fa; padding: 8px 12px; font-size: 0.75rem; font-weight: 700; color: #5f6368; border-bottom: 1px solid #eee; }
    .news-box-item { padding: 10px 12px; border-bottom: 1px solid #eee; }
    .news-box-item:last-child { border-bottom: none; }
  </style></head><body><div class="app-container">
  <div class="header-container">
    <div class="d-flex align-items-center">
      <div class="logo-icon"><i class="fas fa-shield-alt"></i></div>
      <div class="logo-text ms-2">OS <span>INFOHUB</span></div>
    </div>

    <div class="d-flex align-items-center">
      <div class="nav-pills-custom me-3">
        <a class="nav-item-custom active" onclick="app.filterNews('Global', this)">Global</a>
        <a class="nav-item-custom" onclick="app.filterNews('AMER', this)">AMER</a>
        <a class="nav-item-custom" onclick="app.filterNews('EMEA', this)">EMEA</a>
        <a class="nav-item-custom" onclick="app.filterNews('APJC', this)">APJC</a>
        <a class="nav-item-custom" onclick="app.filterNews('LATAM', this)">LATAM</a>
      </div>

      <div class="clock-container text-end me-3">
        <div class="clock-date" id="clock-date">Loading...</div>
        <div class="clock-time" id="clock-time">--:--</div>
      </div>

      <div class="btn-daily me-2" onclick="manualRefresh()"><i class="fas fa-rotate me-2"></i> Refresh</div>
    </div>
  </div>

  <div class="content-area">
    <div class="row g-4">
      <div class="col-lg-9">
        <div class="map-wrapper mb-3"><div id="map"></div></div>

        <div class="stream-section">
          <div class="stream-header d-flex justify-content-between align-items-center mb-3">
            <div class="fw-bold">Live Intelligence</div>
            <div class="badge bg-secondary" id="feed-count">WAITING...</div>
          </div>
          <div id="general-news-feed">
            <div style="padding:30px;text-align:center;color:#999;">Connecting to Secure Worker…</div>
          </div>
        </div>
      </div>

      <div class="col-lg-3 sidebar-col">
        <div class="side-card">
          <div class="card-label"><i class="fas fa-history"></i> History Search</div>
          <input type="date" class="form-control" id="history-picker" onchange="loadHistory(this.value)" />
        </div>

        <div class="side-card">
          <div class="card-label"><i class="fas fa-plane"></i> Travel Safety Check</div>
          <select class="form-select" id="countrySelect" onchange="filterTravel()"><option disabled>Loading...</option></select>
          <div id="travel-advisories" class="mt-3"></div>
          <div id="travel-news" class="mt-2"></div>
        </div>

        <div class="side-card">
          <div class="card-label">Proximity Alerts</div>
          <div style="margin:10px 0;">
            <select id="proxRadius" class="form-select form-select-sm" onchange="app.updateProximity()">
              <option value="50" selected>50 KM</option>
              <option value="100">100 KM</option>
              <option value="500">500 KM</option>
            </select>
          </div>
          <div id="proximity-alerts-container">Scanning assets...</div>
        </div>
      </div>
    </div>
  </div></div><div class="modal fade" id="reportModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Daily Briefing</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body"><button class="btn btn-primary w-100" onclick="downloadReport()">Generate</button></div>
    </div>
  </div></div><script>/* ========== CONFIG ========== */const WORKER_URL = "https://osinfohub.vssmaximus.workers.dev"; // Change to your deployed worker if differentconst AUTO_REFRESH_MS = 60_000;/* ========== STATE ========== */let INCIDENTS = [];let TRAVEL_DATA = [];let currentRadius = 50;let map, layerGroup, incidentLayerGroup;/* ========== UTIL ========== */function escapeHtml(s) { return String(s || "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'", "&#039;"); }function haversineKm(lat1, lon1, lat2, lon2) {
    const R = 6371; const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}/* Map-friendly asset list (kept full in your files; shortened here for brevity) */const ASSETS = {
  "round rock": { lat: 30.5083, lng: -97.6788, region: "AMER" },
  "austin": { lat: 30.3952, lng: -97.6843, region: "AMER" }, // Austin Parmer aligned
  "hopkinton": { lat: 42.2287, lng: -71.5226, region: "AMER" },
  "nashville": { lat: 36.1627, lng: -86.7816, region: "AMER" },
  "oklahoma city": { lat: 35.4676, lng: -97.5164, region: "AMER" },
  "santa clara": { lat: 37.3541, lng: -121.9552, region: "AMER" },
  "bangalore": { lat: 12.9716, lng: 77.5946, region: "APJC" },
  "london": { lat: 51.5074, lng: -0.1278, region: "EMEA" },
  "mexico city": { lat: 19.4326, lng: -99.1332, region: "LATAM" },
  "sao paulo": { lat: -23.5505, lng: -46.6333, region: "LATAM" }
};/* Bridge for worker site aliases (if worker returns keys) */const WORKER_SITE_ALIAS = {
  "round rock": "Dell Round Rock HQ",
  "austin": "Dell Austin Parmer",
  "hopkinton": "Dell Hopkinton",
  "nashville": "Dell Nashville Hub",
  "oklahoma city": "Dell Oklahoma City",
  "santa clara": "Dell Santa Clara",
  "mexico city": "Dell Mexico City",
  "sao paulo": "Dell São Paulo"
};/* Severity helper (text-based) */function getSevDetails(level) {
    const map = {
        'CRITICAL': { val: 4, color: '#ef4444' },
        'HIGH':     { val: 3, color: '#f97316' },
        'MODERATE': { val: 2, color: '#eab308' },
        'LOW':      { val: 1, color: '#1a73e8' }
    };
    return map[level] || { val: 0, color: '#64748b' };
}function numericToTextSeverity(n) {
    const num = Number(n);
    if (num >= 4) return "CRITICAL";
    if (num === 3) return "HIGH";
    if (num === 2) return "MODERATE";
    return "LOW";
}/* ========== BOOT ========== */document.addEventListener("DOMContentLoaded", async () => {
  initMap();
  startClock();
  await loadFromWorker();
  await loadTravelAdvisories();
  filterNews('Global');
  setInterval(async () => { await loadFromWorker(true); filterNews(document.querySelector('.nav-item-custom.active')?.innerText || 'Global'); }, AUTO_REFRESH_MS);
});/* Clock */function startClock(){
  const tick = () => {
    const now = new Date();
    document.getElementById('clock-time').innerText = now.toLocaleTimeString();
    document.getElementById('clock-date').innerText = now.toLocaleDateString();
  };
  tick(); setInterval(tick, 1000);
}/* Map init */function initMap(){
  map = L.map('map', { zoomControl:false }).setView([20,0],2);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom:19 }).addTo(map);
  layerGroup = L.layerGroup().addTo(map);
  incidentLayerGroup = L.layerGroup().addTo(map);
  renderAssetsOnMap('Global');
}function renderAssetsOnMap(region){
  layerGroup.clearLayers();
  for (const [key, a] of Object.entries(ASSETS)) {
    if (region !== 'Global' && a.region !== region) continue;
    const icon = L.divIcon({ className:'custom-div-icon', html:`<div class="marker-pin-dell"><i class="fas fa-building"></i></div>`, iconSize:[30,30], iconAnchor:[15,15] });
    const marker = L.marker([a.lat, a.lng], { icon }).addTo(layerGroup);
    const name = WORKER_SITE_ALIAS[key] || key;
    marker.bindTooltip(`<b>${name.toUpperCase()}</b>`, { permanent:false, direction:'top', className:'map-tooltip' });
  }
}/* ========== WORKER FETCHES ========== */async function loadFromWorker(silent = false) {
  const status = document.getElementById('feed-count');
  if (!silent) status.innerText = 'REFRESHING...';
  try {
    const res = await fetch(`${WORKER_URL}/api/incidents`, { cache: 'no-store' });
    if (!res.ok) throw new Error('Worker error');
    const raw = await res.json();
    const arr = Array.isArray(raw) ? raw : [];
    INCIDENTS = arr.map(normaliseWorkerIncident).filter(Boolean);
    INCIDENTS.sort((a,b) => (getSevDetails(b.severity_text).val - getSevDetails(a.severity_text).val) || (new Date(b.time) - new Date(a.time)));
    status.innerText = `${INCIDENTS.length} ITEMS`;
  } catch (e) {
    if (!silent) status.innerText = 'OFFLINE';
    console.error(e);
  }
}/* Normalise incidents from worker — accepts numeric severity OR severity_text */function normaliseWorkerIncident(item){
  if (!item || !item.title) return null;
  // Prefer textual severity returned by worker (severity_text). If absent, convert numeric.
  let sevText = null;
  if (item.severity_text) sevText = String(item.severity_text).toUpperCase();
  else if (item.severity !== undefined && item.severity !== null) {
    // numeric or string num
    if (!isNaN(Number(item.severity))) sevText = numericToTextSeverity(Number(item.severity));
    else sevText = String(item.severity).toUpperCase();
  } else {
    sevText = 'LOW';
  }
  // guard values
  if (!['CRITICAL','HIGH','MODERATE','LOW'].includes(sevText)) sevText = 'LOW';

  return {
    id: item.id || (item.title + '|' + (item.link || '')),
    title: item.title,
    summary: item.summary || '',
    category: (item.category || 'UNKNOWN').toUpperCase(),
    severity: Number(item.severity || 1), // numeric for legacy
    severity_text: sevText, // text for UI
    region: (item.region && item.region !== 'GLOBAL') ? item.region : 'Global',
    country: item.country || 'GLOBAL',
    location: item.location || 'UNKNOWN',
    link: item.link || '#',
    time: item.time || new Date().toISOString(),
    lat: Number(item.lat || 0),
    lng: Number(item.lng || 0),
    nearest_site_name: item.nearest_site_name || item.nearest_site || item.nearest_site_key || '',
    distance_km: Number(item.distance_km || item.distance || NaN),
    source: item.source || ''
  };
}/* Travel advisories: cold-start fixed on the worker; dashboard just loads */async function loadTravelAdvisories(attempt = 1){
  const sel = document.getElementById('countrySelect');
  if (!sel) return;
  sel.innerHTML = '<option disabled>Loading...</option>';
  try {
    const res = await fetch(`${WORKER_URL}/api/traveladvisories`, { cache: 'no-store' });
    if (!res.ok) throw new Error('travel fail');
    const json = await res.json();
    TRAVEL_DATA = json.advisories || [];
    populateCountries();
  } catch(e){
    if (attempt < 4) setTimeout(() => loadTravelAdvisories(attempt+1), 1200);
    else sel.innerHTML = '<option disabled>Unavailable</option>';
  }
}function populateCountries(){
  const sel = document.getElementById('countrySelect');
  sel.innerHTML = '<option selected disabled>Select Country...</option>';
  TRAVEL_DATA.sort((a,b)=>a.country.localeCompare(b.country)).forEach(c => {
    const opt = document.createElement('option'); opt.value = c.country; opt.text = c.country; sel.appendChild(opt);
  });
}/* ========== RENDERING ========== */function filterNews(region, el){
  document.querySelectorAll('.nav-item-custom').forEach(n=>n.classList.remove('active'));
  if (el) el.classList.add('active');
  renderAssetsOnMap(region);
  renderIncidentsOnMap(region);
  renderGeneralFeed(region);
  renderProximityAlerts(region);
  updateHeadline(region);
}function renderIncidentsOnMap(region){
  incidentLayerGroup.clearLayers();
  const filtered = (region === 'Global') ? INCIDENTS : INCIDENTS.filter(i => i.region === region);
  filtered.forEach(i => {
    if (!i.lat || !i.lng) return;
    const sev = getSevDetails(i.severity_text);
    const circle = L.circleMarker([i.lat, i.lng], { radius: 8, fillColor: sev.color, color:'#fff', weight:2, fillOpacity:0.85 }).addTo(incidentLayerGroup);
    circle.bindPopup(`<b>${escapeHtml(i.title)}</b><br/><small>${escapeHtml(i.country)} • ${escapeHtml(i.location)}</small>`);
  });
}function renderGeneralFeed(region){
  const container = document.getElementById('general-news-feed');
  const data = (region === 'Global') ? INCIDENTS : INCIDENTS.filter(i=>i.region===region);
  if (!data || data.length===0) { container.innerHTML = `<div style="padding:30px;text-align:center;color:#999;">No incidents for this region.</div>`; return; }
  let html = "";
  data.forEach(i => {
    const sev = getSevDetails(i.severity_text);
    html += `<a class="feed-card" href="${escapeHtml(i.link)}" target="_blank">
      <div class="feed-status-bar" style="background:${sev.color}"></div>
      <div class="feed-content">
        <div class="feed-tags">
          <span class="ftag" style="background:${sev.color};color:#fff">${escapeHtml(i.severity_text)}</span>
          <span class="ftag ftag-loc">${escapeHtml((i.country||'GLOBAL').toUpperCase())}</span>
          <span class="ftag ftag-type">${escapeHtml(i.category)}</span>
        </div>
        <div class="feed-title">${escapeHtml(i.title)}</div>
        <div class="feed-meta">${escapeHtml(i.source || '')} • ${new Date(i.time).toLocaleString()}</div>
        <div class="feed-desc">${escapeHtml(i.summary || '')}</div>
      </div>
    </a>`;
  });
  container.innerHTML = html;
}function updateHeadline(region){
  const data = (region === 'Global') ? INCIDENTS : INCIDENTS.filter(i=>i.region===region);
  const el = document.getElementById('headline-alert');
  const sevEl = document.getElementById('headline-sev');
  const catEl = document.getElementById('headline-cat');
  const regEl = document.getElementById('headline-reg');
  if (!data || data.length===0){
    if (el) el.textContent = 'No headline';
    if (sevEl) sevEl.textContent = 'SEV?';
    if (catEl) catEl.textContent = 'CATEGORY';
    if (regEl) regEl.textContent = region.toUpperCase();
    return;
  }
  const top = data[0];
  if (el) el.textContent = top.title;
  if (sevEl) { sevEl.textContent = top.severity_text; sevEl.className = `tag ${'sev-' + top.severity_text}`; }
  if (catEl) catEl.textContent = top.category || 'UNKNOWN';
  if (regEl) regEl.textContent = top.region || 'GLOBAL';
}/* ========== PROXIMITY ========== */function updateProximityRadius(){
  const sel = document.getElementById('proxRadius'); currentRadius = Number(sel.value || 50); renderProximityAlerts(document.querySelector('.nav-item-custom.active')?.innerText || 'Global');
}function renderProximityAlerts(region){
  const container = document.getElementById('proximity-alerts-container'); container.innerHTML = '';
  const incidents = (region === 'Global') ? INCIDENTS : INCIDENTS.filter(i=>i.region===region);
  const alerts = [];
  for (const inc of incidents) {
    if (!inc) continue;
    // Prefer worker-provided nearest fields
    const workerSite = (inc.nearest_site_name || inc.nearest_site || inc.nearest_site_key || '').toString().toLowerCase();
    const workerDist = Number(inc.distance_km || inc.distance || NaN);
    if (workerSite && Number.isFinite(workerDist) && workerDist <= currentRadius) {
      alerts.push({ inc, assetName: (WORKER_SITE_ALIAS[workerSite] || workerSite), dist: workerDist });
      continue;
    }
    if (!inc.lat || !inc.lng) continue;
    let bestDist = Infinity, bestSite = null;
    for (const [name, s] of Object.entries(ASSETS)) {
      const d = haversineKm(inc.lat, inc.lng, s.lat, s.lng);
      if (d < bestDist) { bestDist = d; bestSite = name; }
    }
    if (bestSite && bestDist <= currentRadius) alerts.push({ inc, assetName: bestSite, dist: bestDist });
  }

  // sort by dist then severity
  alerts.sort((a,b) => (a.dist - b.dist) || (getSevDetails(b.inc.severity_text).val - getSevDetails(a.inc.severity_text).val));
  if (alerts.length === 0) { container.innerHTML = `<div style="padding:15px;color:#999;text-align:center;">No incidents within ${currentRadius}km.</div>`; return; }

  let html = "";
  for (const a of alerts.slice(0,25)) {
    const sev = getSevDetails(a.inc.severity_text);
    html += `<div class="alert-row">
      <div class="d-flex justify-content-between"><div style="font-weight:700;color:${sev.color}">${escapeHtml(a.inc.severity_text)} THREAT</div><div style="font-weight:700;color:${sev.color}">${Math.round(a.dist)} KM</div></div>
      <div style="margin-top:6px;font-weight:600">${escapeHtml(a.inc.title)}</div>
      <div style="margin-top:6px;color:#64748b;font-size:0.85rem">Near ${escapeHtml((WORKER_SITE_ALIAS[a.assetName]||a.assetName).toUpperCase())}</div>
    </div>`;
  }
  container.innerHTML = html;
}/* ========== TRAVEL FILTER UI ========== */function filterTravel(){
  const country = document.getElementById('countrySelect').value;
  const adv = TRAVEL_DATA.find(x=>x.country===country);
  const advBox = document.getElementById('travel-advisories');
  const newsBox = document.getElementById('travel-news');
  if (!advBox) return;
  if (!adv) {
    advBox.innerHTML = `<div style="padding:12px;color:#999;">No advisory</div>`;
    newsBox.innerHTML = '';
    return;
  }
  let color='#1a73e8', levelText='LEVEL 1';
  if (adv.level >= 4) { color='#d93025'; levelText='LEVEL 4' }
  else if (adv.level >= 3) { color='#e37400'; levelText='LEVEL 3' }
  else if (adv.level >= 2) { color='#f9ab00'; levelText='LEVEL 2' }
  advBox.innerHTML = `<div class="advisory-box" style="border-left:4px solid ${color}"><div style="font-weight:700;color:${color}">${levelText}</div><div style="margin-top:6px">${escapeHtml(adv.text)}</div></div>`;
  const related = INCIDENTS.filter(i => String(i.country).toUpperCase() === String(country).toUpperCase()).slice(0,3);
  if (related.length) {
    let nh = `<div class="news-box-alert"><div class="news-box-header">RECENT INCIDENTS</div>`;
    related.forEach(r => nh += `<div class="news-box-item"><div class="news-box-title">${escapeHtml(r.title)}</div></div>`);
    nh += `</div>`; newsBox.innerHTML = nh;
  } else newsBox.innerHTML = `<div class="safe-box"><i class="fas fa-check-circle safe-icon"></i><div class="safe-text">No recent incidents.</div></div>`;
}/* ========== HELPERS ========== */function manualRefresh(){ loadFromWorker(); filterNews(document.querySelector('.nav-item-custom.active')?.innerText || 'Global'); }function loadHistory(d){ alert('History demo: ' + d); }function downloadReport(){ alert('Report generation: not implemented in this demo.'); }/* ========== Initial calls ========== */async function loadTravelAdvisories(){ await loadTravelAdvisoriesImpl(); }async function loadTravelAdvisoriesImpl(attempt=1){
  try {
    const res = await fetch(`${WORKER_URL}/api/traveladvisories`, { cache: 'no-store' });
    if (!res.ok) throw new Error('travel error');
    const json = await res.json(); TRAVEL_DATA = json.advisories || [];
    populateCountriesLocal();
  } catch(e){
    if (attempt < 4) setTimeout(()=>loadTravelAdvisoriesImpl(attempt+1), 1200);
    else document.getElementById('countrySelect').innerHTML = '<option disabled>Unavailable</option>';
  }
}function populateCountriesLocal(){
  const sel = document.getElementById('countrySelect'); sel.innerHTML = '<option selected disabled>Select Country...</option>';
  TRAVEL_DATA.sort((a,b)=>a.country.localeCompare(b.country)).forEach(c => sel.innerHTML += `<option value="${c.country}">${c.country}</option>`);
}</script></body></html>
