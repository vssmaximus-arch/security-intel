<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com 'unsafe-inline';
    style-src 'self' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com https://fonts.googleapis.com 'unsafe-inline';
    font-src 'self' https://cdnjs.cloudflare.com https://fonts.gstatic.com;
    img-src 'self' data: https://*.basemaps.cartocdn.com https://*.arcgisonline.com;
    connect-src 'self' https://osinfohub.vssmaximus.workers.dev https://raw.githubusercontent.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com https://server.arcgisonline.com;
    base-uri 'self';
  ">

  <link rel="icon" href="data:,">
  <title>Dell OS | INFOHUB</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

    :root {
      --dell-blue: #0076CE;
      --bg-dark: #0f1115;
    }

    body {
      background-color: var(--bg-dark);
      font-family: 'Inter', sans-serif;
      padding: 24px;
      color: #333;
    }

    .skip-link {
      position: absolute; top: -50px; left: 10px;
      background: #1a73e8; color: #fff; padding: 10px;
      z-index: 99999; font-weight: 700; border-radius: 4px;
      text-decoration: none; transition: top 0.2s;
    }
    .skip-link:focus { top: 10px; }

    .app-container {
      background-color: #fff;
      border-radius: 24px;
      min-height: 92vh;
      padding: 0;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .header-container {
      padding: 15px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #f0f0f0;
      height: 90px;
    }

    .header-left { display: flex; align-items: center; height: 100%; }
    .logo-icon { font-size: 1.6rem; color: #1a73e8; display: flex; align-items: center; }
    .logo-text { font-size: 1.2rem; font-weight: 800; color: #202124; letter-spacing: -0.5px; margin-left: 12px; line-height: 1; padding-top: 2px; }
    .logo-text span { color: var(--dell-blue); }

    .multi-clock-container { display: flex; gap: 12px; margin: 0 20px; padding-right: 20px; border-right: 1px solid #e0e0e0; height: 100%; align-items: center; }
    .clock-box { text-align: center; min-width: 85px; background: #2b2b2b; border: 3px solid #b0b0b0; border-radius: 10px; padding: 6px; box-shadow: 0 3px 5px rgba(0,0,0,0.3); }
    .clock-label { font-family: 'Inter', sans-serif; font-size: 0.55rem; font-weight: 700; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
    .clock-val { font-family: 'Share Tech Mono', monospace; font-size: 1.25rem; font-weight: 400; color: #4fdb5e; line-height: 1; background: #000; padding: 4px 6px; border-radius: 4px; display: block; text-shadow: 0 0 5px rgba(79, 219, 94, 0.5); box-shadow: inset 0 0 5px rgba(0,0,0,0.8); font-variant-numeric: tabular-nums; }

    .map-wrapper { position: relative; border-radius: 16px; overflow: hidden; height: 520px; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05); background: #eef2f6; }
    #map { width: 100%; height: 100%; z-index: 1; outline: none; }
    #map:focus { box-shadow: inset 0 0 0 3px rgba(26,115,232,0.5); }

    .leaflet-tooltip.map-tooltip { background-color: #202124; color: #fff; border: none; border-radius: 4px; padding: 6px 10px; font-family: 'Inter', sans-serif; font-size: 0.8rem; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
    .leaflet-tooltip-top:before { border-top-color: #202124; }
    .leaflet-popup-content-wrapper { border-radius: 6px; padding: 0; }
    .leaflet-popup-content { margin: 10px 12px; font-size: 0.85rem; font-family: 'Inter', sans-serif; font-weight: 600; color: #333; }

    .marker-pin-dell { width: 30px; height: 30px; background: #1a73e8; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 2px solid white; box-shadow: 0 3px 6px rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; }
    .marker-pin-dell i { transform: rotate(45deg); color: white; font-size: 14px; margin-top: 2px; margin-left: 2px; }

    .incident-dot { width:12px; height:12px; border-radius:50%; border:2px solid #fff; box-shadow:0 2px 3px rgba(0,0,0,0.3); }

    .cluster-icon { display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; border-radius:50%; box-shadow:0 2px 6px rgba(0,0,0,0.35); border: 2px solid rgba(255,255,255,0.6); font-family: 'Inter', sans-serif; cursor: pointer; }
    .cluster-icon:focus { outline: 2px solid #fff; outline-offset: 2px; }
    .cluster-count { font-size:13px; line-height:1; }
    .cluster-blue { background: #1a73e8; }
    .cluster-amber { background: #f9ab00; }
    .cluster-red { background: #d93025; }

    .btn-daily { background-color: #1a73e8; color: white; padding: 9px 18px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(26,115,232,0.2); cursor: pointer; transition: opacity 0.2s; }
    .btn-daily:hover { background-color: #1557b0; color: white; }
    .btn-daily:focus { outline: 2px solid #202124; outline-offset: 2px; }

    .nav-pills-custom { background-color: #f1f3f4; padding: 4px; border-radius: 10px; display: flex; gap: 2px; }
    .nav-item-custom { padding: 7px 18px; border-radius: 8px; font-weight: 700; font-size: 0.8rem; color: #5f6368; cursor: pointer; text-decoration: none; text-transform: uppercase; letter-spacing: 0.5px; }
    .nav-item-custom.active { background-color: #202124; color: #fff; }
    .nav-item-custom:focus { outline: 2px solid #202124; }

    .content-area { padding: 30px; }
    .sidebar-col { padding-left: 30px; }
    .side-card { background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 24px; box-shadow: 0 2px 6px rgba(0,0,0,0.02); }
    .card-label { font-size: 0.95rem; font-weight: 700; color: #202124; margin-bottom: 12px; display: flex; align-items: center; gap: 10px; }
    .card-label i { color: #9aa0a6; }

    .history-input-group { position: relative; }
    .history-input { width: 100%; padding: 10px 10px 10px 40px; border: 1px solid #dadce0; border-radius: 8px; font-size: 0.9rem; color: #333; font-weight: 500; }
    .calendar-icon { position: absolute; left: 12px; top: 12px; color: #5f6368; }
    .sub-text { font-size: 0.75rem; color: #9aa0a6; margin-top: 8px; font-weight: 500; }

    .travel-select { width: 100%; padding: 10px 12px; border: 1px solid #dadce0; border-radius: 8px; font-size: 0.9rem; color: #5f6368; background-color: #fff; }
    .prox-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2px; }
    .prox-dell-label { font-size: 0.8rem; font-weight: 700; color: #202124; }
    .prox-main-title { font-size: 1.2rem; font-weight: 800; color: #1a73e8; line-height: 1.1; }
    .prox-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; margin-bottom: 15px; }
    .prox-subtitle { font-size: 0.7rem; color: #9aa0a6; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; margin: 0; }
    .radius-select { font-size: 0.75rem; padding: 4px 8px; border-radius: 6px; border: 1px solid #ddd; color: #555; font-weight: 600; background: #f9f9f9; cursor: pointer; }

    #proximity-alerts-container { max-height: 400px; overflow-y: auto; padding-right: 5px; }
    #proximity-alerts-container::-webkit-scrollbar { width: 6px; }
    #proximity-alerts-container::-webkit-scrollbar-track { background: #f1f3f4; border-radius: 4px; }
    #proximity-alerts-container::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
    #proximity-alerts-container::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

    .alert-row { padding: 15px 0; border-bottom: 1px solid #f1f1f1; }
    .alert-row:last-child { border-bottom: none; }
    .alert-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; gap: 10px; width: 100%; }
    .alert-type { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 0.9rem; color: #202124; flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .alert-dist { font-weight: 700; font-size: 0.85rem; color: #d93025; white-space: nowrap; flex-shrink: 0; }
    .alert-site { font-size: 0.85rem; font-weight: 600; color: #5f6368; display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .alert-desc { font-size: 0.8rem; color: #5f6368; line-height: 1.4; }

    .stream-section { margin-top: 25px; }
    .stream-header { display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; }
    .stream-label { font-weight: 700; font-size: 0.95rem; display: flex; align-items: center; gap: 10px; }
    .live-dot-blue { color: #1a73e8; font-size: 0.8rem; }
    .live-box { background: #e8f0fe; color: #1a73e8; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; }

    .feed-card { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e0e0e0; margin-bottom: 15px; padding: 0; display: flex; overflow: hidden; transition: transform 0.2s; text-decoration: none; color: inherit; }
    .feed-card:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .feed-status-bar { width: 5px; flex-shrink: 0; }
    .status-bar-crit { background-color: #d93025; }
    .status-bar-warn { background-color: #f9ab00; }
    .status-bar-info { background-color: #1a73e8; }

    .feed-content { padding: 16px 20px; width: 100%; }
    .feed-tags { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; flex-wrap: wrap; }
    .ftag { font-size: 0.7rem; font-weight: 800; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; border: 1px solid #eee; letter-spacing: 0.5px; }
    .ftag-crit { background: #fce8e6; color: #c5221f; border-color: #fad2cf; }
    .ftag-warn { background: #fef7e0; color: #e37400; border-color: #feebc8; }
    .ftag-info { background: #e8f0fe; color: #1a73e8; border-color: #d2e3fc; }
    .ftag-type { background: #f1f3f4; color: #5f6368; }
    .ftag-loc { background: #202124; color: #fff; border-color: #202124; }

    .feed-region { margin-left: auto; font-size: 0.75rem; font-weight: 700; color: #9aa0a6; }
    .feed-title { font-size: 1rem; font-weight: 700; color: #202124; margin-bottom: 6px; line-height: 1.4; }
    .feed-meta { font-size: 0.8rem; color: #5f6368; margin-bottom: 8px; font-weight: 500; }
    .feed-desc { font-size: 0.85rem; color: #3c4043; line-height: 1.5; }

    .critical-alert-bar { background: #fce8e6; border-left: 4px solid #d93025; padding: 12px 20px; border-radius: 6px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
    .alert-icon-lg { color: #d93025; font-size: 1.2rem; }
    .alert-content-main { flex-grow: 1; font-weight: 700; color: #202124; font-size: 0.95rem; }
    .alert-tags { display: flex; gap: 8px; flex-wrap: wrap; }
    .tag { font-size: 0.7rem; font-weight: 800; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; color: white; }
    .tag-crit { background: #d93025; color: white; }
    .tag-cat { background: #3c4043; color: white; }
    .tag-reg { background: #3c4043; color: white; opacity: 0.8; }
    .tag-low { background: #e8f0fe; color: #1a73e8; border: 1px solid #d2e3fc; }
    .tag-medium { background: #fef7e0; color: #e37400; border: 1px solid #feebc8; }
    .tag-high { background: #fce8e6; color: #c5221f; border: 1px solid #fad2cf; }
    .tag-critical { background: #d93025; color: #fff; border: 1px solid #d93025; }

    .advisory-box { background: #fdf2f2; border: 1px solid #fad2cf; border-radius: 8px; padding: 12px; margin-top: 15px; }
    .advisory-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .advisory-label { font-size: 0.7rem; font-weight: 800; color: #5f6368; letter-spacing: 0.5px; }
    .advisory-level-badge { font-size: 0.7rem; font-weight: 800; color: white; padding: 2px 8px; border-radius: 4px; }
    .advisory-text { font-size: 0.85rem; font-weight: 600; color: #333; line-height: 1.3; }
    .advisory-updated { font-size: 0.72rem; color: #5f6368; margin-top: 8px; font-weight: 600; }

    .safe-box { background: #e6f4ea; border: 1px solid #ceead6; border-radius: 8px; padding: 12px; margin-top: 10px; display: flex; align-items: flex-start; gap: 10px; }
    .safe-icon { color: #1e8e3e; font-size: 1rem; margin-top: 2px; }
    .safe-text { font-size: 0.85rem; color: #137333; font-weight: 600; line-height: 1.4; }

    .news-box-alert { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; margin-top: 10px; overflow: hidden; }
    .news-box-header { background: #f8f9fa; padding: 8px 12px; font-size: 0.75rem; font-weight: 700; color: #5f6368; border-bottom: 1px solid #eee; }
    .news-box-item { padding: 10px 12px; border-bottom: 1px solid #eee; }
    .news-box-item:last-child { border-bottom: none; }
    .news-box-title { font-size: 0.85rem; font-weight: 700; color: #202124; margin-bottom: 4px; }
    .news-box-summary { font-size: 0.75rem; color: #5f6368; }

    .modal-content { border-radius: 12px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .modal-header { border-bottom: 1px solid #f0f0f0; padding: 20px; }
    .modal-title { font-weight: 800; color: #202124; }
    .modal-body { padding: 30px; }
    .form-label { font-size: 0.85rem; font-weight: 700; color: #5f6368; margin-bottom: 8px; }
    .form-select, .form-control { border-radius: 8px; padding: 10px; font-size: 0.9rem; border: 1px solid #dadce0; }
    .btn-download { width: 100%; background: #1a73e8; color: white; font-weight: 700; padding: 12px; border-radius: 8px; border: none; margin-top: 10px; }
    .btn-download:hover { background: #1557b0; }

    /* DEBUG OVERLAY */
    .assets-debug {
      position: absolute;
      top: 110px;
      right: 18px;
      z-index: 999999;
      background: #fff;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      max-width: 320px;
      line-height: 1.25;
    }
    .assets-debug pre { white-space: pre-wrap; word-break: break-word; margin: 0; font-size: 12px; color:#222; }
  </style>
</head>

<body>
  <a href="#main-content" class="skip-link">Skip to Main Content</a>

<div class="app-container" id="main-content">
  <div class="header-container">
    <div class="header-left">
      <div class="logo-icon"><i class="fas fa-shield-alt" aria-hidden="true"></i></div>
      <div class="logo-text">OS <span>INFOHUB</span></div>
    </div>

    <div class="header-right d-flex align-items-center">
      <div class="multi-clock-container" id="multi-clock-container" role="timer" aria-label="World Clocks">
        </div>

      <div class="nav-pills-custom" role="tablist" aria-label="Region Filter">
        <a class="nav-item-custom active" onclick="filterNews('Global')" role="tab" aria-selected="true" tabindex="0">Global</a>
        <a class="nav-item-custom" onclick="filterNews('AMER')" role="tab" aria-selected="false" tabindex="0">AMER</a>
        <a class="nav-item-custom" onclick="filterNews('EMEA')" role="tab" aria-selected="false" tabindex="0">EMEA</a>
        <a class="nav-item-custom" onclick="filterNews('APJC')" role="tab" aria-selected="false" tabindex="0">APJC</a>
        <a class="nav-item-custom" onclick="filterNews('LATAM')" role="tab" aria-selected="false" tabindex="0">LATAM</a>
      </div>

      <div id="btn-refresh" class="btn-daily ms-3" onclick="manualRefresh()" role="button" aria-label="Refresh Data" tabindex="0">
        <i class="fas fa-rotate" aria-hidden="true"></i> Refresh
      </div>

      <div class="btn-daily ms-2" data-bs-toggle="modal" data-bs-target="#reportModal" style="background:#202124;
        box-shadow:none;" role="button" aria-label="Open Reports" tabindex="0">
        <i class="fas fa-file-alt" aria-hidden="true"></i> Daily Briefings
      </div>
    </div>
  </div>

  <div class="content-area">
    <div class="row g-4">
      <div class="col-lg-9">
        <div class="map-wrapper" aria-label="Incident Map" role="application">
          <div id="map" tabindex="0"></div>
        </div>

        <div class="stream-section">
          <div class="stream-header">

            <div class="stream-label">
              <i class="fas fa-circle live-dot-blue" aria-hidden="true"></i> Real-time Intelligence Stream
              <span class="live-box ms-2" id="feed-status-label" aria-live="polite">Connecting…</span>
            </div>
            <div class="stream-links" onclick="manualRefresh()" title="Refresh feed" aria-label="View full stream" style="cursor:pointer;color:#1a73e8;font-weight:800;font-size:0.8rem;" role="button" tabindex="0">
              VIEW FULL STREAM <span><i class="fas fa-arrow-right ms-1" aria-hidden="true"></i></span>
            </div>

          </div>

          <div class="critical-alert-bar" role="alert">
            <i class="fas fa-exclamation-triangle alert-icon-lg" aria-hidden="true"></i>
            <div class="alert-content-main" id="headline-alert">Loading headline…</div>
            <div class="alert-tags">
              <span class="tag" id="headline-sev">SEV?</span>
              <span class="tag tag-cat" id="headline-cat">CATEGORY</span>

              <span class="tag tag-reg" id="headline-reg">REGION</span>
            </div>
          </div>

          <div id="general-news-feed" aria-live="polite">
            <div style="padding:30px;text-align:center;color:#999;">Connecting to Secure Worker…</div>
          </div>
        </div>
      </div>

      <div class="col-lg-3 sidebar-col">

        <div class="side-card">
          <div class="card-label"><i class="fas fa-history" aria-hidden="true"></i> History Search</div>
          <div class="history-input-group">
            <label for="history-picker" class="form-label visually-hidden">History date</label>
            <i class="far fa-calendar-alt calendar-icon" aria-hidden="true"></i>
            <input type="date" class="history-input" id="history-picker" onchange="loadHistory(this.value)" aria-label="Select history date" aria-describedby="history-status" />
          </div>
          <div class="sub-text" id="history-status" aria-live="polite">Pick a date to load archived intelligence (simulated).</div>
        </div>


        <div class="side-card">
          <div class="card-label"><i class="fas fa-plane" aria-hidden="true"></i> Travel Safety Check</div>
          <label for="countrySelect" class="form-label visually-hidden">Travel country</label>
          <select class="travel-select" id="countrySelect" onchange="filterTravel()" aria-label="Travel country">
            <option selected disabled>Loading countries...</option>
          </select>
          <div id="travel-advisories" class="mt-3" aria-live="polite"></div>
          <div id="travel-news" class="mt-2"></div>
        </div>


        <div class="side-card" style="padding-bottom: 10px;">
          <div class="prox-header-row">
            <div>
              <div class="prox-dell-label">Dell Asset</div>
              <div class="prox-main-title">Proximity<br/>Alerts</div>
            </div>
          </div>
          <div class="prox-controls">

            <div class="prox-subtitle">WITHIN RADIUS</div>
            <label for="proxRadius" class="form-label visually-hidden">Proximity radius</label>
            <select id="proxRadius" class="radius-select" onchange="updateProximityRadius()" aria-label="Proximity radius">
              <option value="5">5 KM</option>
              <option value="10">10 KM</option>
              <option value="25">25 KM</option>
              <option value="50" selected>50 KM</option>
              <option value="100">100 KM</option>
              <option value="500">500 KM</option>
            </select>
          </div>

          <div id="proximity-alerts-container" aria-live="polite"></div>

          <div style="text-align: center;
            padding-top: 10px; border-top: 1px solid #f1f1f1;">
            <a href="#" onclick="manualRefresh();return false;" style="font-size: 0.75rem;
            font-weight: 700; color: #1a73e8; text-decoration: none;" role="button" tabindex="0">REFRESH ALERTS</a>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true" role="dialog" aria-labelledby="modalTitle">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle"><i class="fas fa-file-pdf me-2" style="color:#d93025;" aria-hidden="true"></i>Daily Intelligence Briefings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label" for="reportDate">Select Date</label>
          <input type="date" class="form-control" id="reportDate" />
          <div class="form-text" style="font-size:0.8rem;margin-top:6px;">
            Leave empty for the last 24 hours (live).
          </div>
        </div>

        <div class="mb-4">
          <label class="form-label" for="reportRegion">Select Region / Report Profile</label>
          <select class="form-select" id="reportRegion">
            <option value="Global">Global</option>
            <option value="APJC">APJC</option>
            <option value="India">India</option>
            <option value="Oceania">Oceania</option>
            <option value="Japan">Japan</option>
            <option value="South_Korea">South_Korea</option>
            <option value="SAEM">SAEM</option>
            <option value="Greater_China_HK">Greater_China_HK</option>
            <option value="Taiwan">Taiwan</option>
            <option value="Malaysia">Malaysia</option>
            <option value="Singapore">Singapore</option>
          </select>
        </div>

        <div class="d-grid gap-2" style="margin-bottom:8px;">
          <button class="btn-download" id="btn-preview" onclick="previewBriefing()" aria-label="Preview daily briefing">
            <i class="fas fa-eye me-2" aria-hidden="true"></i> Preview Briefing
          </button>
          <button class="btn-download" id="btn-download" onclick="downloadReport()" aria-label="Download briefing (generated)">
            <i class="fas fa-download me-2" aria-hidden="true"></i> Download Briefing
          </button>
        </div>

        <div id="preview-feedback" class="mt-3 text-center" style="font-size:0.85rem;display:none;" aria-live="polite"></div>
        <div id="briefing-preview" style="max-height:48vh; overflow:auto; margin-top:12px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- DEBUG OVERLAY CONTAINER -->
<div id="assets-debug" class="assets-debug" aria-live="polite" style="display:none"></div>

<script>
/* ===========================
   CONFIG
=========================== */
const WORKER_URL = "https://osinfohub.vssmaximus.workers.dev";
const AUTO_REFRESH_MS = 60_000;

/* DEBUG UI (overlay hidden unless enabled via ?debug=1 or localStorage flag) */
const DEBUG_UI = (new URLSearchParams(location.search).get('debug') === '1') || (localStorage.getItem('osinfohub_debug') === '1');

/* ===========================
   GITHUB SMARTTRAVELLER FALLBACK (simple)
=========================== */
const GITHUB_SMARTTRAVELLER_BASE_RAW = "https://raw.githubusercontent.com/kevle1/smartraveller-api/main";
const GITHUB_SMR_ADVISORIES_JSON = `${GITHUB_SMARTTRAVELLER_BASE_RAW}/data/advisories.json`;
const GITHUB_SMR_ADVISORIES_JSON_ALT = `${GITHUB_SMARTTRAVELLER_BASE_RAW}/advisories.json`;

/* ===========================
   STATIC COUNTRIES FALLBACK
=========================== */
const CONST_COUNTRIES = [
  "Afghanistan","Albania","Algeria","Andorra","Angola","Antigua and Barbuda","Argentina","Armenia","Australia","Austria","Azerbaijan",
  "Bahamas","Bahrain","Bangladesh","Barbados","Belarus","Belgium","Belize","Benin","Bhutan","Bolivia","Bosnia and Herzegovina","Botswana","Brazil","Brunei","Bulgaria","Burkina Faso","Burundi",
  "Cabo Verde","Cambodia","Cameroon","Canada","Central African Republic","Chad","Chile","China","Colombia","Comoros","Congo (DRC)","Congo (Republic)","Costa Rica","Croatia","Cuba","Cyprus","Czech Republic",
  "Denmark","Djibouti","Dominica","Dominican Republic",
  "Ecuador","Egypt","El Salvador","Equatorial Guinea","Eritrea","Estonia","Eswatini","Ethiopia",
  "Fiji","Finland","France",
  "Gabon","Gambia","Georgia","Germany","Ghana","Greece","Grenada","Guatemala","Guinea","Guinea-Bissau","Guyana",
  "Haiti","Honduras","Hungary",
  "Iceland","India","Indonesia","Iran","Iraq","Ireland","Israel","Italy",
  "Jamaica","Japan","Jordan",
  "Kazakhstan","Kenya","Kiribati","Kosovo","Kuwait","Kyrgyzstan",
  "Laos","Latvia","Lebanon","Lesotho","Liberia","Libya","Liechtenstein","Lithuania","Luxembourg",
  "Madagascar","Malawi","Malaysia","Maldives","Mali","Malta","Marshall Islands","Mauritania","Mauritius","Mexico","Micronesia","Moldova","Monaco","Mongolia","Montenegro","Morocco","Mozambique","Myanmar",
  "Namibia","Nauru","Nepal","Netherlands","New Zealand","Nicaragua","Niger","Nigeria","North Macedonia","Norway",
  "Oman",
  "Pakistan","Palau","Panama","Papua New Guinea","Paraguay","Peru","Philippines","Poland","Portugal",
  "Qatar",
  "Romania","Russia","Rwanda",
  "Saint Kitts and Nevis","Saint Lucia","Saint Vincent and the Grenadines","Samoa","San Marino","Sao Tome and Principe","Saudi Arabia","Senegal","Serbia","Seychelles","Sierra Leone","Singapore","Slovakia","Slovenia","Solomon Islands","Somalia","South Africa","South Korea","South Sudan","Spain","Sri Lanka","Sudan","Suriname","Sweden","Switzerland","Syria",
  "Taiwan","Tajikistan","Tanzania","Thailand","Timor-Leste","Togo","Tonga","Trinidad and Tobago","Tunisia","Turkey","Turkmenistan","Tuvalu",
  "Uganda","Ukraine","United Arab Emirates","United Kingdom","United States","Uruguay","Uzbekistan",
  "Vanuatu","Vatican City","Venezuela","Vietnam",
  "Yemen",
  "Zambia","Zimbabwe"
];

/* ===========================
   UI HELPERS
=========================== */
function fmt2(n){ return String(n).padStart(2,'0'); }
function isValidLatLng(lat, lon){
  return typeof lat === "number" && typeof lon === "number" && isFinite(lat) && isFinite(lon) && Math.abs(lat) <= 90 && Math.abs(lon) <= 180;
}
function htmlEscape(str){
  return String(str||"").replace(/[&<>'"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}
function safeId(s){ return String(s||"").replace(/[^\w\-]/g,'_'); }

/* ===========================
   DEBUG OVERLAY
=========================== */
function debugShow(obj){
  try{
    const box = document.getElementById('assets-debug');
    if(!box) return;
    if(!DEBUG_UI) { box.style.display='none'; return; }
    box.style.display='block';
    box.innerHTML = `<pre>${htmlEscape(JSON.stringify(obj,null,2))}</pre>`;
  }catch(e){}
}

/* ===========================
   CLOCKS
=========================== */
const CLOCKS = [
  { label: "Sydney", tz: "Australia/Sydney" },
  { label: "Singapore", tz: "Asia/Singapore" },
  { label: "Tokyo", tz: "Asia/Tokyo" },
  { label: "London", tz: "Europe/London" },
  { label: "New York", tz: "America/New_York" }
];

function buildClocks(){
  const wrap = document.getElementById("multi-clock-container");
  if(!wrap) return;
  wrap.innerHTML = "";
  for(const c of CLOCKS){
    const div = document.createElement("div");
    div.className = "clock-box";
    div.innerHTML = `
      <div class="clock-label">${htmlEscape(c.label)}</div>
      <span class="clock-val" id="clock-${safeId(c.label)}">--:--</span>
    `;
    wrap.appendChild(div);
  }
}
function updateClocks(){
  for(const c of CLOCKS){
    const el = document.getElementById(`clock-${safeId(c.label)}`);
    if(!el) continue;
    try{
      const dt = new Date();
      const opts = { hour:'2-digit', minute:'2-digit', hour12:false, timeZone: c.tz };
      const t = new Intl.DateTimeFormat([], opts).format(dt);
      el.textContent = t;
    }catch(e){
      el.textContent = "--:--";
    }
  }
}
buildClocks();
updateClocks();
setInterval(updateClocks, 1000);

/* ===========================
   LEAFLET MAP
=========================== */
let map, incidentLayer, clusterGroup;
let currentIncidents = [];
let currentRegion = "Global";

function initMap(){
  map = L.map('map', { worldCopyJump: true }).setView([20, 0], 2);

  L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
    attribution: '&copy; OpenStreetMap &copy; CARTO'
  }).addTo(map);

  clusterGroup = L.markerClusterGroup({
    showCoverageOnHover: false,
    spiderfyOnMaxZoom: true,
    removeOutsideVisibleBounds: true,
    maxClusterRadius: 55,
    iconCreateFunction: function(cluster){
      const count = cluster.getChildCount();
      let cls = "cluster-blue";
      if(count >= 20) cls = "cluster-red";
      else if(count >= 10) cls = "cluster-amber";
      const size = count >= 20 ? 50 : (count >= 10 ? 44 : 38);
      return L.divIcon({
        html: `<div class="cluster-icon ${cls}" style="width:${size}px;height:${size}px;" tabindex="0" role="button" aria-label="Cluster with ${count} incidents"><span class="cluster-count" aria-hidden="true">${count}</span></div>`,
        className: "",
        iconSize: [size, size]
      });
    }
  });

  incidentLayer = L.layerGroup().addTo(map);
  map.addLayer(clusterGroup);

  map.on('focus', function(){});
}
initMap();

/* ===========================
   REGION FILTER TABS
=========================== */
function filterNews(region){
  currentRegion = region;
  document.querySelectorAll('.nav-item-custom').forEach(a=>{
    a.classList.remove('active');
    a.setAttribute('aria-selected','false');
  });
  const match = Array.from(document.querySelectorAll('.nav-item-custom')).find(a=>a.textContent.trim()===region);
  if(match){
    match.classList.add('active');
    match.setAttribute('aria-selected','true');
  }
  renderFeed(currentIncidents);
  plotIncidents(currentIncidents);
}

/* ===========================
   FETCH + RENDER FEED
=========================== */
async function fetchIncidents(){
  const url = `${WORKER_URL}/api/incidents`;
  const res = await fetch(url);
  if(!res.ok) throw new Error("bad_res");
  const j = await res.json();
  return j;
}

function setFeedStatus(text){
  const el = document.getElementById('feed-status-label');
  if(el) el.textContent = text;
}

function determineTagClass(sev){
  const s = String(sev||"").toLowerCase();
  if(s.includes("crit")) return "ftag-crit";
  if(s.includes("high")) return "ftag-crit";
  if(s.includes("med")) return "ftag-warn";
  if(s.includes("warn")) return "ftag-warn";
  return "ftag-info";
}

function isInRegion(inc, region){
  if(region === "Global") return true;
  const r = String(inc.region||"").toUpperCase();
  if(region === "AMER") return r.includes("AMER");
  if(region === "EMEA") return r.includes("EMEA");
  if(region === "APJC") return r.includes("APJC") || r.includes("APAC");
  if(region === "LATAM") return r.includes("LATAM");
  return true;
}

function renderHeadline(incs){
  const hl = document.getElementById("headline-alert");
  const sev = document.getElementById("headline-sev");
  const cat = document.getElementById("headline-cat");
  const reg = document.getElementById("headline-reg");
  if(!hl || !sev || !cat || !reg) return;

  const best = (incs||[]).slice().sort((a,b)=>{
    const as = String(a.severity||"").toLowerCase();
    const bs = String(b.severity||"").toLowerCase();
    const score = s => (s.includes("crit")||s.includes("high"))?3:(s.includes("med")||s.includes("warn"))?2:1;
    return score(bs) - score(as);
  })[0];

  if(!best){
    hl.textContent = "No critical items.";
    sev.textContent = "OK";
    cat.textContent = "N/A";
    reg.textContent = currentRegion;
    return;
  }

  hl.textContent = best.title || best.summary || "Headline update";
  sev.textContent = String(best.severity||"INFO").toUpperCase();
  cat.textContent = String(best.category||"GENERAL").toUpperCase();
  reg.textContent = String(best.region||currentRegion).toUpperCase();

  sev.className = "tag " + (String(best.severity||"").toLowerCase().includes("crit") ? "tag-crit" : "tag-cat");
}

function renderFeed(incs){
  const wrap = document.getElementById("general-news-feed");
  if(!wrap) return;

  const filtered = (incs||[]).filter(x=>isInRegion(x, currentRegion));

  renderHeadline(filtered);

  if(!filtered.length){
    wrap.innerHTML = `<div style="padding:30px;text-align:center;color:#777;">No incidents for ${htmlEscape(currentRegion)}.</div>`;
    return;
  }

  wrap.innerHTML = filtered.map(inc=>{
    const sev = String(inc.severity||"INFO");
    const tagCls = determineTagClass(sev);
    const type = htmlEscape(String(inc.category||"General"));
    const loc = htmlEscape(String(inc.location||inc.country||""));
    const region = htmlEscape(String(inc.region||"Global"));
    const title = htmlEscape(String(inc.title||inc.summary||"Update"));
    const meta = htmlEscape(String(inc.source||"") + (inc.time ? (" • " + new Date(inc.time).toLocaleString()) : ""));
    const desc = htmlEscape(String(inc.description||inc.details||""));

    return `
      <a class="feed-card" href="#" onclick="openIncident('${htmlEscape(String(inc.id||''))}');return false;">
        <div class="feed-status-bar ${tagCls.replace('ftag','status-bar')}"></div>
        <div class="feed-content">
          <div class="feed-tags">
            <span class="ftag ${tagCls}">${htmlEscape(sev)}</span>
            <span class="ftag ftag-type">${type}</span>
            ${loc ? `<span class="ftag ftag-loc">${loc}</span>` : ``}
            <div class="feed-region">${region}</div>
          </div>
          <div class="feed-title">${title}</div>
          <div class="feed-meta">${meta}</div>
          <div class="feed-desc">${desc}</div>
        </div>
      </a>
    `;
  }).join("");
}

/* ===========================
   INCIDENT DETAILS (basic)
=========================== */
function openIncident(id){
  const inc = currentIncidents.find(x=>String(x.id)===String(id));
  if(!inc) return;
  if(inc.lat && inc.lon){
    try{ map.setView([inc.lat, inc.lon], 6, { animate:true }); }catch(e){}
  }
}

/* ===========================
   PLOT MAP
=========================== */
function plotIncidents(incs){
  try{
    clusterGroup.clearLayers();
    incidentLayer.clearLayers();
  }catch(e){}

  const filtered = (incs||[]).filter(x=>isInRegion(x, currentRegion));
  for(const inc of filtered){
    if(!isValidLatLng(inc.lat, inc.lon)) continue;
    const color = (String(inc.severity||"").toLowerCase().includes("crit")||String(inc.severity||"").toLowerCase().includes("high")) ? "#d93025"
                : (String(inc.severity||"").toLowerCase().includes("med")||String(inc.severity||"").toLowerCase().includes("warn")) ? "#f9ab00"
                : "#1a73e8";

    const iconHtml = `
      <div class="incident-dot" style="background:${color};"></div>
    `;
    const icon = L.divIcon({ html: iconHtml, className: "", iconSize:[16,16] });

    const marker = L.marker([inc.lat, inc.lon], { icon });
    marker.bindTooltip(htmlEscape(inc.title||inc.summary||"Incident"), { className:"map-tooltip", direction:"top" });
    marker.on('click', ()=>openIncident(inc.id));
    clusterGroup.addLayer(marker);
  }
}

/* ===========================
   TRAVEL SAFETY (COUNTRY SELECT)
=========================== */
function buildCountryList(list){
  const sel = document.getElementById("countrySelect");
  if(!sel) return;
  sel.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.disabled = true;
  opt0.selected = true;
  opt0.textContent = "Select a country...";
  sel.appendChild(opt0);

  for(const c of list){
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    sel.appendChild(opt);
  }
}

async function fetchCountries(){
  try{
    const res = await fetch(`${WORKER_URL}/api/travel/countries`);
    if(!res.ok) throw new Error("bad");
    const j = await res.json();
    if(Array.isArray(j.countries) && j.countries.length) return j.countries;
  }catch(e){}
  return CONST_COUNTRIES;
}

async function fetchAdvisory(country){
  try{
    const res = await fetch(`${WORKER_URL}/api/travel/advisory?country=${encodeURIComponent(country)}`);
    if(!res.ok) throw new Error("bad");
    return await res.json();
  }catch(e){
    return null;
  }
}

function advisoryLevelStyle(level){
  const n = Number(level||1);
  if(n >= 4) return { label:"DO NOT TRAVEL", bg:"#d93025" };
  if(n === 3) return { label:"RECONSIDER", bg:"#e37400" };
  if(n === 2) return { label:"CAUTION", bg:"#1a73e8" };
  return { label:"NORMAL", bg:"#1e8e3e" };
}

async function filterTravel(){
  const countrySelect = document.getElementById("countrySelect");
  if (!countrySelect) return;
  const country = countrySelect.value;
  const box = document.getElementById("travel-advisories");
  if(!box) return;

  box.innerHTML = `<div style="color:#777;font-weight:600;">Loading advisory…</div>`;

  const adv = await fetchAdvisory(country);
  if(!adv || !adv.country){
    box.innerHTML = `<div class="safe-box"><i class="fas fa-check-circle safe-icon" aria-hidden="true"></i><div class="safe-text">No advisory found for ${htmlEscape(country)}.</div></div>`;
    return;
  }

  const level = advisoryLevelStyle(adv.level);
  box.innerHTML = `
    <div class="advisory-box">
      <div class="advisory-header">
        <div class="advisory-label">OFFICIAL TRAVEL ADVISORY</div>
        <div class="advisory-level-badge" style="background:${level.bg};">${htmlEscape(level.label)}</div>
      </div>
      <div class="advisory-text">${htmlEscape(adv.text||"")}</div>
      <div class="advisory-updated">Updated: ${htmlEscape(adv.updated||"")}</div>
    </div>
  `;
}

/* ===========================
   PROXIMITY ALERTS
=========================== */
let proximityRadiusKm = 50;

function updateProximityRadius(){
  const sel = document.getElementById("proxRadius");
  if(!sel) return;
  proximityRadiusKm = Number(sel.value || 50);
  loadProximityAlerts();
}

async function fetchProximity(){
  const res = await fetch(`${WORKER_URL}/api/proximity`);
  if(!res.ok) throw new Error("bad_prox");
  return await res.json();
}

function severityIcon(sev){
  const s = String(sev||"").toLowerCase();
  if(s.includes("crit") || s.includes("high")) return { icon:"fa-triangle-exclamation", color:"#d93025" };
  if(s.includes("med") || s.includes("warn")) return { icon:"fa-circle-exclamation", color:"#f9ab00" };
  return { icon:"fa-circle-info", color:"#1a73e8" };
}

async function loadProximityAlerts(){
  const wrap = document.getElementById("proximity-alerts-container");
  if(!wrap) return;

  wrap.innerHTML = `<div style="padding:10px 0;color:#777;font-weight:600;">Loading proximity alerts…</div>`;
  try{
    const j = await fetchProximity();
    const items = Array.isArray(j.alerts) ? j.alerts : [];
    const filtered = items.filter(a => Number(a.distance_km||999999) <= proximityRadiusKm);

    if(!filtered.length){
      wrap.innerHTML = `<div class="safe-box"><i class="fas fa-check-circle safe-icon" aria-hidden="true"></i><div class="safe-text">No alerts within ${htmlEscape(String(proximityRadiusKm))} KM.</div></div>`;
      return;
    }

    wrap.innerHTML = filtered.map(a=>{
      const icon = severityIcon(a.severity);
      return `
        <div class="alert-row">
          <div class="alert-top">
            <div class="alert-type"><i class="fas ${icon.icon}" style="color:${icon.color};" aria-hidden="true"></i> ${htmlEscape(a.type||"Alert")}</div>
            <div class="alert-dist">${htmlEscape(String(Math.round(Number(a.distance_km||0))))} KM</div>
          </div>
          <div class="alert-site"><i class="fas fa-location-dot" aria-hidden="true"></i> ${htmlEscape(a.site||"")}</div>
          <div class="alert-desc">${htmlEscape(a.description||"")}</div>
        </div>
      `;
    }).join("");
  }catch(e){
    wrap.innerHTML = `<div style="color:#d93025;font-weight:700;">Failed to load proximity alerts.</div>`;
  }
}

/* ===========================
   HISTORY
=========================== */
async function loadHistory(dateStr){
  const status = document.getElementById("history-status");
  if(status) status.textContent = "Loading history…";
  try{
    const res = await fetch(`${WORKER_URL}/api/history?date=${encodeURIComponent(dateStr)}`);
    if(!res.ok) throw new Error("bad_hist");
    const j = await res.json();
    currentIncidents = Array.isArray(j.incidents) ? j.incidents : [];
    renderFeed(currentIncidents);
    plotIncidents(currentIncidents);
    if(status) status.textContent = `Loaded ${currentIncidents.length} archived items for ${dateStr}.`;
  }catch(e){
    if(status) status.textContent = "History load failed.";
  }
}

/* ===========================
   DAILY BRIEFINGS (PREVIEW/DOWNLOAD)
=========================== */
async function previewBriefing(){
  const date = document.getElementById("reportDate")?.value || "";
  const region = document.getElementById("reportRegion")?.value || "Global";
  const fb = document.getElementById("preview-feedback");
  const box = document.getElementById("briefing-preview");
  if(fb){ fb.style.display = "block"; fb.textContent = "Generating preview…"; }
  if(box) box.innerHTML = "";

  try{
    const res = await fetch(`${WORKER_URL}/api/briefing/preview?region=${encodeURIComponent(region)}&date=${encodeURIComponent(date)}`);
    if(!res.ok) throw new Error("bad_preview");
    const j = await res.json();
    if(box) box.innerHTML = `<div style="font-size:0.85rem;line-height:1.45;color:#333;">${htmlEscape(j.preview || "No preview text.")}</div>`;
    if(fb) fb.textContent = "Preview ready.";
  }catch(e){
    if(fb) fb.textContent = "Preview failed.";
  }
}

async function downloadReport(){
  const date = document.getElementById("reportDate")?.value || "";
  const region = document.getElementById("reportRegion")?.value || "Global";
  const fb = document.getElementById("preview-feedback");
  if(fb){ fb.style.display = "block"; fb.textContent = "Generating briefing…"; }

  try{
    const res = await fetch(`${WORKER_URL}/api/briefing/pdf?region=${encodeURIComponent(region)}&date=${encodeURIComponent(date)}`);
    if(!res.ok) throw new Error("bad_pdf");
    const blob = await res.blob();
    const a = document.createElement("a");
    const url = URL.createObjectURL(blob);
    a.href = url;
    a.download = `OS_INFOHUB_${region}_${date||"latest"}.pdf`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    if(fb) fb.textContent = "Download started.";
  }catch(e){
    if(fb) fb.textContent = "Download failed.";
  }
}

/* ===========================
   REFRESH LOOP
=========================== */
async function refreshAll(){
  setFeedStatus("Updating…");
  try{
    const j = await fetchIncidents();
    currentIncidents = Array.isArray(j.incidents) ? j.incidents : (Array.isArray(j) ? j : []);
    renderFeed(currentIncidents);
    plotIncidents(currentIncidents);
    setFeedStatus("Live");
    debugShow({ ok:true, count: currentIncidents.length });
  }catch(e){
    setFeedStatus("Error");
    debugShow({ ok:false, error: String(e?.message||e) });
  }
  try{ await loadProximityAlerts(); }catch(e){}
}

async function manualRefresh(){
  await refreshAll();
}

/* init travel list and initial refresh */
(async ()=>{
  const list = await fetchCountries();
  buildCountryList(list);
  await refreshAll();
  setInterval(refreshAll, AUTO_REFRESH_MS);
})();
</script>

</body>
</html>
