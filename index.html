<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dell OS | INFOHUB </title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    /* ... (same CSS as before) ... */
    /* Keep all your existing CSS exactly as before; omitted here for brevity */
  </style>
</head>

<body>
<div class="app-container">
  <!-- Full markup unchanged; omitted here for brevity (same as your file) -->
  <!-- Keep all HTML exactly as before — header, map, feed, sidebar, modal -->
</div>

<!-- Modal and script sections — full JS follows -->
<script>
/* ===========================
   CONFIG
=========================== */
const WORKER_URL = "https://osinfohub.vssmaximus.workers.dev";
const AUTO_REFRESH_MS = 60_000;

/* ===========================
   DATA STATE
=========================== */
let INCIDENTS = [];
let FEED_IS_LIVE = false;
let currentRadius = 50;

let TRAVEL_DATA = [];
let TRAVEL_UPDATED_AT = null;

let map;
let layerGroup;
let incidentLayerGroup;

/* ===========================
   DELL SITES (unchanged)
   Keep your full DELL_SITES array exactly as you had it.
=========================== */
const DELL_SITES = [
  /* ... full list unchanged ... */
];

/* build ASSETS (unchanged) */
const ASSETS = {};
DELL_SITES.forEach(s => {
  const key = s.name.toLowerCase();
  ASSETS[key] = { lat: s.lat, lng: s.lng, region: s.region };
});

/* ===========================
   INIT
=========================== */
document.addEventListener("DOMContentLoaded", async () => {
  initMap();
  startClock();

  await loadFromWorker();           // incidents
  filterNews("Global");             // initial render

  await loadTravelAdvisories();     // robust live advisories loader
  setTimeout(loadTravelAdvisories, 2500);

  setInterval(async () => {
    await loadFromWorker(true);
    const active = document.querySelector(".nav-item-custom.active");
    filterNews(active ? active.innerText.trim() : "Global");
  }, AUTO_REFRESH_MS);
});

/* ===========================
   CLOCK / MAP / FEED etc.
   (All your existing functions remain exactly as before.)
   I'm only showing the travel-related functions in full below.
=========================== */

/* ===========================
   TRAVEL ADVISORIES (REAL) - FRONTEND
   - loadTravelAdvisories: now calls worker /live endpoint first
   - filterTravel: groups CRITICAL/HIGH/MEDIUM (last 72h)
=========================== */

/* Local fallback kept (small) */
const LOCAL_FALLBACK = [
  { country: "Afghanistan", level: 4, text: "Do Not Travel." },
  { country: "Australia", level: 1, text: "Exercise normal precautions." },
  { country: "Brazil", level: 2, text: "Exercise increased caution." },
  { country: "Canada", level: 1, text: "Exercise normal precautions." },
  { country: "China", level: 3, text: "Reconsider travel." },
  { country: "India", level: 2, text: "Exercise increased caution." },
  { country: "United States", level: 1, text: "Exercise normal precautions." }
];

async function loadTravelAdvisories() {
  const sel = document.getElementById("countrySelect");
  if (!sel) return;

  sel.innerHTML = `<option selected disabled>Loading countries...</option>`;
  TRAVEL_DATA = [];
  TRAVEL_UPDATED_AT = null;

  function populateDropdown(list, updated_at = null) {
    if (!Array.isArray(list) || list.length === 0) return false;
    TRAVEL_DATA = list;
    TRAVEL_UPDATED_AT = updated_at || null;
    TRAVEL_DATA.sort((a,b) => (String(a.country || "").localeCompare(String(b.country || ""))));
    sel.innerHTML = `<option selected disabled>Select Country...</option>`;
    TRAVEL_DATA.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.country;
      opt.innerText = c.country;
      sel.appendChild(opt);
    });
    return true;
  }

  // 1) Try the worker's LIVE endpoint (this forces a live fetch from travel-advisory.info)
  try {
    console.log("[travel] Requesting worker /live advisories...");
    const r = await fetch(`${WORKER_URL}/api/traveladvisories/live`, { cache: "no-store" });
    if (r.ok) {
      const j = await r.json();
      const list = Array.isArray(j.advisories) ? j.advisories : [];
      if (list.length > 0) {
        console.log("[travel] worker /live returned advisories:", list.length);
        populateDropdown(list, j.updated_at || null);
        return;
      } else {
        console.warn("[travel] worker /live returned empty list");
      }
    } else {
      console.warn("[travel] worker /live returned non-ok:", r.status);
    }
  } catch (e) {
    console.warn("[travel] worker /live fetch failed:", e && e.message ? e.message : e);
  }

  // 2) Try the worker's cached endpoint (this is fast, and worker tries to refresh automatically)
  try {
    console.log("[travel] Requesting worker cached advisories...");
    const r2 = await fetch(`${WORKER_URL}/api/traveladvisories?ts=${Date.now()}`, { cache: "no-store" });
    if (r2.ok) {
      const j2 = await r2.json();
      const list = Array.isArray(j2.advisories) ? j2.advisories : [];
      if (list.length > 50) {
        console.log("[travel] worker cached returned full list:", list.length);
        populateDropdown(list, j2.updated_at || j2.cached_at || null);
        return;
      }
      if (list.length >= 20) {
        console.log("[travel] worker cached returned partial list >=20:", list.length);
        populateDropdown(list, j2.updated_at || j2.cached_at || null);
        return;
      }
      console.warn("[travel] worker cached list small:", list.length);
    } else {
      console.warn("[travel] worker cached returned non-ok:", r2.status);
    }
  } catch (we) {
    console.warn("[travel] worker cached fetch failed:", we && we.message ? we.message : we);
  }

  // 3) Try the official API directly (browser-side). If browser blocks CORS, this may fail.
  try {
    console.log("[travel] Falling back to direct travel-advisory.info fetch...");
    const r3 = await fetch("https://www.travel-advisory.info/api", { cache: "no-store" });
    if (r3.ok) {
      const j3 = await r3.json();
      const advs = [];
      if (j3 && j3.data) {
        for (const [code, entry] of Object.entries(j3.data)) {
          if (!entry || !entry.name || !entry.advisory) continue;
          const score = Number(entry.advisory.score);
          const msg = String(entry.advisory.message || "").trim();
          let level = 1;
          if (score >= 3.5) level = 4;
          else if (score >= 2.5) level = 3;
          else if (score >= 1.5) level = 2;
          advs.push({
            code,
            country: entry.name,
            score: Number.isFinite(score) ? score : null,
            level,
            text: msg || `Risk score: ${Number.isFinite(score) ? score : "N/A"}`
          });
        }
      }
      if (advs.length > 0) {
        console.log("[travel] Direct API returned advisories:", advs.length);
        populateDropdown(advs, new Date().toISOString());
        return;
      }
      console.warn("[travel] Direct API returned empty advisories");
    } else {
      console.warn("[travel] Direct API fetch returned non-ok:", r3.status);
    }
  } catch (fe) {
    console.warn("[travel] Direct API fetch failed:", fe && fe.message ? fe.message : fe);
  }

  // 4) Last resort: local small fallback
  console.warn("[travel] Using local fallback list");
  populateDropdown(LOCAL_FALLBACK, null);
}

async function filterTravel() {
  const country = document.getElementById("countrySelect").value;
  const advContainer = document.getElementById("travel-advisories");
  const newsContainer = document.getElementById("travel-news");
  if (!country || !advContainer || !newsContainer) return;

  advContainer.innerHTML = `<div style="padding:14px;text-align:center;color:#5f6368;">Loading advisory…</div>`;
  newsContainer.innerHTML = ``;

  try {
    const res = await fetch(`${WORKER_URL}/api/traveladvisories?country=${encodeURIComponent(country)}`, { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const json = await res.json();

    const advisory = json.advisory || { country, level: 1, text: "No advisory text available", previous_level: null, changed: false };
    const recent = Array.isArray(json.recent_incidents) ? json.recent_incidents : [];

    const level = Number(advisory.level || 1);
    let advColor = "#1a73e8", advBg = "#e8f0fe", advBorder = "#d2e3fc", levelText = "LEVEL 1";
    if (level === 2) { advColor="#f9ab00"; advBg="#fef7e0"; advBorder="#feebc8"; levelText="LEVEL 2"; }
    else if (level === 3) { advColor="#e37400"; advBg="#fff5e5"; advBorder="#ffdecb"; levelText="LEVEL 3"; }
    else if (level === 4) { advColor="#d93025"; advBg="#fce8e6"; advBorder="#fad2cf"; levelText="LEVEL 4"; }

    const updated = advisory.updated_at || json.cached_at || "Unknown";

    // Advisory box with change note
    let changedNote = "";
    if (advisory.changed) {
      const prev = advisory.previous_level ? `Level ${advisory.previous_level}` : "Unknown";
      changedNote = `<div style="margin-top:8px;font-weight:700;color:#b2281d;">Level changed: ${prev} → LEVEL ${advisory.level}</div>`;
    }

    advContainer.innerHTML = `
      <div class="advisory-box" style="background:${advBg};border-color:${advBorder}">
        <div class="advisory-header">
          <span class="advisory-label">OFFICIAL TRAVEL RISK (LIVE)</span>
          <span class="advisory-level-badge" style="background:${advColor}">${levelText}</span>
        </div>
        <div class="advisory-text">${escapeHtml(advisory.text || "")}</div>
        <div class="advisory-updated">Updated: ${escapeHtml(updated)}</div>
        ${changedNote}
      </div>`;

    // Next-level activities (unchanged static mapping)
    const nextLevel = Math.min(level + 1, 4);
    const nextActivities = {
      1: [
        "Exercise normal precautions.",
        "Monitor local news and standard safety guidance.",
        "Maintain awareness in crowded places."
      ],
      2: [
        "Exercise increased caution for crime/transport.",
        "Avoid poorly lit or unfamiliar neighborhoods at night.",
        "Consider travel insurance / register with embassy if traveling."
      ],
      3: [
        "Reconsider non-essential travel to affected regions.",
        "Avoid demonstrations, large gatherings and areas with security operations.",
        "Be prepared for disrupted services and heightened police presence."
      ],
      4: [
        "Do not travel.",
        "Prepare evacuation/contingency plans.",
        "Expect major transport, border, and service disruptions."
      ]
    };

    let activitiesHtml = `<div class="news-box-alert"><div class="news-box-header">IF LEVEL UPGRADES TO LEVEL ${nextLevel}</div><div style="padding:10px">`;
    (nextActivities[nextLevel] || []).forEach(a => {
      activitiesHtml += `<div style="margin-bottom:6px;">&bull;&nbsp;${escapeHtml(a)}</div>`;
    });
    activitiesHtml += `</div></div>`;

    // Partition recent incidents into CRITICAL (>=5), HIGH (4) and MEDIUM (3)
    const critical = [];
    const high = [];
    const medium = [];
    const seenIds = new Set();

    recent.forEach(n => {
      const sevNum = Number(n.severity || 0);
      const sevText = String(n.severity_label || "").toUpperCase();
      const id = n.id || (n.title + '|' + (n.time||''));
      if (seenIds.has(id)) return;
      if (sevNum >= 5 || sevText === "CRITICAL" || sevText === "EXTRA HIGH") {
        critical.push(n);
        seenIds.add(id);
      } else if ( (sevNum === 4) || (sevText === "HIGH") ) {
        high.push(n);
        seenIds.add(id);
      } else if ( (sevNum === 3) || (sevText === "MEDIUM") ) {
        medium.push(n);
        seenIds.add(id);
      }
    });

    // Render panels: CRITICAL, HIGH, MEDIUM, then activities
    let newsHtml = "";

    if (critical.length > 0) {
      newsHtml += `<div class="news-box-alert"><div class="news-box-header">CRITICAL / EXTRA-HIGH INCIDENTS (LAST 72H)</div>`;
      critical.forEach(n => {
        const when = (n.time) ? new Date(n.time).toLocaleString() : "Recently";
        const sevLabel = n.severity_label || (n.severity ? ("SEV " + n.severity) : "CRITICAL");
        newsHtml += `
          <div class="news-box-item">
            <div class="news-box-title">${escapeHtml(n.title || "(No title)")}</div>
            <div class="news-box-summary" style="font-size:0.8rem;color:#5f6368;">${escapeHtml(n.summary || "")}</div>
            <div style="font-size:0.75rem;color:#9aa0a6;margin-top:6px;">${escapeHtml(sevLabel)} • ${escapeHtml(when)}</div>
          </div>`;
      });
      newsHtml += `</div>`;
    }

    if (high.length > 0) {
      newsHtml += `<div class="news-box-alert"><div class="news-box-header">HIGH-SEVERITY INCIDENTS (LAST 72H)</div>`;
      high.forEach(n => {
        const when = (n.time) ? new Date(n.time).toLocaleString() : "Recently";
        const sevLabel = n.severity_label || (n.severity ? ("SEV " + n.severity) : "HIGH");
        newsHtml += `
          <div class="news-box-item">
            <div class="news-box-title">${escapeHtml(n.title || "(No title)")}</div>
            <div class="news-box-summary" style="font-size:0.8rem;color:#5f6368;">${escapeHtml(n.summary || "")}</div>
            <div style="font-size:0.75rem;color:#9aa0a6;margin-top:6px;">${escapeHtml(sevLabel)} • ${escapeHtml(when)}</div>
          </div>`;
      });
      newsHtml += `</div>`;
    }

    if (medium.length > 0) {
      newsHtml += `<div class="news-box-alert"><div class="news-box-header">MEDIUM-SEVERITY INCIDENTS (LAST 72H)</div>`;
      medium.forEach(n => {
        const when = (n.time) ? new Date(n.time).toLocaleString() : "Recently";
        const sevLabel = n.severity_label || (n.severity ? ("SEV " + n.severity) : "MEDIUM");
        newsHtml += `
          <div class="news-box-item">
            <div class="news-box-title">${escapeHtml(n.title || "(No title)")}</div>
            <div class="news-box-summary" style="font-size:0.8rem;color:#5f6368;">${escapeHtml(n.summary || "")}</div>
            <div style="font-size:0.75rem;color:#9aa0a6;margin-top:6px;">${escapeHtml(sevLabel)} • ${escapeHtml(when)}</div>
          </div>`;
      });
      newsHtml += `</div>`;
    }

    if (!newsHtml) {
      newsContainer.innerHTML = `
        <div class="safe-box">
          <i class="fas fa-check-circle safe-icon"></i>
          <div style="font-size:0.9rem;">
            <div style="font-weight:700;">No high-severity incidents in the last 72 hours</div>
            <div style="margin-top:6px;">${activitiesHtml}</div>
          </div>
        </div>`;
    } else {
      newsContainer.innerHTML = newsHtml + activitiesHtml;
    }
  } catch (e) {
    advContainer.innerHTML = `
      <div class="safe-box">
        <i class="fas fa-info-circle safe-icon" style="color:#1a73e8;"></i>
        <div class="safe-text" style="color:#174ea6;">
          Advisory information unavailable for ${escapeHtml(country)}.
        </div>
      </div>`;
    newsContainer.innerHTML = "";
  }
}

/* ===========================
   (Other helper functions unchanged: loadFromWorker, map rendering, helpers)
   Keep these functions identical to your original file.
   Ensure you keep the Dell sites, scoring, and ingestion unchanged.
=========================== */

/* ===========================
   HELPERS (escapeHtml, safeTime, etc.)
=========================== */
function escapeHtml(s) {
  return String(s || "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}
function escapeAttr(s) {
  return escapeHtml(s).replaceAll("`", "&#096;");
}
</script>
</body>
</html>
