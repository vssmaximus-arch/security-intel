<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OS | INFOHUB</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    :root { --dell-blue: #0076CE; --bg-dark: #0f1115; }
    body { background-color: var(--bg-dark); font-family: 'Inter', sans-serif; padding: 24px; color: #333; }

    /* INCIDENT SEVERITY (TEXT) */
    .sev-CRITICAL { background-color: #ef4444; color: #fff; border-color:#ef4444; }
    .sev-HIGH { background-color: #f97316; color: #fff; border-color:#f97316; }
    .sev-MODERATE { background-color: #eab308; color: #000; border-color:#eab308; }
    .sev-LOW { background-color: #1a73e8; color: #fff; border-color:#1a73e8; }
    .sev-UNKNOWN { background-color: #64748b; color: #fff; border-color:#64748b; }

    .app-container { background-color: #fff; border-radius: 24px; min-height: 92vh; padding: 0; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .header-container { padding: 15px 32px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f0f0f0; height: 70px; }
    .header-left { display: flex; align-items: center; height: 100%; }
    .logo-icon { font-size: 1.6rem; color: #1a73e8; display: flex; align-items: center; }
    .logo-text { font-size: 1.2rem; font-weight: 800; color: #202124; letter-spacing: -0.5px; margin-left: 12px; line-height: 1; padding-top: 2px; }
    .logo-text span { color: var(--dell-blue); }
    .header-right { display: flex; align-items: center; gap: 20px; }
    .nav-pills-custom { background-color: #f1f3f4; padding: 4px; border-radius: 10px; display: flex; gap: 2px; }
    .nav-item-custom { padding: 7px 18px; border-radius: 8px; font-weight: 700; font-size: 0.8rem; color: #5f6368; cursor: pointer; text-decoration: none; text-transform: uppercase; transition: 0.2s; }
    .nav-item-custom.active, .nav-item-custom:hover { background-color: #202124; color: #fff; }
    .btn-daily { background-color: #1a73e8; color: white; padding: 9px 18px; border-radius: 8px; font-weight: 600; font-size: 0.85rem; cursor: pointer; display: flex; gap:8px; align-items: center; }
    .content-area { padding: 30px; flex: 1; }
    .map-wrapper { position: relative; border-radius: 16px; overflow: hidden; height: 520px; background: #eef2f6; border:1px solid #e0e0e0; }
    #map { width: 100%; height: 100%; z-index: 1; }
    .sidebar-col { display: flex; flex-direction: column; gap: 24px; }
    .side-card { background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.02); }
    .card-label { font-size: 0.95rem; font-weight: 700; color: #202124; margin-bottom: 12px; display: flex; align-items: center; gap: 10px; }
    .history-input-group { position: relative; }
    .history-input { width: 100%; padding: 10px 10px 10px 40px; border: 1px solid #dadce0; border-radius: 8px; font-size: 0.9rem; }
    .calendar-icon { position: absolute; left: 12px; top: 12px; color: #5f6368; }
    .travel-select { width: 100%; padding: 10px 12px; border: 1px solid #dadce0; border-radius: 8px; font-size: 0.9rem; }
    #proximity-alerts-container { max-height: 400px; overflow-y: auto; }
    .stream-section { margin-top: 25px; flex-grow: 1; display: flex; flex-direction: column; }

    /* FEED CARDS */
    .feed-card { background: #fff; border-radius: 10px; border: 1px solid #e0e0e0; margin-bottom: 15px; display: block; overflow: hidden; text-decoration: none; color: inherit; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s; }
    .feed-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
    .feed-status-bar { width: 6px; flex-shrink: 0; }
    .feed-content { padding: 18px 24px; width: 100%; }
    .feed-tags { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
    .ftag { font-size: 0.7rem; font-weight: 800; padding: 4px 10px; border-radius: 4px; text-transform: uppercase; border: 1px solid #eee; letter-spacing: 0.5px; }
    .ftag-loc { background: #202124; color: white; border-color: #202124; }
    .feed-title { font-size: 1.1rem; font-weight: 700; color: #202124; margin-bottom: 8px; line-height: 1.4; }
    .feed-desc { font-size: 0.9rem; color: #4b4f56; line-height: 1.6; margin-bottom: 10px; }
    .feed-meta { font-size: 0.8rem; color: #5f6368; display: flex; justify-content: space-between; align-items: center; }

    .loading-text { text-align: center; padding: 40px; color: #5f6368; font-weight: 500; }

    /* MAP MARKERS */
    .custom-div-icon { background: transparent; border: none; }
    .marker-pin-dell {
      width: 30px; height: 30px; border-radius: 10px;
      background: var(--dell-blue); color: #fff;
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.35);
      border: 2px solid #fff;
    }

    /* Travel Advisory */
    .advisory-box { border-radius: 8px; padding: 12px; margin-top: 15px; border: 1px solid #ddd; }
    .advisory-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .advisory-label { font-size: 0.7rem; font-weight: 800; color: #5f6368; letter-spacing: 0.5px; }
    .advisory-level-badge { font-size: 0.7rem; font-weight: 800; color: white; padding: 2px 8px; border-radius: 4px; }
    .advisory-text { font-size: 0.85rem; font-weight: 600; color: #333; line-height: 1.35; }
    .advisory-updated { font-size: 0.72rem; color: #5f6368; margin-top: 8px; font-weight: 600; }

    .safe-box { border-radius: 10px; padding: 12px; border: 1px solid #d2e3fc; background: #e8f0fe; display:flex; gap:10px; align-items:flex-start; }
    .safe-icon { color:#1a73e8; margin-top:2px; }
    .safe-text { font-size: 0.82rem; font-weight: 650; color:#1a1a1a; line-height:1.35; }

    .news-box-alert { border-radius: 10px; padding: 12px; border: 1px solid #ffe0b2; background: #fff7ed; }
    .news-box-header { font-size: 0.72rem; font-weight: 900; letter-spacing: 0.6px; color:#7c2d12; margin-bottom: 8px; }
    .news-box-item { padding: 10px; border-radius: 8px; background: #fff; border: 1px solid #fed7aa; margin-bottom: 8px; }
    .news-box-title { font-size: 0.82rem; font-weight: 800; color:#202124; margin-bottom:4px; }
    .news-box-summary { font-size: 0.78rem; font-weight: 600; color:#4b4f56; line-height:1.35; }
  </style>
</head>

<body>
<div class="app-container">
  <div class="header-container">
    <div class="header-left">
      <div class="logo-icon"><i class="fas fa-shield-alt"></i></div>
      <div class="logo-text">OS <span>INFOHUB</span></div>
    </div>

    <div class="header-right d-flex align-items-center">
      <div class="nav-pills-custom">
        <a class="nav-item-custom active" onclick="filterNews('Global', this)">Global</a>
        <a class="nav-item-custom" onclick="filterNews('AMER', this)">AMER</a>
        <a class="nav-item-custom" onclick="filterNews('EMEA', this)">EMEA</a>
        <a class="nav-item-custom" onclick="filterNews('APJC', this)">APJC</a>
        <a class="nav-item-custom" onclick="filterNews('LATAM', this)">LATAM</a>
      </div>

      <div class="ms-3 text-end" style="font-size: 0.85rem; line-height:1.2;">
        <div id="clock-date" style="font-weight:700; color:#202124;">Loading...</div>
        <div id="clock-time" style="color:#5f6368;"></div>
      </div>

      <div class="btn-daily ms-3" onclick="manualRefresh()">
        <i class="fas fa-rotate"></i> Refresh
      </div>

      <div class="btn-daily ms-3" data-bs-toggle="modal" data-bs-target="#reportModal" style="background:#202124; box-shadow:none;">
        <i class="fas fa-file-alt"></i> Daily Briefings
      </div>
    </div>
  </div>

  <div class="content-area">
    <div class="row g-4 h-100">
      <div class="col-lg-9 d-flex flex-column">
        <div class="map-wrapper mb-3">
          <div id="map"></div>
        </div>

        <div class="stream-section">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="fw-bold text-uppercase text-secondary" style="font-size: 0.85rem; letter-spacing: 1px;">
              <i class="fas fa-circle text-success me-2" style="font-size:0.6rem"></i> Live Intelligence Stream
            </div>
            <div class="badge bg-secondary" id="feed-count">WAITING...</div>
          </div>
          <div id="general-news-feed">
            <div class="loading-text">Connecting to Secure Worker...</div>
          </div>
        </div>
      </div>

      <div class="col-lg-3 sidebar-col">
        <div class="side-card">
          <div class="card-label"><i class="fas fa-history"></i> History Search</div>
          <div class="history-input-group">
            <i class="far fa-calendar-alt calendar-icon"></i>
            <input type="date" class="history-input" id="history-picker" onchange="loadHistory(this.value)" />
          </div>
          <div class="sub-text mt-2 text-muted small">Pick a date to load archived intelligence.</div>
        </div>

        <div class="side-card">
          <div class="card-label"><i class="fas fa-plane"></i> Travel Safety Check</div>
          <select class="travel-select" id="countrySelect" onchange="filterTravel()">
            <option selected disabled>Select Country...</option>
          </select>
          <div id="travel-advisories" class="mt-3"></div>
          <div id="travel-news" class="mt-3"></div>
        </div>

        <div class="side-card">
          <div class="card-label"><i class="fas fa-map-marker-alt"></i> Proximity Alerts</div>
          <div class="mt-2 mb-3">
            <select id="proxRadius" class="form-select form-select-sm" onchange="updateProximityRadius()">
              <option value="50" selected>50 KM Range</option>
              <option value="100">100 KM Range</option>
              <option value="500">500 KM Range</option>
            </select>
          </div>
          <div id="proximity-alerts-container">
            <div class="text-center p-3 text-muted small">Scanning assets...</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-file-pdf me-2" style="color:#d93025;"></i>Daily Intelligence Briefings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Select Region / Report Profile</label>
          <select class="form-select" id="reportRegion">
            <option value="Global">Global</option>
            <option value="APJC">APJC</option>
          </select>
        </div>
        <button class="btn btn-primary w-100" onclick="alert('Download started...')">Retrieve Briefing</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===========================
   CONFIG
=========================== */
const WORKER_URL = "https://osinfohub.vssmaximus.workers.dev";
const AUTO_REFRESH_MS = 60_000;

/* ===========================
   DATA STATE
=========================== */
let INCIDENTS = [];
let TRAVEL_DATA = [];
let currentRadius = 50;

let map;
let assetLayer;
let incidentLayer;

/* ===========================
   DELL ASSETS (FULL LIST)
=========================== */
const ASSETS = {
  "round rock hq": { "name": "Dell Round Rock HQ", "lat": 30.5083, "lng": -97.6788, "region": "AMER", "country": "US" },
  "austin parmer": { "name": "Dell Austin Parmer", "lat": 30.3952, "lng": -97.6843, "region": "AMER", "country": "US" },
  "hopkinton": { "name": "Dell Hopkinton", "lat": 42.2287, "lng": -71.5226, "region": "AMER", "country": "US" },
  "franklin": { "name": "Dell Franklin", "lat": 42.0834, "lng": -71.3967, "region": "AMER", "country": "US" },
  "apex": { "name": "Dell Apex", "lat": 35.7327, "lng": -78.8503, "region": "AMER", "country": "US" },
  "eden prairie": { "name": "Dell Eden Prairie", "lat": 44.8617, "lng": -93.4168, "region": "AMER", "country": "US" },
  "draper": { "name": "Dell Draper", "lat": 40.524, "lng": -111.895, "region": "AMER", "country": "US" },
  "nashville hub": { "name": "Dell Nashville Hub", "lat": 36.1627, "lng": -86.7816, "region": "AMER", "country": "US" },
  "oklahoma city": { "name": "Dell Oklahoma City", "lat": 35.4676, "lng": -97.5164, "region": "AMER", "country": "US" },
  "santa clara": { "name": "Dell Santa Clara", "lat": 37.3541, "lng": -121.9552, "region": "AMER", "country": "US" },
  "mclean": { "name": "Dell McLean", "lat": 38.9295, "lng": -77.2268, "region": "AMER", "country": "US" },
  "el paso": { "name": "Dell El Paso", "lat": 31.8385, "lng": -106.5278, "region": "AMER", "country": "US" },
  "toronto": { "name": "Dell Toronto", "lat": 43.6532, "lng": -79.3832, "region": "AMER", "country": "CA" },
  "mexico city": { "name": "Dell Mexico City", "lat": 19.4326, "lng": -99.1332, "region": "AMER", "country": "MX" },
  "hortolândia mfg": { "name": "Dell Hortolândia Mfg", "lat": -22.8583, "lng": -47.2208, "region": "LATAM", "country": "BR" },
  "são paulo": { "name": "Dell São Paulo", "lat": -23.5505, "lng": -46.6333, "region": "LATAM", "country": "BR" },
  "porto alegre": { "name": "Dell Porto Alegre", "lat": -30.0346, "lng": -51.2177, "region": "LATAM", "country": "BR" },
  "panama city": { "name": "Dell Panama City", "lat": 8.9824, "lng": -79.5199, "region": "LATAM", "country": "PA" },
  "lodz mfg": { "name": "Dell Lodz Mfg", "lat": 51.7285, "lng": 19.4967, "region": "EMEA", "country": "PL" },
  "limerick": { "name": "Dell Limerick", "lat": 52.6638, "lng": -8.6267, "region": "EMEA", "country": "IE" },
  "dublin cherrywood": { "name": "Dell Dublin Cherrywood", "lat": 53.2374, "lng": -6.145, "region": "EMEA", "country": "IE" },
  "cork campus": { "name": "Dell Cork Campus", "lat": 51.8985, "lng": -8.4756, "region": "EMEA", "country": "IE" },
  "herzliya": { "name": "Dell Herzliya", "lat": 32.1644, "lng": 34.7961, "region": "EMEA", "country": "IL" },
  "haifa": { "name": "Dell Haifa", "lat": 32.794, "lng": 34.9896, "region": "EMEA", "country": "IL" },
  "beer sheva": { "name": "Dell Beer Sheva", "lat": 31.2626, "lng": 34.8016, "region": "EMEA", "country": "IL" },
  "bracknell": { "name": "Dell Bracknell", "lat": 51.416, "lng": -0.754, "region": "EMEA", "country": "GB" },
  "glasgow": { "name": "Dell Glasgow", "lat": 55.8642, "lng": -4.2518, "region": "EMEA", "country": "GB" },
  "montpellier": { "name": "Dell Montpellier", "lat": 43.6108, "lng": 3.8767, "region": "EMEA", "country": "FR" },
  "paris bezons": { "name": "Dell Paris / Bezons", "lat": 48.8566, "lng": 2.3522, "region": "EMEA", "country": "FR" },
  "frankfurt": { "name": "Dell Frankfurt", "lat": 50.1109, "lng": 8.6821, "region": "EMEA", "country": "DE" },
  "halle": { "name": "Dell Halle", "lat": 51.482, "lng": 11.97, "region": "EMEA", "country": "DE" },
  "amsterdam": { "name": "Dell Amsterdam", "lat": 52.3676, "lng": 4.9041, "region": "EMEA", "country": "NL" },
  "casablanca": { "name": "Dell Casablanca", "lat": 33.5731, "lng": -7.5898, "region": "EMEA", "country": "MA" },
  "cairo": { "name": "Dell Cairo", "lat": 30.0444, "lng": 31.2357, "region": "EMEA", "country": "EG" },
  "dubai": { "name": "Dell Dubai", "lat": 25.2048, "lng": 55.2708, "region": "EMEA", "country": "AE" },
  "bangalore": { "name": "Dell Bangalore", "lat": 12.9716, "lng": 77.5946, "region": "APJC", "country": "IN" },
  "hyderabad": { "name": "Dell Hyderabad", "lat": 17.385, "lng": 78.4867, "region": "APJC", "country": "IN" },
  "gurugram": { "name": "Dell Gurugram", "lat": 28.4595, "lng": 77.0266, "region": "APJC", "country": "IN" },
  "sriperumbudur mfg": { "name": "Dell Sriperumbudur Mfg", "lat": 12.956, "lng": 79.941, "region": "APJC", "country": "IN" },
  "singapore": { "name": "Dell Singapore", "lat": 1.3521, "lng": 103.8198, "region": "APJC", "country": "SG" },
  "penang": { "name": "Dell Penang", "lat": 5.4164, "lng": 100.3327, "region": "APJC", "country": "MY" },
  "cyberjaya": { "name": "Dell Cyberjaya", "lat": 2.9213, "lng": 101.6559, "region": "APJC", "country": "MY" },
  "xiamen mfg": { "name": "Dell Xiamen Mfg", "lat": 24.4798, "lng": 118.0894, "region": "APJC", "country": "CN" },
  "chengdu mfg": { "name": "Dell Chengdu Mfg", "lat": 30.5728, "lng": 104.0668, "region": "APJC", "country": "CN" },
  "shanghai": { "name": "Dell Shanghai", "lat": 31.2304, "lng": 121.4737, "region": "APJC", "country": "CN" },
  "taipei": { "name": "Dell Taipei", "lat": 25.033, "lng": 121.5654, "region": "APJC", "country": "TW" },
  "tokyo": { "name": "Dell Tokyo", "lat": 35.6762, "lng": 139.6503, "region": "APJC", "country": "JP" },
  "kawasaki": { "name": "Dell Kawasaki", "lat": 35.53, "lng": 139.696, "region": "APJC", "country": "JP" },
  "sydney": { "name": "Dell Sydney", "lat": -33.8688, "lng": 151.2093, "region": "APJC", "country": "AU" },
  "melbourne": { "name": "Dell Melbourne", "lat": -37.8136, "lng": 144.9631, "region": "APJC", "country": "AU" }
};

/* ===========================
   INIT
=========================== */
document.addEventListener("DOMContentLoaded", async () => {
  initMap();
  startClock();
  await loadFromWorker();
  await loadTravelAdvisories();
  filterNews("Global");

  setInterval(async () => {
    await loadFromWorker(true);
    const active = document.querySelector(".nav-item-custom.active");
    filterNews(active ? active.innerText.trim() : "Global");
  }, AUTO_REFRESH_MS);
});

/* ===========================
   CLOCK
=========================== */
function startClock() {
  const tick = () => {
    const now = new Date();
    document.getElementById("clock-date").innerText = now.toLocaleDateString("en-US", { weekday: "long", year: "numeric", month: "short", day: "numeric" });
    document.getElementById("clock-time").innerText = now.toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit", timeZoneName: "short" });
  };
  tick();
  setInterval(tick, 1000);
}

/* ===========================
   MAP
=========================== */
function initMap() {
  map = L.map("map", { zoomControl: false }).setView([25, 10], 2);
  L.tileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png").addTo(map);
  assetLayer = L.layerGroup().addTo(map);
  incidentLayer = L.layerGroup().addTo(map);
  renderAssetsOnMap("Global");
}

function renderAssetsOnMap(region) {
  assetLayer.clearLayers();

  const icon = L.divIcon({
    className: "custom-div-icon",
    html: '<div class="marker-pin-dell"><i class="fas fa-building"></i></div>',
    iconSize: [30, 30],
    iconAnchor: [15, 15]
  });

  const assets = Object.entries(ASSETS).map(([key, c]) => ({ key, ...c }));
  const filtered = (region === "Global") ? assets : assets.filter(a => a.region === region);

  filtered.forEach(a => {
    L.marker([a.lat, a.lng], { icon }).addTo(assetLayer)
      .bindTooltip(`<b>${escapeHtml(String(a.name || a.key).toUpperCase())}</b>`, { direction:"top" });
  });

  if (region === "AMER") map.setView([30, -90], 3);
  else if (region === "EMEA") map.setView([45, 15], 3);
  else if (region === "APJC") map.setView([20, 110], 3);
  else if (region === "LATAM") map.setView([-15, -60], 3);
  else map.setView([25, 10], 2);
}

function renderIncidentsOnMap(region, incidents) {
  incidentLayer.clearLayers();
  const filtered = (region === "Global") ? incidents : incidents.filter(i => (i.region || "Global") === region);

  filtered.forEach(i => {
    if (!i.lat || !i.lng) return;
    const sev = getSevDetails(i.severity);
    const marker = L.circleMarker([i.lat, i.lng], { radius: 8, fillColor: sev.color, color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.85 });
    marker.bindPopup(`<b>${escapeHtml(i.title)}</b><br>${escapeHtml(i.country || "")}`);
    marker.addTo(incidentLayer);
  });
}

/* ===========================
   WORKER FETCH
=========================== */
async function loadFromWorker(silent=false) {
  try {
    const res = await fetch(`${WORKER_URL}/api/incidents`, { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const raw = await res.json();
    INCIDENTS = raw.map(normaliseWorkerIncident).filter(Boolean);

    INCIDENTS.sort((a,b) => (getSevDetails(b.severity).val - getSevDetails(a.severity).val) || (new Date(b.time) - new Date(a.time)));

    document.getElementById("feed-count").innerText = `${INCIDENTS.length} ITEMS`;
    renderProximityAlerts();
  } catch (e) {
    if (!silent) document.getElementById("feed-count").innerText = "OFFLINE";
  }
}

function normaliseWorkerIncident(item) {
  if (!item) return null;
  let sev = (item.severity || "LOW").toUpperCase();
  if(!["CRITICAL","HIGH","MODERATE","LOW"].includes(sev)) sev = "LOW";

  return {
    id: item.id,
    title: item.title || "",
    summary: item.summary || "",
    category: (item.category || "UNKNOWN").toUpperCase(),
    severity: sev,
    region: (item.region || "GLOBAL").toUpperCase(),
    country: (item.country || "").toString(),
    location: (item.location || "").toString(),
    link: item.link || "#",
    source: item.source || "",
    time: item.time || new Date().toISOString(),
    lat: Number(item.lat) || 0,
    lng: Number(item.lng) || 0,
    nearest_site: (item.nearest_site || "").toString(),
    distance_km: Number(item.distance_km) || 0
  };
}

/* ===========================
   TRAVEL ADVISORIES (REAL)
=========================== */
async function loadTravelAdvisories() {
  try {
    const res = await fetch(`${WORKER_URL}/api/traveladvisories`, { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const json = await res.json();
    TRAVEL_DATA = Array.isArray(json.advisories) ? json.advisories : [];
  } catch (e) {
    TRAVEL_DATA = [];
  }
  populateCountries();
}

function populateCountries() {
  const sel = document.getElementById("countrySelect");
  sel.innerHTML = `<option selected disabled>Select Country...</option>`;

  const list = [...TRAVEL_DATA].sort((a,b) => String(a.country).localeCompare(String(b.country)));
  list.forEach(a => {
    sel.innerHTML += `<option value="${escapeAttr(a.country)}">${escapeHtml(a.country)}</option>`;
  });

  const advContainer = document.getElementById("travel-advisories");
  if (advContainer && list.length === 0) {
    advContainer.innerHTML = `
      <div class="safe-box" style="border-color:#fad2cf;background:#fce8e6;">
        <i class="fas fa-triangle-exclamation" style="color:#d93025;margin-top:2px;"></i>
        <div class="safe-text" style="color:#b3261e;">
          Travel Advisory feed unavailable. Check Worker connectivity or parsing.
        </div>
      </div>`;
  }
}

function filterTravel() {
  const country = document.getElementById("countrySelect").value;
  const advContainer = document.getElementById("travel-advisories");
  const newsContainer = document.getElementById("travel-news");
  if (!country || !advContainer || !newsContainer) return;

  const advisory = TRAVEL_DATA.find(a => a.country === country) || { level: 1, level_text: "Level 1", indicators: "", date_issued: "", url: "" };

  let advColor = "#1a73e8";
  let advBg = "#e8f0fe";
  let advBorder = "#d2e3fc";
  const lvl = Number(advisory.level || 1);

  if (lvl === 2) { advColor="#f9ab00"; advBg="#fef7e0"; advBorder="#feebc8"; }
  else if (lvl === 3) { advColor="#e37400"; advBg="#fff5e5"; advBorder="#ffdecb"; }
  else if (lvl >= 4) { advColor="#d93025"; advBg="#fce8e6"; advBorder="#fad2cf"; }

  const levelText = advisory.level_text || `Level ${lvl}`;
  const detailsBits = [];
  if (advisory.indicators) detailsBits.push(`<div class="advisory-updated"><b>Risk Indicators:</b> ${escapeHtml(advisory.indicators)}</div>`);
  if (advisory.date_issued) detailsBits.push(`<div class="advisory-updated"><b>Date Issued:</b> ${escapeHtml(advisory.date_issued)}</div>`);
  if (advisory.url) detailsBits.push(`<div class="advisory-updated"><a href="${escapeAttr(advisory.url)}" target="_blank" style="color:#1a73e8;font-weight:700;text-decoration:none;">Open full advisory</a></div>`);

  advContainer.innerHTML = `
    <div class="advisory-box" style="background:${advBg};border-color:${advBorder}">
      <div class="advisory-header">
        <span class="advisory-label">U.S. STATE DEPARTMENT TRAVEL ADVISORY</span>
        <span class="advisory-level-badge" style="background:${advColor}">${escapeHtml(levelText.toUpperCase())}</span>
      </div>
      <div class="advisory-text">${escapeHtml(advisory.text || levelText)}</div>
      ${detailsBits.join("")}
    </div>`;

  const related = INCIDENTS.filter(i => {
    const c = String(i.country || "").toLowerCase();
    const t = (i.title || "").toLowerCase();
    const s = (i.summary || "").toLowerCase();
    const needle = country.toLowerCase();
    return c.includes(needle) || t.includes(needle) || s.includes(needle);
  }).slice(0, 5);

  if (related.length > 0) {
    let newsHtml = `<div class="news-box-alert"><div class="news-box-header">RECENT INCIDENTS (FEED)</div>`;
    related.forEach(n => {
      newsHtml += `
        <div class="news-box-item">
          <div class="news-box-title">${escapeHtml(n.title)}</div>
          <div class="news-box-summary">${escapeHtml(n.summary || "")}</div>
        </div>`;
    });
    newsHtml += `</div>`;
    newsContainer.innerHTML = newsHtml;
  } else {
    newsContainer.innerHTML = `
      <div class="safe-box">
        <i class="fas fa-check-circle safe-icon"></i>
        <div class="safe-text">
          No incidents matched for ${escapeHtml(country)} in the current feed.
        </div>
      </div>`;
  }
}

/* ===========================
   RENDER FEED
=========================== */
function renderGeneralFeed(region) {
  const container = document.getElementById("general-news-feed");
  container.innerHTML = "";
  const data = (region === "Global") ? INCIDENTS : INCIDENTS.filter(i => i.region === region);

  if (data.length === 0) {
    container.innerHTML = `<div style="padding:30px;text-align:center;color:#999;">No incidents for this region.</div>`;
    return;
  }

  data.forEach(i => {
    const sevClass = `sev-${i.severity}`;
    container.innerHTML += `
      <a href="${escapeAttr(i.link)}" target="_blank" class="feed-card">
        <div class="feed-status-bar ${sevClass}"></div>
        <div class="feed-content">
          <div class="feed-tags">
            <span class="ftag ${sevClass}">${escapeHtml(i.severity)}</span>
            <span class="ftag ftag-loc">${escapeHtml(i.country || "GLOBAL")}</span>
            <span class="ftag">${escapeHtml(i.category || "UNKNOWN")}</span>
          </div>
          <div class="feed-title">${escapeHtml(i.title)}</div>
          <div class="feed-meta">Source: ${escapeHtml(i.source || "")} • ${new Date(i.time).toLocaleTimeString()}</div>
          <div class="feed-desc">${escapeHtml(i.summary || "")}</div>
        </div>
      </a>`;
  });
}

function filterNews(region, el) {
  if (el) {
    document.querySelectorAll(".nav-item-custom").forEach(e => e.classList.remove("active"));
    el.classList.add("active");
  }
  renderAssetsOnMap(region);
  renderIncidentsOnMap(region, INCIDENTS);
  renderGeneralFeed(region);
}

/* ===========================
   PROXIMITY ALERTS
=========================== */
function updateProximityRadius() {
  currentRadius = Number(document.getElementById("proxRadius").value || 50);
  renderProximityAlerts();
}

function renderProximityAlerts() {
  const box = document.getElementById("proximity-alerts-container");
  const alerts = INCIDENTS
    .filter(i => i.nearest_site && i.distance_km && i.distance_km <= currentRadius)
    .slice(0, 25);

  if (alerts.length === 0) {
    box.innerHTML = `<div class="safe-box"><i class="fas fa-check-circle safe-icon"></i><div class="safe-text">No incidents within ${currentRadius} KM of any Dell site in this feed.</div></div>`;
    return;
  }

  let html = "";
  alerts.forEach(i => {
    const sevClass = `sev-${i.severity}`;
    html += `
      <div class="news-box-alert" style="border-color:#e0e0e0;background:#fff;">
        <div class="feed-tags" style="margin-bottom:8px;">
          <span class="ftag ${sevClass}">${escapeHtml(i.severity)}</span>
          <span class="ftag ftag-loc">${escapeHtml(i.country || "")}</span>
        </div>
        <div class="news-box-title">${escapeHtml(i.title)}</div>
        <div class="news-box-summary" style="margin-top:6px;">
          <i class="far fa-building"></i> Near: <b>${escapeHtml((i.nearest_site || "").toUpperCase())}</b><br/>
          <i class="fas fa-route"></i> Distance: <b>${escapeHtml(String(Math.round(i.distance_km)))}</b> KM
        </div>
      </div>`;
  });
  box.innerHTML = html;
}

/* ===========================
   HELPERS
=========================== */
function getSevDetails(level) {
  const map = {
    'CRITICAL': { val: 4, color: '#ef4444' },
    'HIGH':     { val: 3, color: '#f97316' },
    'MODERATE': { val: 2, color: '#eab308' },
    'LOW':      { val: 1, color: '#1a73e8' }
  };
  return map[level] || { val: 0, color: '#64748b' };
}

async function manualRefresh() {
  await loadFromWorker();
  const active = document.querySelector(".nav-item-custom.active");
  filterNews(active ? active.innerText.trim() : "Global");
}

function loadHistory(d) { alert("History simulation: " + d); }

function escapeHtml(s) {
  return String(s || "")
    .replace(/&/g, "&amp;").replace(/</g, "&lt;")
    .replace(/>/g, "&gt;").replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}
function escapeAttr(s) { return escapeHtml(s).replace(/`/g, "&#096;"); }
</script>
</body>
</html>
