<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com 'unsafe-inline';
    style-src 'self' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com https://fonts.googleapis.com 'unsafe-inline';
    font-src 'self' https://cdnjs.cloudflare.com https://fonts.gstatic.com;
    img-src 'self' data: https://*.basemaps.cartocdn.com https://*.arcgisonline.com;
    connect-src 'self' https://osinfohub.vssmaximus.workers.dev https://raw.githubusercontent.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com https://server.arcgisonline.com;
    base-uri 'self';
  ">

  <link rel="icon" href="data:,">
  <title>Dell OS | INFOHUB</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

    :root { --dell-blue: #0076CE; --bg-dark: #0f1115; }
    body { background-color: var(--bg-dark); font-family: 'Inter', sans-serif; padding: 24px; color: #333; }

    /* Accessibility Helper */
    .visually-hidden { position: absolute !important; width: 1px !important; height: 1px !important; padding: 0 !important; margin: -1px !important; overflow: hidden !important; clip: rect(0,0,0,0) !important; white-space: nowrap !important; border: 0 !important; }
    .skip-link { position: absolute; top: -50px; left: 10px; background: #1a73e8; color: #fff; padding: 10px; z-index: 99999; font-weight: 700; border-radius: 4px; text-decoration: none; transition: top 0.2s; }
    .skip-link:focus { top: 10px; }

    .app-container { background-color: #fff; border-radius: 24px; min-height: 92vh; padding: 0; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .header-container { padding: 15px 32px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f0f0f0; height: 90px; }
    .header-left { display: flex; align-items: center; height: 100%; }
    .logo-icon { font-size: 1.6rem; color: #1a73e8; display: flex; align-items: center; }
    .logo-text { font-size: 1.2rem; font-weight: 800; color: #202124; letter-spacing: -0.5px; margin-left: 12px; line-height: 1; padding-top: 2px; }
    .logo-text span { color: var(--dell-blue); }

    .multi-clock-container { display: flex; gap: 12px; margin: 0 20px; padding-right: 20px; border-right: 1px solid #e0e0e0; height: 100%; align-items: center; }
    .clock-box { text-align: center; min-width: 85px; background: #2b2b2b; border: 3px solid #b0b0b0; border-radius: 10px; padding: 6px; box-shadow: 0 3px 5px rgba(0,0,0,0.3); }
    .clock-label { font-family: 'Inter', sans-serif; font-size: 0.55rem; font-weight: 700; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
    .clock-val { font-family: 'Share Tech Mono', monospace; font-size: 1.25rem; font-weight: 400; color: #4fdb5e; line-height: 1; background: #000; padding: 4px 6px; border-radius: 4px; display: block; text-shadow: 0 0 5px rgba(79, 219, 94, 0.5); box-shadow: inset 0 0 5px rgba(0,0,0,0.8); font-variant-numeric: tabular-nums; }

    .map-wrapper { position: relative; border-radius: 16px; overflow: hidden; height: 520px; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05); background: #eef2f6; }
    #map { width: 100%; height: 100%; z-index: 1; outline: none; }
    #map:focus { box-shadow: inset 0 0 0 3px rgba(26,115,232,0.5); }

    .leaflet-tooltip.map-tooltip { background-color: #202124; color: #fff; border: none; border-radius: 4px; padding: 6px 10px; font-family: 'Inter', sans-serif; font-size: 0.8rem; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
    .leaflet-tooltip-top:before { border-top-color: #202124; }
    .leaflet-popup-content-wrapper { border-radius: 6px; padding: 0; }
    .leaflet-popup-content { margin: 10px 12px; font-size: 0.85rem; font-family: 'Inter', sans-serif; font-weight: 600; color: #333; }

    .marker-pin-dell { width: 30px; height: 30px; background: #1a73e8; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 2px solid white; box-shadow: 0 3px 6px rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; }
    .marker-pin-dell i { transform: rotate(45deg); color: white; font-size: 14px; margin-top: 2px; margin-left: 2px; }

    .incident-dot { width:12px; height:12px; border-radius:50%; border:2px solid #fff; box-shadow:0 2px 3px rgba(0,0,0,0.3); }

    .cluster-icon { display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; border-radius:50%; box-shadow:0 2px 6px rgba(0,0,0,0.35); border: 2px solid rgba(255,255,255,0.6); font-family: 'Inter', sans-serif; cursor: pointer; }
    .cluster-icon:focus { outline: 2px solid #fff; outline-offset: 2px; }
    .cluster-count { font-size:13px; line-height:1; }
    .cluster-blue { background: #1a73e8; }
    .cluster-amber { background: #f9ab00; }
    .cluster-red { background: #d93025; }

    .btn-daily { background-color: #1a73e8; color: white; padding: 9px 18px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(26,115,232,0.2); cursor: pointer; transition: opacity 0.2s; }
    .btn-daily:hover { background-color: #1557b0; color: white; }
    .btn-daily:focus { outline: 2px solid #202124; outline-offset: 2px; }

    .nav-pills-custom { background-color: #f1f3f4; padding: 4px; border-radius: 10px; display: flex; gap: 2px; }
    .nav-item-custom { padding: 7px 18px; border-radius: 8px; font-weight: 700; font-size: 0.8rem; color: #5f6368; cursor: pointer; text-decoration: none; text-transform: uppercase; letter-spacing: 0.5px; }
    .nav-item-custom.active { background-color: #202124; color: #fff; }
    .nav-item-custom:focus { outline: 2px solid #202124; }

    .content-area { padding: 30px; }
    .sidebar-col { padding-left: 30px; }
    .side-card { background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 24px; box-shadow: 0 2px 6px rgba(0,0,0,0.02); }
    .card-label { font-size: 0.95rem; font-weight: 700; color: #202124; margin-bottom: 12px; display: flex; align-items: center; gap: 10px; }
    .card-label i { color: #9aa0a6; }

    .history-input-group { position: relative; }
    .history-input { width: 100%; padding: 10px 10px 10px 40px; border: 1px solid #dadce0; border-radius: 8px; font-size: 0.9rem; color: #333; font-weight: 500; }
    .calendar-icon { position: absolute; left: 12px; top: 12px; color: #5f6368; }
    .sub-text { font-size: 0.75rem; color: #9aa0a6; margin-top: 8px; font-weight: 500; }

    .travel-select { width: 100%; padding: 10px 12px; border: 1px solid #dadce0; border-radius: 8px; font-size: 0.9rem; color: #5f6368; background-color: #fff; }
    .prox-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2px; }
    .prox-dell-label { font-size: 0.8rem; font-weight: 700; color: #202124; }
    .prox-main-title { font-size: 1.2rem; font-weight: 800; color: #1a73e8; line-height: 1.1; }
    .prox-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; margin-bottom: 15px; }
    .prox-subtitle { font-size: 0.7rem; color: #9aa0a6; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; margin: 0; }
    .radius-select { font-size: 0.75rem; padding: 4px 8px; border-radius: 6px; border: 1px solid #ddd; color: #555; font-weight: 600; background: #f9f9f9; cursor: pointer; }

    #proximity-alerts-container { max-height: 400px; overflow-y: auto; padding-right: 5px; }
    #proximity-alerts-container::-webkit-scrollbar { width: 6px; }
    #proximity-alerts-container::-webkit-scrollbar-track { background: #f1f3f4; border-radius: 4px; }
    #proximity-alerts-container::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
    #proximity-alerts-container::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

    .alert-row { padding: 15px 0; border-bottom: 1px solid #f1f1f1; position: relative; }
    .alert-row:last-child { border-bottom: none; }
    .alert-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; gap: 10px; width: 100%; }
    .alert-type { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 0.9rem; color: #202124; flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .alert-dist { font-weight: 700; font-size: 0.85rem; color: #d93025; white-space: nowrap; flex-shrink: 0; }
    .alert-site { font-size: 0.85rem; font-weight: 600; color: #5f6368; display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .alert-desc { font-size: 0.8rem; color: #5f6368; line-height: 1.4; }
    /* Dismiss Button */
    .alert-actions { display: flex; gap: 8px; margin-top: 8px; }
    .btn-dismiss { font-size: 0.7rem; padding: 2px 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; color: #5f6368; cursor: pointer; }
    .btn-dismiss:hover { background: #f1f3f4; color: #202124; }

    .stream-section { margin-top: 25px; }
    .stream-header { display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; }
    .stream-label { font-weight: 700; font-size: 0.95rem; display: flex; align-items: center; gap: 10px; }
    .live-dot-blue { color: #1a73e8; font-size: 0.8rem; }
    .live-box { background: #e8f0fe; color: #1a73e8; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; }

    .feed-card { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e0e0e0; margin-bottom: 15px; padding: 0; display: flex; overflow: hidden; transition: transform 0.2s; text-decoration: none; color: inherit; position: relative; }
    .feed-card:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .feed-status-bar { width: 5px; flex-shrink: 0; }
    .status-bar-crit { background-color: #d93025; }
    .status-bar-warn { background-color: #f9ab00; }
    .status-bar-info { background-color: #1a73e8; }

    .feed-content { padding: 16px 20px; width: 100%; }
    .feed-tags { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; flex-wrap: wrap; }
    .ftag { font-size: 0.7rem; font-weight: 800; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; border: 1px solid #eee; letter-spacing: 0.5px; }
    .ftag-crit { background: #fce8e6; color: #c5221f; border-color: #fad2cf; }
    .ftag-warn { background: #fef7e0; color: #e37400; border-color: #feebc8; }
    .ftag-info { background: #e8f0fe; color: #1a73e8; border-color: #d2e3fc; }
    .ftag-type { background: #f1f3f4; color: #5f6368; }
    .ftag-loc { background: #202124; color: #fff; border-color: #202124; }

    .feed-region { margin-left: auto; font-size: 0.75rem; font-weight: 700; color: #9aa0a6; }
    .feed-title { font-size: 1rem; font-weight: 700; color: #202124; margin-bottom: 6px; line-height: 1.4; }
    .feed-title a:hover { text-decoration: underline; }
    .feed-meta { font-size: 0.8rem; color: #5f6368; margin-bottom: 8px; font-weight: 500; }
    .feed-desc { font-size: 0.85rem; color: #3c4043; line-height: 1.5; }

    /* Voting Buttons */
    .vote-row { display: flex; gap: 8px; margin-top: 10px; justify-content: flex-end; }
    .btn-vote { background: none; border: 1px solid #e0e0e0; border-radius: 4px; padding: 2px 8px; font-size: 0.8rem; cursor: pointer; color: #5f6368; }
    .btn-vote:hover { background: #f1f3f4; color: #1a73e8; }

    .critical-alert-bar { background: #fce8e6; border-left: 4px solid #d93025; padding: 12px 20px; border-radius: 6px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
    .alert-icon-lg { color: #d93025; font-size: 1.2rem; }
    .alert-content-main { flex-grow: 1; font-weight: 700; color: #202124; font-size: 0.95rem; }
    .alert-tags { display: flex; gap: 8px; flex-wrap: wrap; }
    .tag { font-size: 0.7rem; font-weight: 800; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; color: white; }
    .tag-crit { background: #d93025; color: white; }
    .tag-cat { background: #3c4043; color: white; }
    .tag-reg { background: #3c4043; color: white; opacity: 0.8; }
    .tag-low { background: #e8f0fe; color: #1a73e8; border: 1px solid #d2e3fc; }
    .tag-medium { background: #fef7e0; color: #e37400; border: 1px solid #feebc8; }
    .tag-high { background: #fce8e6; color: #c5221f; border: 1px solid #fad2cf; }
    .tag-critical { background: #d93025; color: #fff; border: 1px solid #d93025; }

    .advisory-box { background: #fdf2f2; border: 1px solid #fad2cf; border-radius: 8px; padding: 12px; margin-top: 15px; }
    .advisory-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .advisory-label { font-size: 0.7rem; font-weight: 800; color: #5f6368; letter-spacing: 0.5px; }
    .advisory-level-badge { font-size: 0.7rem; font-weight: 800; color: white; padding: 2px 8px; border-radius: 4px; }
    .advisory-text { font-size: 0.85rem; font-weight: 600; color: #333; line-height: 1.3; }
    .advisory-updated { font-size: 0.72rem; color: #5f6368; margin-top: 8px; font-weight: 600; }

    .safe-box { background: #e6f4ea; border: 1px solid #ceead6; border-radius: 8px; padding: 12px; margin-top: 10px; display: flex; align-items: flex-start; gap: 10px; }
    .safe-icon { color: #1e8e3e; font-size: 1rem; margin-top: 2px; }
    .safe-text { font-size: 0.85rem; color: #137333; font-weight: 600; line-height: 1.4; }

    .news-box-alert { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; margin-top: 10px; overflow: hidden; }
    .news-box-header { background: #f8f9fa; padding: 8px 12px; font-size: 0.75rem; font-weight: 700; color: #5f6368; border-bottom: 1px solid #eee; }
    .news-box-item { padding: 10px 12px; border-bottom: 1px solid #eee; }
    .news-box-item:last-child { border-bottom: none; }
    .news-box-title { font-size: 0.85rem; font-weight: 700; color: #202124; margin-bottom: 4px; }
    .news-box-summary { font-size: 0.75rem; color: #5f6368; }

    .modal-content { border-radius: 12px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .modal-header { border-bottom: 1px solid #f0f0f0; padding: 20px; }
    .modal-title { font-weight: 800; color: #202124; }
    .modal-body { padding: 30px; }
    .form-label { font-size: 0.85rem; font-weight: 700; color: #5f6368; margin-bottom: 8px; }
    .form-select, .form-control { border-radius: 8px; padding: 10px; font-size: 0.9rem; border: 1px solid #dadce0; }
    .btn-download { width: 100%; background: #1a73e8; color: white; font-weight: 700; padding: 12px; border-radius: 8px; border: none; margin-top: 10px; }
    .btn-download:hover { background: #1557b0; }

    /* DEBUG OVERLAY */
    .assets-debug { position: absolute; top: 110px; right: 18px; z-index: 999999; background: #fff; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); max-width: 320px; line-height: 1.25; }
    .assets-debug pre { white-space: pre-wrap; word-break: break-word; margin: 0; font-size: 12px; color:#222; }
  </style>
</head>

<body>
  <a href="#main-content" class="skip-link">Skip to Main Content</a>

<div class="app-container" id="main-content">
  <div class="header-container">
    <div class="header-left">
      <div class="logo-icon"><i class="fas fa-shield-alt"></i></div>
      <div class="logo-text">OS <span>INFOHUB</span></div>
    </div>

    <div class="header-right d-flex align-items-center">
      <div class="multi-clock-container" id="multi-clock-container" role="timer" aria-label="World Clocks"></div>

      <div class="nav-pills-custom" role="tablist" aria-label="Region Filter">
        <a class="nav-item-custom active" data-action="filter-region" data-region="Global" role="tab" aria-selected="true" tabindex="0">Global</a>
        <a class="nav-item-custom" data-action="filter-region" data-region="AMER" role="tab" aria-selected="false" tabindex="0">AMER</a>
        <a class="nav-item-custom" data-action="filter-region" data-region="EMEA" role="tab" aria-selected="false" tabindex="0">EMEA</a>
        <a class="nav-item-custom" data-action="filter-region" data-region="APJC" role="tab" aria-selected="false" tabindex="0">APJC</a>
        <a class="nav-item-custom" data-action="filter-region" data-region="LATAM" role="tab" aria-selected="false" tabindex="0">LATAM</a>
      </div>

      <div id="btn-refresh" class="btn-daily ms-3" data-action="refresh" role="button" aria-label="Refresh Data" tabindex="0">
        <i class="fas fa-rotate" aria-hidden="true"></i> Refresh
      </div>

      <div class="btn-daily ms-2" data-bs-toggle="modal" data-bs-target="#reportModal" style="background:#202124; box-shadow:none;" role="button" aria-label="Open Reports" tabindex="0">
        <i class="fas fa-file-alt" aria-hidden="true"></i> Daily Briefings
      </div>
      
      <button class="btn btn-sm btn-outline-secondary ms-2" data-bs-toggle="modal" data-bs-target="#adminModal" aria-label="Admin Settings">
        <i class="fas fa-cog" aria-hidden="true"></i>
      </button>
    </div>
  </div>

  <div class="content-area">
    <div class="row g-4">
      <div class="col-lg-9">
        <div class="map-wrapper" aria-label="Incident Map" role="application">
          <div id="map" tabindex="0"></div>
        </div>

        <div class="stream-section">
          <div class="stream-header">
             <div class="stream-label">
              <i class="fas fa-circle live-dot-blue"></i> Real-time Intelligence Stream
              <span class="live-box ms-2" id="feed-status-label" aria-live="polite">Connecting…</span>
            </div>
            <div class="stream-links" data-action="refresh" title="Refresh feed" style="cursor:pointer;color:#1a73e8;font-weight:800;font-size:0.8rem;" role="button" tabindex="0">
              VIEW FULL STREAM <span><i class="fas fa-arrow-right ms-1" aria-hidden="true"></i></span>
            </div>
          </div>

          <div class="critical-alert-bar" role="alert">
            <i class="fas fa-exclamation-triangle alert-icon-lg"></i>
            <div class="alert-content-main" id="headline-alert">Loading headline…</div>
            <div class="alert-tags" id="headline-tags">
              <span class="tag" id="headline-sev">SEV?</span>
              <span class="tag tag-cat" id="headline-cat">CATEGORY</span>
              <span class="tag tag-reg" id="headline-reg">REGION</span>
            </div>
          </div>

          <div id="general-news-feed" aria-live="polite">
            <div style="padding:30px;text-align:center;color:#999;">Connecting to Secure Worker…</div>
          </div>
        </div>
      </div>

      <div class="col-lg-3 sidebar-col">
        <div class="side-card">
          <div class="card-label"><i class="fas fa-history"></i> History Search</div>
          <div class="history-input-group">
            <i class="far fa-calendar-alt calendar-icon"></i>
            <label for="history-picker" class="form-label visually-hidden">History Date</label>
            <input type="date" class="history-input" id="history-picker" aria-label="Select history date" />
          </div>
          <div class="sub-text" id="history-status" aria-live="polite">Pick a date to load archived intelligence.</div>
        </div>

        <div class="side-card">
          <div class="card-label"><i class="fas fa-plane"></i> Travel Safety Check</div>
          <label for="countrySelect" class="form-label visually-hidden">Select Country</label>
          <select class="travel-select" id="countrySelect" aria-label="Select country for travel info">
            <option selected disabled>Loading countries...</option>
          </select>
          <div id="travel-advisories" class="mt-3" aria-live="polite"></div>
          <div id="travel-news" class="mt-2"></div>
        </div>

        <div class="side-card" style="padding-bottom: 10px;">
          <div class="prox-header-row">
            <div>
              <div class="prox-dell-label">Dell Asset</div>
              <div class="prox-main-title">Proximity<br/>Alerts</div>
            </div>
          </div>
          <div class="prox-controls">
            <div class="prox-subtitle">WITHIN RADIUS</div>
            <label for="proxRadius" class="form-label visually-hidden">Select Radius</label>
            <select id="proxRadius" class="radius-select" aria-label="Proximity radius">
              <option value="5">5 KM</option>
              <option value="10">10 KM</option>
              <option value="25">25 KM</option>
              <option value="50" selected>50 KM</option>
              <option value="100">100 KM</option>
              <option value="500">500 KM</option>
            </select>
          </div>

          <div id="proximity-alerts-container" aria-live="polite"></div>

          <div style="text-align: center; padding-top: 10px; border-top: 1px solid #f1f1f1;">
            <a href="#" data-action="refresh" style="font-size: 0.75rem; font-weight: 700; color: #1a73e8; text-decoration: none;" role="button" tabindex="0">REFRESH ALERTS</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true" role="dialog" aria-labelledby="modalTitle">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle"><i class="fas fa-file-pdf me-2" style="color:#d93025;"></i>Daily Intelligence Briefings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label" for="reportDate">Select Date</label>
          <input type="date" class="form-control" id="reportDate" />
          <div class="form-text" style="font-size:0.8rem;margin-top:6px;">
            Leave empty for the last 24 hours (live).
          </div>
        </div>

        <div class="mb-4">
          <label class="form-label" for="reportRegion">Select Region / Report Profile</label>
          <select class="form-select" id="reportRegion">
            <option value="Global">Global</option>
            <option value="APJC">APJC</option>
            <option value="AMER">AMER</option>
            <option value="EMEA">EMEA</option>
            <option value="LATAM">LATAM</option>
          </select>
        </div>

        <div class="d-grid gap-2" style="margin-bottom:8px;">
          <button class="btn-download" data-action="preview-brief" aria-label="Preview daily briefing">
            <i class="fas fa-eye me-2" aria-hidden="true"></i> Preview Briefing
          </button>
          <button class="btn-download" data-action="download-brief" aria-label="Download briefing (generated)">
            <i class="fas fa-download me-2" aria-hidden="true"></i> Download Briefing
          </button>
        </div>

        <div id="preview-feedback" class="mt-3 text-center" style="font-size:0.85rem;display:none;" aria-live="polite"></div>
        <div id="briefing-preview" style="max-height:48vh; overflow:auto; margin-top:12px;"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="adminModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Admin Controls</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Admin Secret (Session)</label>
          <input type="password" id="adminSecret" class="form-control" placeholder="Enter Secret">
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary btn-sm" data-action="admin-save-secret">Save (Session)</button>
          <button class="btn btn-outline-danger btn-sm" data-action="admin-clear-secret">Clear</button>
        </div>
        <hr>
        <h6>Actions</h6>
        <div class="d-grid gap-2">
           <button class="btn btn-warning btn-sm" data-action="admin-trigger-ingest">Trigger Ingestion</button>
           <button class="btn btn-outline-dark btn-sm" data-action="admin-list-briefs">List Stored Briefs (Console)</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="assets-debug" class="assets-debug" aria-live="polite" style="display:none"></div>

<script>
/* ===========================
   CONFIG & STATE
=========================== */
const WORKER_URL = "https://osinfohub.vssmaximus.workers.dev";
const AUTO_REFRESH_MS = 60_000;
let INCIDENTS = [];
let PROXIMITY_INCIDENTS = [];
let FEED_IS_LIVE = false;
let currentRadius = 50;
let TRAVEL_DATA = [];
let map;
let assetsClusterGroup, incidentClusterGroup, criticalLayerGroup;
const DEBUG_UI = (new URLSearchParams(location.search).get('debug') === '1');

/* ===========================
   INIT & EVENT DELEGATION
=========================== */
document.addEventListener("DOMContentLoaded", async () => {
  // 1. Map Init
  try { initMap(); } catch(e) { console.error("Map init error", e); }
  
  // 2. Start Clock
  startClock();

  // 3. Event Delegation (Click) - The single listener for all actions
  document.addEventListener('click', async (e) => {
    const target = e.target.closest('[data-action]');
    if (!target) return;
    
    // Allow default for some interactions if needed, but usually prevent
    if(target.tagName === 'A' && target.getAttribute('href') === '#') e.preventDefault();

    const action = target.dataset.action;

    if (action === 'filter-region') {
       document.querySelectorAll('[data-action="filter-region"]').forEach(el => el.classList.remove('active'));
       target.classList.add('active');
       filterNews(target.dataset.region);
    } 
    else if (action === 'refresh') {
       manualRefresh();
    }
    else if (action === 'vote') {
       const id = target.dataset.id;
       const voteType = target.dataset.vote; // 'up' or 'down'
       voteThumb(id, voteType);
    }
    else if (action === 'dismiss-alert') {
       const id = target.dataset.id;
       target.closest('.alert-row').remove();
    }
    else if (action === 'preview-brief') {
       previewBriefing();
    }
    else if (action === 'download-brief') {
       downloadReport();
    }
    else if (action.startsWith('admin-')) {
       handleAdminAction(action);
    }
  });

  // 4. Input Wiring (Change events)
  const historyPicker = document.getElementById('history-picker');
  if(historyPicker) historyPicker.addEventListener('change', (e) => loadHistory(e.target.value));

  const countrySel = document.getElementById('countrySelect');
  if(countrySel) countrySel.addEventListener('change', filterTravel);

  const proxRad = document.getElementById('proxRadius');
  if(proxRad) proxRad.addEventListener('change', updateProximityRadius);

  // 5. Admin Secret Loading (Populate modal on show)
  const adminModal = document.getElementById('adminModal');
  if(adminModal) {
    adminModal.addEventListener('show.bs.modal', () => {
       const sec = sessionStorage.getItem('admin_secret');
       if(sec) document.getElementById('adminSecret').value = sec;
    });
  }

  // 6. Initial Load
  await loadFromWorker();
  await loadProximityFromWorker();
  filterNews("Global");
  if(window.loadTravelAdvisories) await window.loadTravelAdvisories();

  setInterval(async () => {
     if(FEED_IS_LIVE) {
        await loadFromWorker(true);
        await loadProximityFromWorker(true);
        const active = document.querySelector('.nav-item-custom.active');
        filterNews(active ? active.dataset.region : "Global");
     }
  }, AUTO_REFRESH_MS);
});

/* ===========================
   CORE LOGIC (Data Fetch)
=========================== */
async function loadFromWorker(silent=false) {
  const label = document.getElementById("feed-status-label");
  if (label && !silent) label.textContent = "Refreshing…";
  try {
    const res = await fetch(`${WORKER_URL}/api/incidents`);
    if (!res.ok) throw new Error("HTTP " + res.status);
    const raw = await res.json();
    const cutoff = Date.now() - (48 * 3600 * 1000);
    INCIDENTS = (Array.isArray(raw) ? raw : [])
      .map(normaliseWorkerIncident)
      .filter(i => i && new Date(i.time).getTime() >= cutoff)
      .sort((a,b) => new Date(b.time) - new Date(a.time));
    FEED_IS_LIVE = true;
    if (label) label.textContent = `LIVE • ${INCIDENTS.length} ITEMS`;
  } catch (e) {
    console.error("Worker fetch failed:", e);
    FEED_IS_LIVE = false;
    if (label && !silent) label.textContent = "OFFLINE • Worker unreachable";
  }
}

async function loadProximityFromWorker(silent=false) {
  try {
    const res = await fetch(`${WORKER_URL}/api/proximity`);
    if (res.ok) {
       const json = await res.json();
       const cutoff = Date.now() - (48 * 3600 * 1000);
       PROXIMITY_INCIDENTS = (Array.isArray(json.incidents) ? json.incidents : [])
         .map(normaliseWorkerIncident)
         .filter(i => i && new Date(i.time).getTime() >= cutoff);
    }
  } catch(e) { console.error("Proximity load failed", e); }
}

async function manualRefresh() {
  await loadFromWorker();
  await loadProximityFromWorker();
  const active = document.querySelector('.nav-item-custom.active');
  filterNews(active ? active.dataset.region : "Global");
}

/* ===========================
   RENDERING (Feeds & Map)
=========================== */
function filterNews(region) {
  renderAssetsOnMap(region);
  renderIncidentsOnMap(region, INCIDENTS);
  
  // General Feed
  const container = document.getElementById("general-news-feed");
  const data = (region === "Global") ? INCIDENTS : INCIDENTS.filter(i => i.region === region);
  
  if (!data.length) {
    container.innerHTML = `<div style="padding:30px;text-align:center;color:#999;">No incidents for this region.</div>`;
  } else {
    // Generate Feed Cards with Voting Buttons
    container.innerHTML = data.map(i => {
      const sev = mapSeverityToLabel(i.severity);
      return `
      <div class="feed-card">
        <div class="feed-status-bar ${sev.barClass}"></div>
        <div class="feed-content">
          <div class="feed-tags">
             <span class="ftag ${sev.badgeClass}">${sev.label}</span>
             <span class="ftag ftag-loc">${escapeHtml((i.country||"GLOBAL").toUpperCase())}</span>
             <span class="ftag ftag-type">${escapeHtml(i.category)}</span>
             <span class="feed-region">${escapeHtml(i.region)}</span>
          </div>
          <div class="feed-title"><a href="${escapeAttr(safeHref(i.link))}" target="_blank" style="text-decoration:none;color:inherit;">${escapeHtml(i.title)}</a></div>
          <div class="feed-meta">${safeTime(i.time)} • ${shortHost(i.source)}</div>
          <div class="feed-desc">${escapeHtml(i.summary)}</div>
          
          <div class="vote-row">
             <button class="btn-vote" data-action="vote" data-vote="up" data-id="${escapeAttr(i.id)}" aria-label="Vote Up" title="Helpful">
               <i class="fas fa-thumbs-up" aria-hidden="true"></i>
             </button>
             <button class="btn-vote" data-action="vote" data-vote="down" data-id="${escapeAttr(i.id)}" aria-label="Vote Down" title="Not Relevant">
               <i class="fas fa-thumbs-down" aria-hidden="true"></i>
             </button>
          </div>
        </div>
      </div>`;
    }).join('');
  }

  updateHeadline(region);
  renderProximityAlerts(region);
}

function updateProximityRadius() {
  const el = document.getElementById("proxRadius");
  if(el) currentRadius = parseFloat(el.value);
  const active = document.querySelector('.nav-item-custom.active');
  renderProximityAlerts(active ? active.dataset.region : "Global");
}

function renderProximityAlerts(region) {
  const container = document.getElementById("proximity-alerts-container");
  if(!container) return;
  const data = (region === "Global") ? PROXIMITY_INCIDENTS : PROXIMITY_INCIDENTS.filter(i => i.region === region);
  
  // Calculate distances & Find Nearest
  const alerts = [];
  data.forEach(inc => {
     let coords = (inc.lat && inc.lng) ? {lat: inc.lat, lng: inc.lng} : getCoordsForIncident(inc);
     if(!coords) return;
     
     let nearest = null;
     if(inc.distance_km && inc.nearest_site_name) {
        nearest = { dist: inc.distance_km, name: inc.nearest_site_name };
     } else {
        // Client side calc
        for (const [key, asset] of Object.entries(ASSETS)) {
           const d = haversineKm(coords.lat, coords.lng, asset.lat, asset.lng);
           if(!nearest || d < nearest.dist) nearest = { dist: d, name: asset.name };
        }
     }
     
     if(nearest && (inc.country_wide || nearest.dist <= currentRadius)) {
        alerts.push({ inc, nearest });
     }
  });

  alerts.sort((a,b) => a.nearest.dist - b.nearest.dist);

  if(!alerts.length) {
     container.innerHTML = `<div style="padding:15px;text-align:center;color:#999;">No threats within ${currentRadius}km.</div>`;
     return;
  }

  container.innerHTML = alerts.slice(0, 25).map(item => {
     const i = item.inc;
     const color = i.severity >= 4 ? '#d93025' : (i.severity===3 ? '#f9ab00' : '#1a73e8');
     const distStr = i.country_wide ? (item.nearest.dist > currentRadius ? "N/A" : `${Math.round(item.nearest.dist)}km`) : `${Math.round(item.nearest.dist)}km`;
     
     return `
     <div class="alert-row">
       <div class="alert-top">
         <div class="alert-type">
           <i class="fas fa-exclamation-circle" style="color:${color};" aria-hidden="true"></i> ${escapeHtml(i.title)}
         </div>
         <div class="alert-dist" style="color:${color}">${distStr}</div>
       </div>
       <div class="alert-site">Near: <b>${escapeHtml(item.nearest.name)}</b></div>
       <div class="alert-desc">${escapeHtml(i.summary)}</div>
       <div class="alert-actions">
          <button class="btn-dismiss" data-action="dismiss-alert" data-id="${escapeAttr(i.id)}">Dismiss</button>
       </div>
     </div>`;
  }).join('');
}

function updateHeadline(region) {
   const data = (region === "Global") ? INCIDENTS : INCIDENTS.filter(i => i.region === region);
   const el = document.getElementById("headline-alert");
   const tagEl = document.getElementById("headline-tags");
   if(data.length) {
      el.textContent = data[0].title;
      const sev = mapSeverityToLabel(data[0].severity);
      tagEl.innerHTML = `<span class="tag-crit" style="background:${data[0].severity>=4?'#d93025':'#5f6368'}">${sev.label}</span>
                         <span class="tag-cat" style="margin-left:4px;">${escapeHtml(data[0].category)}</span>
                         <span class="tag-reg" style="margin-left:4px;">${escapeHtml(data[0].region)}</span>`;
   } else {
      el.textContent = "No critical alerts.";
      tagEl.innerHTML = "";
   }
}

/* ===========================
   ACTIONS (Vote, Admin, Report)
=========================== */
async function voteThumb(id, type) {
  const secret = sessionStorage.getItem('admin_secret');
  try {
     const res = await fetch(`${WORKER_URL}/api/thumb`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...(secret ? {'secret': secret} : {}) },
        body: JSON.stringify({ id, vote: type })
     });
     if(res.ok) {
        console.log(`Voted ${type} on ${id}`);
        if(type === 'down') manualRefresh();
     }
  } catch(e) { console.error("Vote failed", e); }
}

function handleAdminAction(action) {
  const secret = document.getElementById('adminSecret')?.value;
  
  if (action === 'admin-save-secret') {
     if(secret) {
        sessionStorage.setItem('admin_secret', secret);
        alert("Secret saved to Session Storage.");
     }
  }
  else if (action === 'admin-clear-secret') {
     sessionStorage.removeItem('admin_secret');
     document.getElementById('adminSecret').value = "";
     alert("Secret cleared.");
  }
  else if (action === 'admin-trigger-ingest') {
     fetch(`${WORKER_URL}/api/ingest`, { method: 'POST', headers: { secret: sessionStorage.getItem('admin_secret') }})
     .then(r => r.text()).then(t => alert(t)).catch(e => alert(e));
  }
  else if (action === 'admin-list-briefs') {
     fetch(`${WORKER_URL}/api/dailybrief?list=true`, { headers: { secret: sessionStorage.getItem('admin_secret') }})
     .then(r => r.json()).then(d => console.log("Briefs:", d)).catch(e => console.error(e));
     alert("Check console for list.");
  }
}

async function previewBriefing() {
  const region = document.getElementById('reportRegion').value;
  const date = document.getElementById('reportDate').value;
  const fb = document.getElementById('preview-feedback');
  const cont = document.getElementById('briefing-preview');
  
  fb.style.display = 'block'; fb.textContent = "Generating preview...";
  cont.innerHTML = "";
  
  let url = `${WORKER_URL}/api/dailybrief?region=${encodeURIComponent(region)}`;
  if(date) url += `&date=${date}`;
  
  try {
     const res = await fetch(url);
     if(!res.ok) throw new Error("HTTP " + res.status);
     const json = await res.json();
     
     // Render Preview
     const incidents = json.incidents || [];
     if(!incidents.length) {
        cont.innerHTML = `<div class="safe-box">No incidents found for this period.</div>`;
     } else {
        cont.innerHTML = incidents.slice(0, 20).map(i => `
          <div style="border-bottom:1px solid #eee; padding:8px 0;">
             <div style="font-weight:700;font-size:0.9rem">${escapeHtml(i.title)}</div>
             <div style="font-size:0.8rem;color:#666">${escapeHtml(i.country)} • ${safeTime(i.time)}</div>
          </div>
        `).join('');
     }
     fb.style.display = 'none';
  } catch(e) {
     fb.textContent = "Error: " + e.message;
  }
}

async function downloadReport() {
  const region = document.getElementById('reportRegion').value;
  const date = document.getElementById('reportDate').value;
  let url = `${WORKER_URL}/api/dailybrief?region=${encodeURIComponent(region)}&download=true`;
  if(date) url += `&date=${date}`;
  
  window.open(url, '_blank');
}

async function loadHistory(dateStr) {
  const status = document.getElementById('history-status');
  status.innerHTML = "Loading archive...";
  try {
     const res = await fetch(`${WORKER_URL}/api/archive?date=${dateStr}`);
     if(!res.ok) throw new Error("Status " + res.status);
     const arr = await res.json();
     
     if(!arr || !arr.length) {
        status.innerHTML = "No archived incidents found.";
        return;
     }
     // Show simple list
     status.innerHTML = `<div style="max-height:300px;overflow:auto;margin-top:10px;">` + 
        arr.map(i => `
          <div style="margin-bottom:8px;border-bottom:1px solid #eee;padding-bottom:4px;">
            <strong>${escapeHtml(i.title)}</strong><br>
            <span style="font-size:0.8rem;color:#666">${escapeHtml(i.country)}</span>
          </div>`).join('') + 
        `</div>`;
  } catch(e) {
     status.innerHTML = "Archive error: " + e.message;
  }
}

/* ===========================
   UTILITIES & MAP SETUP
=========================== */
function startClock() {
  const container = document.getElementById("multi-clock-container");
  const zones = [
    { label: "Austin", z: "America/Chicago" },
    { label: "London", z: "Europe/London" },
    { label: "India", z: "Asia/Kolkata" },
    { label: "Singapore", z: "Asia/Singapore" },
    { label: "Tokyo", z: "Asia/Tokyo" },
    { label: "Sydney", z: "Australia/Sydney" }
  ];
  
  if(!container.innerHTML) {
     container.innerHTML = zones.map(z => `
       <div class="clock-box">
         <div class="clock-label">${z.label}</div>
         <div class="clock-val" id="clk-${z.label}">--:--</div>
       </div>`).join('');
  }
  
  setInterval(() => {
     const now = new Date();
     zones.forEach(z => {
        const el = document.getElementById(`clk-${z.label}`);
        if(el) el.textContent = now.toLocaleTimeString("en-US", { timeZone: z.z, hour12: false, hour:'2-digit', minute:'2-digit' });
     });
  }, 1000);
}

function normaliseWorkerIncident(i) {
  if(!i || !i.title) return null;
  return {
    id: i.id || (i.title + i.time),
    title: i.title,
    summary: i.summary || i.description || "",
    link: i.link || i.url || "#",
    time: i.time || new Date().toISOString(),
    severity: Number(i.severity)||1,
    region: (i.region || "GLOBAL").toUpperCase(),
    country: (i.country || "GLOBAL").toUpperCase(),
    category: (i.category || "UNKNOWN").toUpperCase(),
    lat: Number(i.lat)||0, lng: Number(i.lng)||0,
    source: i.source || "",
    distance_km: i.distance_km ? Number(i.distance_km) : null,
    nearest_site_name: i.nearest_site_name || null,
    country_wide: !!i.country_wide
  };
}

// Map Helpers
const DELL_SITES = [
  { name: "Dell Round Rock HQ", country: "US", region: "AMER", lat: 30.5083, lon: -97.6788 },
  { name: "Dell Austin Parmer", country: "US", region: "AMER", lat: 30.3952, lon: -97.6843 },
  { name: "Dell Hopkinton", country: "US", region: "AMER", lat: 42.2287, lon: -71.5226 },
  { name: "Dell Franklin", country: "US", region: "AMER", lat: 42.0834, lon: -71.3967 },
  { name: "Dell Apex", country: "US", region: "AMER", lat: 35.7327, lon: -78.8503 },
  { name: "Dell Eden Prairie", country: "US", region: "AMER", lat: 44.8617, lon: -93.4168 },
  { name: "Dell Draper", country: "US", region: "AMER", lat: 40.5240, lon: -111.8950 },
  { name: "Dell Nashville Hub", country: "US", region: "AMER", lat: 36.1627, lon: -86.7816 },
  { name: "Dell Oklahoma City", country: "US", region: "AMER", lat: 35.4676, lon: -97.5164 },
  { name: "Dell Santa Clara", country: "US", region: "AMER", lat: 37.3541, lon: -121.9552 },
  { name: "Dell McLean", country: "US", region: "AMER", lat: 38.9295, lon: -77.2268 },
  { name: "Dell El Paso", country: "US", region: "AMER", lat: 31.8385, lon: -106.5278 },
  { name: "Dell Toronto", country: "CA", region: "AMER", lat: 43.6532, lon: -79.3832 },
  { name: "Dell Mexico City", country: "MX", region: "AMER", lat: 19.4326, lon: -99.1332 },
  { name: "Dell Hortolândia Mfg", country: "BR", region: "LATAM", lat: -22.8583, lon: -47.2208 },
  { name: "Dell São Paulo", country: "BR", region: "LATAM", lat: -23.5505, lon: -46.6333 },
  { name: "Dell Porto Alegre", country: "BR", region: "LATAM", lat: -30.0346, lon: -51.2177 },
  { name: "Dell Panama City", country: "PA", region: "LATAM", lat: 8.9824, lon: -79.5199 },
  { name: "Dell Lodz Mfg", country: "PL", region: "EMEA", lat: 51.7285, lon: 19.4967 },
  { name: "Dell Limerick", country: "IE", region: "EMEA", lat: 52.6638, lon: -8.6267 },
  { name: "Dell Dublin Cherrywood", country: "IE", region: "EMEA", lat: 53.2374, lon: -6.1450 },
  { name: "Dell Cork Campus", country: "IE", region: "EMEA", lat: 51.8985, lon: -8.4756 },
  { name: "Dell Herzliya", country: "IL", region: "EMEA", lat: 32.1644, lon: 34.7961 },
  { name: "Dell Haifa", country: "IL", region: "EMEA", lat: 32.7940, lon: 34.9896 },
  { name: "Dell Beer Sheva", country: "IL", region: "EMEA", lat: 31.2626, lon: 34.8016 },
  { name: "Dell Bracknell", country: "GB", region: "EMEA", lat: 51.4160, lon: -0.7540 },
  { name: "Dell Glasgow", country: "GB", region: "EMEA", lat: 55.8642, lon: -4.2518 },
  { name: "Dell Montpellier", country: "FR", region: "EMEA", lat: 43.6108, lon: 3.8767 },
  { name: "Dell Paris / Bezons", country: "FR", region: "EMEA", lat: 48.8566, lon: 2.3522 },
  { name: "Dell Frankfurt", country: "DE", region: "EMEA", lat: 50.1109, lon: 8.6821 },
  { name: "Dell Halle", country: "DE", region: "EMEA", lat: 51.4820, lon: 11.9700 },
  { name: "Dell Amsterdam", country: "NL", region: "EMEA", lat: 52.3676, lon: 4.9041 },
  { name: "Dell Casablanca", country: "MA", region: "EMEA", lat: 33.5731, lon: -7.5898 },
  { name: "Dell Cairo", country: "EG", region: "EMEA", lat: 30.0444, lon: 31.2357 },
  { name: "Dell Dubai", country: "AE", region: "EMEA", lat: 25.2048, lon: 55.2708 },
  { name: "Dell Bangalore", country: "IN", region: "APJC", lat: 12.9716, lon: 77.5946 },
  { name: "Dell Hyderabad", country: "IN", region: "APJC", lat: 17.3850, lon: 78.4867 },
  { name: "Dell Gurugram", country: "IN", region: "APJC", lat: 28.4595, lon: 77.0266 },
  { name: "Dell Sriperumbudur Mfg", country: "IN", region: "APJC", lat: 12.9560, lon: 79.9410 },
  { name: "Dell Singapore", country: "SG", region: "APJC", lat: 1.3521, lon: 103.8198 },
  { name: "Dell Penang", country: "MY", region: "APJC", lat: 5.4164, lon: 100.3327 },
  { name: "Dell Cyberjaya", country: "MY", region: "APJC", lat: 2.9213, lon: 101.6559 },
  { name: "Dell Xiamen Mfg", country: "CN", region: "APJC", lat: 24.4798, lon: 118.0894 },
  { name: "Dell Chengdu Mfg", country: "CN", region: "APJC", lat: 30.5728, lon: 104.0668 },
  { name: "Dell Shanghai", country: "CN", region: "APJC", lat: 31.2304, lon: 121.4737 },
  { name: "Dell Taipei", country: "TW", region: "APJC", lat: 25.0330, lon: 121.5654 },
  { name: "Dell Tokyo", country: "JP", region: "APJC", lat: 35.6762, lon: 139.6503 },
  { name: "Dell Kawasaki", country: "JP", region: "APJC", lat: 35.5300, lon: 139.6960 },
  { name: "Dell Sydney", country: "AU", region: "APJC", lat: -33.8688, lon: 151.2093 },
  { name: "Dell Melbourne", country: "AU", region: "APJC", lat: -37.8136, lon: 144.9631 }
];
const ASSETS = {};
DELL_SITES.forEach(s => ASSETS[s.name.toLowerCase()] = s);

// City Lookup
const CITY_COORDS = {
  "london": {lat:51.5074, lng:-0.1278}, "paris": {lat:48.8566, lng:2.3522},
  "sydney": {lat:-33.8688, lng:151.2093}, "tokyo": {lat:35.6762, lng:139.6503},
  "new york": {lat:40.7128, lng:-74.0060}, "beijing": {lat:39.9042, lng:116.4074},
  "singapore": {lat:1.3521, lng:103.8198}, "dubai": {lat:25.2048, lng:55.2708},
  "mumbai": {lat:19.0760, lng:72.8777}, "delhi": {lat:28.6139, lng:77.2090},
  "bangalore": {lat:12.9716, lng:77.5946}, "moscow": {lat:55.7558, lng:37.6173},
  "kyiv": {lat:50.4501, lng:30.5234}, "shanghai": {lat:31.2304, lng:121.4737},
  "hong kong": {lat:22.3193, lng:114.1694}, "taipei": {lat:25.0330, lng:121.5654},
  "mexico city": {lat:19.4326, lng:-99.1332}, "sao paulo": {lat:-23.5505, lng:-46.6333}
};

function getCoordsForIncident(i) {
  if(i.lat && i.lng) return {lat: i.lat, lng: i.lng};
  const loc = (i.location || "").toLowerCase();
  for(const [city, c] of Object.entries(CITY_COORDS)) {
     if(loc.includes(city)) return c;
  }
  return null; 
}

function initMap() {
  if(typeof L === 'undefined') return;
  map = L.map('map', {zoomControl: false}).setView([20,0], 2);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
     attribution: '&copy; OpenStreetMap &copy; CARTO'
  }).addTo(map);
  L.control.zoom({position: 'topleft'}).addTo(map);
  
  incidentClusterGroup = L.markerClusterGroup({ maxClusterRadius: 40 });
  assetsClusterGroup = L.layerGroup();
  criticalLayerGroup = L.layerGroup();
  
  map.addLayer(assetsClusterGroup);
  map.addLayer(incidentClusterGroup);
  map.addLayer(criticalLayerGroup);
}

function renderAssetsOnMap(region) {
  if(!assetsClusterGroup) return;
  assetsClusterGroup.clearLayers();
  Object.values(ASSETS).forEach(a => {
     if(region === "Global" || a.region === region) {
        L.marker([a.lat, a.lon], {
           icon: L.divIcon({className: 'custom-pin', html: '<div class="marker-pin-dell"><i class="fas fa-building"></i></div>', iconSize:[30,42], iconAnchor:[15,42]})
        }).bindTooltip(a.name).addTo(assetsClusterGroup);
     }
  });
}

function renderIncidentsOnMap(region, list) {
  if(!incidentClusterGroup) return;
  incidentClusterGroup.clearLayers();
  criticalLayerGroup.clearLayers();
  
  const data = (region === "Global") ? list : list.filter(i => i.region === region);
  data.forEach(i => {
     const c = (i.lat && i.lng) ? {lat:i.lat, lng:i.lng} : getCoordsForIncident(i);
     if(!c) return;
     
     const color = i.severity >= 4 ? '#d93025' : '#1a73e8';
     const marker = L.marker([c.lat, c.lng], {
        icon: L.divIcon({html: `<div class="incident-dot" style="background:${color}"></div>`, className:'', iconSize:[12,12]})
     }).bindPopup(`<b>${escapeHtml(i.title)}</b><br>${safeTime(i.time)}`);
     
     if(i.severity >= 4) criticalLayerGroup.addLayer(marker);
     else incidentClusterGroup.addLayer(marker);
  });
}

function mapSeverityToLabel(s) {
   if(s>=5) return { label: "CRITICAL", badgeClass: "ftag-crit", barClass: "status-bar-crit" };
   if(s>=4) return { label: "HIGH", badgeClass: "ftag-crit", barClass: "status-bar-crit" };
   if(s===3) return { label: "MEDIUM", badgeClass: "ftag-warn", barClass: "status-bar-warn" };
   return { label: "LOW", badgeClass: "ftag-info", barClass: "status-bar-info" };
}

// CONSTANTS FOR TRAVEL
const CONST_COUNTRIES = ["Australia","Brazil","China","France","Germany","India","Ireland","Israel","Japan","Mexico","Singapore","UK","USA"];

// Helpers
function haversineKm(lat1,lon1,lat2,lon2) {
  const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180;
  const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
function shortHost(u){ try{return new URL(u).hostname.replace(/^www\./,'');}catch{return "Source";}}
function safeHref(u){ try{return new URL(u,location.href).href;}catch{return "#";}}
function safeTime(t){ try{return new Date(t).toLocaleString();}catch{return "Recently";}}
function escapeHtml(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }
function escapeAttr(s){ return String(s||"").replace(/"/g,"&quot;"); }

/* Travel Fallback (if worker endpoint fails/missing) */
async function loadTravelAdvisories() {
   const sel = document.getElementById('countrySelect');
   if(!sel) return;
   // Try worker live first
   try {
     const res = await fetch(`${WORKER_URL}/api/traveladvisories/live`);
     if(res.ok) {
       const data = await res.json();
       TRAVEL_DATA = Array.isArray(data) ? data : [];
     }
   } catch(e) {}
   
   // Populate Dropdown
   sel.innerHTML = `<option selected disabled>Select Country</option>` + 
      CONST_COUNTRIES.map(c => `<option value="${c}">${c}</option>`).join('');
}
async function filterTravel() {
   const country = document.getElementById('countrySelect').value;
   const cont = document.getElementById('travel-advisories');
   cont.innerHTML = "Loading...";
   try {
      const res = await fetch(`${WORKER_URL}/api/traveladvisories?country=${encodeURIComponent(country)}`);
      const data = await res.json();
      const adv = data.advisory || data;
      cont.innerHTML = `
        <div class="advisory-box">
           <div style="font-weight:700">Official Advisory (Level ${adv.level||1})</div>
           <div style="font-size:0.9rem;margin-top:4px;">${escapeHtml(adv.text || "No major advisory.")}</div>
        </div>`;
   } catch(e) { cont.innerHTML = "Advisory unavailable."; }
}
/* Expose functions for debugging */
window.loadTravelAdvisories = loadTravelAdvisories;
window.filterTravel = filterTravel;
window.loadHistory = loadHistory;
</script>
</body>
</html>
