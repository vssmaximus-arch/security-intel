<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let newsData = [];
    let myChart = null;

    function switchTab(tab) {
        // Hide everything
        document.getElementById('feed-view').style.display = 'none';
        document.getElementById('chart-container').style.display = 'none';
        document.getElementById('map-frame').style.display = 'none';
        document.getElementById('travel-view').style.display = 'none';

        if (tab === 'feed') {
            document.getElementById('feed-view').style.display = 'block';
        } else if (tab === 'trends') {
            document.getElementById('chart-container').style.display = 'block';
            renderChart();
        } else if (tab === 'map') {
            document.getElementById('map-frame').style.display = 'block';
        } else if (tab === 'travel') {
            document.getElementById('travel-view').style.display = 'block';
            populateCountries();
        }
    }

    async function fetchNews() {
        try {
            const ts = Date.now();

            // ---- NEWS ----
            const r = await fetch('data/news.json?t=' + ts);
            if (r.ok) {
                const db = await r.json();            // <- read the object
                newsData = db.events || [];           // <- use the events array

                document.getElementById('last-updated').innerText =
                    "Items: " + newsData.length;

                renderNews();
            } else {
                console.error('Failed to load news.json', r.status);
            }

            // ---- FORECAST (optional) ----
            const r2 = await fetch('data/forecast.json?t=' + ts);
            if (r2.ok) {
                const fc = await r2.json();
                document.getElementById('forecast-display').style.display = 'block';
                document.getElementById('fc-analysis').innerText =
                    fc.analysis || "No forecast available.";
            }
        } catch (e) {
            console.error('fetchNews error', e);
        }
    }

    function renderNews() {
        if (!Array.isArray(newsData)) return;

        const reg = document.getElementById('regionFilter').value;
        const cat = document.getElementById('typeFilter').value;
        const src = document.getElementById('searchBox').value.toLowerCase();
        const con = document.getElementById('news-feed');
        con.innerHTML = '';

        // Map UI risk types to backend categories
        const catMap = {
            "Physical Security": "Physical",
            "Crisis/Disaster": "Weather",
            "Logistics/Supply Chain": "Logistics",
            "Cyber/InfoSec": "Cyber",
            "Executive/Travel": null,   // no direct mapping yet
            "Infrastructure": null      // could map to Physical/Weather depending on taste
        };

        const filtered = newsData.filter(i => {
            const regionOk = (reg === 'All' || i.region === reg);

            let categoryOk = true;
            if (cat !== 'All') {
                const mapped = catMap[cat];
                if (mapped) {
                    categoryOk = (i.category === mapped);
                } else {
                    // for Executive/Travel / Infrastructure, just show all for now
                    categoryOk = true;
                }
            }

            const title = (i.title || '').toLowerCase();
            const impact = (i.impact_summary || '').toLowerCase();
            const summary = (i.summary || '').toLowerCase();
            const searchOk =
                title.includes(src) || impact.includes(src) || summary.includes(src);

            return regionOk && categoryOk && searchOk;
        });

        if (filtered.length === 0) {
            con.innerHTML = "<p class='text-center text-muted'>No active threats.</p>";
            return;
        }

        filtered.forEach(i => {
            const severity = Number(i.severity || 1);
            const color = severity === 3 ? '#dc3545' :
                          severity === 2 ? '#ffc107' : '#6c757d';

            const snippet =
                i.impact_summary ||
                i.summary ||
                "No summary available.";

            const when = (i.published || '').slice(0, 16).replace('T', ' ') || '';

            const region = i.region || 'Global';
            const source = i.source || '';
            const link = i.link || '#';

            con.innerHTML += `
                <div class="card mb-2" style="border-left: 5px solid ${color}">
                    <div class="card-body">
                        <strong>${region}</strong>
                        &nbsp;|&nbsp;
                        <a href="${link}" target="_blank">${i.title || 'Untitled incident'}</a><br>
                        <small class="text-muted">
                            ${source} • ${when} • Severity ${severity}
                        </small>
                        <p class="mt-2 mb-0 small">${snippet}</p>
                    </div>
                </div>`;
        });
    }

    function renderChart() {
        if (!Array.isArray(newsData) || newsData.length === 0) return;

        if (myChart) myChart.destroy();

        const counts = {};
        newsData.forEach(i => {
            const dateKey = (i.published || '').slice(0, 10) || 'Unknown';
            counts[dateKey] = (counts[dateKey] || 0) + 1;
        });

        const labels = Object.keys(counts).sort();
        const data = labels.map(d => counts[d]);

        const ctx = document.getElementById('riskChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: 'Incidents',
                    data,
                    backgroundColor: '#0076CE'
                }]
            }
        });
    }

    function populateCountries() {
        const sel = document.getElementById('travelCountry');
        const list = [
            "Australia","Brazil","China","France","Germany","India","Israel",
            "Japan","Korea","Malaysia","Mexico","Singapore","UK","USA","Vietnam"
        ];
        sel.innerHTML = '<option>Select Country...</option>';
        list.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
    }

    function renderTravelCheck() {
        if (!Array.isArray(newsData)) return;

        const c = document.getElementById('travelCountry').value;
        const hits = newsData.filter(i => {
            const country = (i.country || '');
            const title = (i.title || '');
            const impact = (i.impact_summary || '');
            return country === c ||
                   title.includes(c) ||
                   impact.includes(c);
        });

        const container = document.getElementById('travel-feed');
        if (hits.length === 0) {
            container.innerHTML =
                "<div class='alert alert-success'>No threats detected.</div>";
            return;
        }

        container.innerHTML = hits.map(i =>
            `<div class="alert alert-warning">
                <strong>${i.title}</strong><br>
                ${i.impact_summary || ''}
             </div>`
        ).join('');
    }
</script>
