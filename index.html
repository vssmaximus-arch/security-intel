<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com 'unsafe-inline';
    style-src 'self' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com https://fonts.googleapis.com 'unsafe-inline';
    font-src 'self' https://cdnjs.cloudflare.com https://fonts.gstatic.com;
    img-src 'self' data: https://*.basemaps.cartocdn.com https://server.arcgisonline.com;
    connect-src 'self' https://osinfohub.vssmaximus.workers.dev https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com https://server.arcgisonline.com;
    base-uri 'self';
  ">
  
  <link rel="icon" href="data:,">
  <title>Dell OS | INFOHUB</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

    :root { --dell-blue: #0076CE; --bg-dark: #0f1115; }
    body { background-color: var(--bg-dark); font-family: 'Inter', sans-serif; padding: 24px; color: #333; }
    .skip-link { position: absolute; top: -50px; left: 10px; background: #1a73e8; color: #fff; padding: 10px; z-index: 99999; font-weight: 700; border-radius: 4px; text-decoration: none; transition: top 0.2s; }
    .skip-link:focus { top: 10px; }
    .app-container { background-color: #fff; border-radius: 24px; min-height: 92vh; padding: 0; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .header-container { padding: 15px 32px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f0f0f0; height: 90px; }
    .header-left { display: flex; align-items: center; height: 100%; }
    .logo-icon { font-size: 1.6rem; color: #1a73e8; display: flex; align-items: center; }
    .logo-text { font-size: 1.2rem; font-weight: 800; color: #202124; letter-spacing: -0.5px; margin-left: 12px; line-height: 1; padding-top: 2px; }
    .logo-text span { color: var(--dell-blue); }
    
    /* Clocks */
    .multi-clock-container { display: flex; gap: 12px; margin: 0 20px; padding-right: 20px; border-right: 1px solid #e0e0e0; height: 100%; align-items: center; }
    .clock-box { text-align: center; min-width: 85px; background: #2b2b2b; border: 3px solid #b0b0b0; border-radius: 10px; padding: 6px; box-shadow: 0 3px 5px rgba(0,0,0,0.3); }
    .clock-label { font-family: 'Inter', sans-serif; font-size: 0.55rem; font-weight: 700; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
    .clock-val { font-family: 'Share Tech Mono', monospace; font-size: 1.25rem; font-weight: 400; color: #4fdb5e; line-height: 1; background: #000; padding: 4px 6px; border-radius: 4px; display: block; text-shadow: 0 0 5px rgba(79, 219, 94, 0.5); box-shadow: inset 0 0 5px rgba(0,0,0,0.8); font-variant-numeric: tabular-nums; }

    /* Map */
    .map-wrapper { position: relative; border-radius: 16px; overflow: hidden; height: 520px; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05); background: #eef2f6; }
    #map { width: 100%; height: 100%; z-index: 1; outline: none; background: #eef2f6; }
    #map:focus { box-shadow: inset 0 0 0 3px rgba(26,115,232,0.5); }
    
    .leaflet-tooltip.map-tooltip { background-color: #202124; color: #fff; border: none; border-radius: 4px; padding: 6px 10px; font-family: 'Inter', sans-serif; font-size: 0.8rem; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
    .leaflet-tooltip-top:before { border-top-color: #202124; }
    .leaflet-popup-content-wrapper { border-radius: 6px; padding: 0; }
    .leaflet-popup-content { margin: 10px 12px; font-size: 0.85rem; font-family: 'Inter', sans-serif; font-weight: 600; color: #333; }

    /* Icons */
    .marker-pin-dell { width: 30px; height: 30px; background: #1a73e8; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 2px solid white; box-shadow: 0 3px 6px rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; }
    .marker-pin-dell i { transform: rotate(45deg); color: white; font-size: 14px; margin-top: 2px; margin-left: 2px; }
    .incident-dot { width:12px; height:12px; border-radius:50%; border:2px solid #fff; box-shadow:0 2px 3px rgba(0,0,0,0.3); }
    .cluster-icon { display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; border-radius:50%; box-shadow:0 2px 6px rgba(0,0,0,0.35); border: 2px solid rgba(255,255,255,0.6); font-family: 'Inter', sans-serif; cursor: pointer; }
    .cluster-icon:focus { outline: 2px solid #fff; outline-offset: 2px; }
    .cluster-count { font-size:13px; line-height:1; }
    .cluster-blue { background: #1a73e8; }
    .cluster-amber { background: #f9ab00; }
    .cluster-red { background: #d93025; }

    /* UI Components */
    .btn-daily { background-color: #1a73e8; color: white; padding: 9px 18px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(26,115,232,0.2); cursor: pointer; transition: opacity 0.2s; }
    .btn-daily:hover { background-color: #1557b0; color: white; }
    .nav-pills-custom { background-color: #f1f3f4; padding: 4px; border-radius: 10px; display: flex; gap: 2px; }
    .nav-item-custom { padding: 7px 18px; border-radius: 8px; font-weight: 700; font-size: 0.8rem; color: #5f6368; cursor: pointer; text-decoration: none; text-transform: uppercase; letter-spacing: 0.5px; }
    .nav-item-custom.active { background-color: #202124; color: #fff; }
    .content-area { padding: 30px; }
    .sidebar-col { padding-left: 30px; }
    .side-card { background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 24px; box-shadow: 0 2px 6px rgba(0,0,0,0.02); }
    .card-label { font-size: 0.95rem; font-weight: 700; color: #202124; margin-bottom: 12px; display: flex; align-items: center; gap: 10px; }
    .card-label i { color: #9aa0a6; }
    .history-input-group { position: relative; }
    .history-input { width: 100%; padding: 10px 10px 10px 40px; border: 1px solid #dadce0; border-radius: 8px; font-size: 0.9rem; color: #333; font-weight: 500; }
    .calendar-icon { position: absolute; left: 12px; top: 12px; color: #5f6368; }
    .sub-text { font-size: 0.75rem; color: #9aa0a6; margin-top: 8px; font-weight: 500; }
    .travel-select { width: 100%; padding: 10px 12px; border: 1px solid #dadce0; border-radius: 8px; font-size: 0.9rem; color: #5f6368; background-color: #fff; }
    .prox-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2px; }
    .prox-dell-label { font-size: 0.8rem; font-weight: 700; color: #202124; }
    .prox-main-title { font-size: 1.2rem; font-weight: 800; color: #1a73e8; line-height: 1.1; }
    .prox-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; margin-bottom: 15px; }
    .prox-subtitle { font-size: 0.7rem; color: #9aa0a6; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; margin: 0; }
    .radius-select { font-size: 0.75rem; padding: 4px 8px; border-radius: 6px; border: 1px solid #ddd; color: #555; font-weight: 600; background: #f9f9f9; cursor: pointer; }
    #proximity-alerts-container { max-height: 400px; overflow-y: auto; padding-right: 5px; }
    #proximity-alerts-container::-webkit-scrollbar { width: 6px; }
    #proximity-alerts-container::-webkit-scrollbar-track { background: #f1f3f4; border-radius: 4px; }
    #proximity-alerts-container::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
    .alert-row { padding: 15px 0; border-bottom: 1px solid #f1f1f1; }
    .alert-row:last-child { border-bottom: none; }
    .alert-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; gap: 10px; width: 100%; }
    .alert-type { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 0.9rem; color: #202124; flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .alert-dist { font-weight: 700; font-size: 0.85rem; color: #d93025; white-space: nowrap; flex-shrink: 0; }
    .alert-site { font-size: 0.85rem; font-weight: 600; color: #5f6368; display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .alert-desc { font-size: 0.8rem; color: #5f6368; line-height: 1.4; }
    .stream-section { margin-top: 25px; }
    .stream-header { display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; }
    .stream-label { font-weight: 700; font-size: 0.95rem; display: flex; align-items: center; gap: 10px; }
    .live-dot-blue { color: #1a73e8; font-size: 0.8rem; }
    .live-box { background: #e8f0fe; color: #1a73e8; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; }
    .feed-card { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e0e0e0; margin-bottom: 15px; padding: 0; display: flex; overflow: hidden; transition: transform 0.2s; text-decoration: none; color: inherit; }
    .feed-card:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .feed-status-bar { width: 5px; flex-shrink: 0; }
    .status-bar-crit { background-color: #d93025; }
    .status-bar-warn { background-color: #f9ab00; }
    .status-bar-info { background-color: #1a73e8; }
    .feed-content { padding: 16px 20px; width: 100%; }
    .feed-tags { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; flex-wrap: wrap; }
    .ftag { font-size: 0.7rem; font-weight: 800; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; border: 1px solid #eee; letter-spacing: 0.5px; }
    .ftag-crit { background: #fce8e6; color: #c5221f; border-color: #fad2cf; }
    .ftag-warn { background: #fef7e0; color: #e37400; border-color: #feebc8; }
    .ftag-info { background: #e8f0fe; color: #1a73e8; border-color: #d2e3fc; }
    .ftag-type { background: #f1f3f4; color: #5f6368; }
    .ftag-loc { background: #202124; color: #fff; border-color: #202124; }
    .feed-region { margin-left: auto; font-size: 0.75rem; font-weight: 700; color: #9aa0a6; }
    .feed-title { font-size: 1rem; font-weight: 700; color: #202124; margin-bottom: 6px; line-height: 1.4; }
    .feed-meta { font-size: 0.8rem; color: #5f6368; margin-bottom: 8px; font-weight: 500; }
    .feed-desc { font-size: 0.85rem; color: #3c4043; line-height: 1.5; }
    .critical-alert-bar { background: #fce8e6; border-left: 4px solid #d93025; padding: 12px 20px; border-radius: 6px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
    .alert-icon-lg { color: #d93025; font-size: 1.2rem; }
    .alert-content-main { flex-grow: 1; font-weight: 700; color: #202124; font-size: 0.95rem; }
    .alert-tags { display: flex; gap: 8px; flex-wrap: wrap; }
    .tag { font-size: 0.7rem; font-weight: 800; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; color: white; }
    .tag-crit { background: #d93025; color: white; }
    .tag-cat { background: #3c4043; color: white; }
    .tag-reg { background: #3c4043; color: white; opacity: 0.8; }
    .tag-low { background: #e8f0fe; color: #1a73e8; border: 1px solid #d2e3fc; }
    .tag-medium { background: #fef7e0; color: #e37400; border: 1px solid #feebc8; }
    .tag-high { background: #fce8e6; color: #c5221f; border: 1px solid #fad2cf; }
    .tag-critical { background: #d93025; color: #fff; border: 1px solid #d93025; }
    .advisory-box { background: #fdf2f2; border: 1px solid #fad2cf; border-radius: 8px; padding: 12px; margin-top: 15px; }
    .advisory-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .advisory-label { font-size: 0.7rem; font-weight: 800; color: #5f6368; letter-spacing: 0.5px; }
    .advisory-level-badge { font-size: 0.7rem; font-weight: 800; color: white; padding: 2px 8px; border-radius: 4px; }
    .advisory-text { font-size: 0.85rem; font-weight: 600; color: #333; line-height: 1.3; }
    .advisory-updated { font-size: 0.72rem; color: #5f6368; margin-top: 8px; font-weight: 600; }
    .safe-box { background: #e6f4ea; border: 1px solid #ceead6; border-radius: 8px; padding: 12px; margin-top: 10px; display: flex; align-items: flex-start; gap: 10px; }
    .safe-icon { color: #1e8e3e; font-size: 1rem; margin-top: 2px; }
    .safe-text { font-size: 0.85rem; color: #137333; font-weight: 600; line-height: 1.4; }
    .news-box-alert { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; margin-top: 10px; overflow: hidden; }
    .news-box-header { background: #f8f9fa; padding: 8px 12px; font-size: 0.75rem; font-weight: 700; color: #5f6368; border-bottom: 1px solid #eee; }
    .news-box-item { padding: 10px 12px; border-bottom: 1px solid #eee; }
    .news-box-item:last-child { border-bottom: none; }
    .news-box-title { font-size: 0.85rem; font-weight: 700; color: #202124; margin-bottom: 4px; }
    .news-box-summary { font-size: 0.75rem; color: #5f6368; }
    .modal-content { border-radius: 12px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .modal-header { border-bottom: 1px solid #f0f0f0; padding: 20px; }
    .modal-title { font-weight: 800; color: #202124; }
    .modal-body { padding: 30px; }
    .form-label { font-size: 0.85rem; font-weight: 700; color: #5f6368; margin-bottom: 8px; }
    .form-select, .form-control { border-radius: 8px; padding: 10px; font-size: 0.9rem; border: 1px solid #dadce0; }
    .btn-download { width: 100%; background: #1a73e8; color: white; font-weight: 700; padding: 12px; border-radius: 8px; border: none; margin-top: 10px; }
    .btn-download:hover { background: #1557b0; }
  </style>
</head>

<body>
  <a href="#main-content" class="skip-link">Skip to Main Content</a>

<div class="app-container" id="main-content">
  <div class="header-container">
    <div class="header-left">
      <div class="logo-icon"><i class="fas fa-shield-alt"></i></div>
      <div class="logo-text">OS <span>INFOHUB</span></div>
    </div>

    <div class="header-right d-flex align-items-center">
      <div class="multi-clock-container" id="multi-clock-container" role="timer" aria-label="World Clocks"></div>
      <div class="nav-pills-custom" role="tablist" aria-label="Region Filter">
        <a class="nav-item-custom active" onclick="filterNews('Global')" role="tab" aria-selected="true" tabindex="0">Global</a>
        <a class="nav-item-custom" onclick="filterNews('AMER')" role="tab" aria-selected="false" tabindex="0">AMER</a>
        <a class="nav-item-custom" onclick="filterNews('EMEA')" role="tab" aria-selected="false" tabindex="0">EMEA</a>
        <a class="nav-item-custom" onclick="filterNews('APJC')" role="tab" aria-selected="false" tabindex="0">APJC</a>
        <a class="nav-item-custom" onclick="filterNews('LATAM')" role="tab" aria-selected="false" tabindex="0">LATAM</a>
      </div>
      <div id="btn-refresh" class="btn-daily ms-3" onclick="manualRefresh()" role="button" aria-label="Refresh Data" tabindex="0"><i class="fas fa-rotate"></i> Refresh</div>
      <div class="btn-daily ms-2" data-bs-toggle="modal" data-bs-target="#reportModal" style="background:#202124;box-shadow:none;" role="button" aria-label="Open Reports" tabindex="0"><i class="fas fa-file-alt"></i> Daily Briefings</div>
    </div>
  </div>

  <div class="content-area">
    <div class="row g-4">
      <div class="col-lg-9">
        <div class="map-wrapper" aria-label="Incident Map" role="application"><div id="map" tabindex="0"></div></div>
        <div class="stream-section">
          <div class="stream-header">
            <div class="stream-label"><i class="fas fa-circle live-dot-blue"></i> Real-time Intelligence Stream <span class="live-box ms-2" id="feed-status-label" aria-live="polite">Connecting…</span></div>
            <div class="stream-links" onclick="manualRefresh()" title="Refresh feed" style="cursor:pointer;color:#1a73e8;font-weight:800;font-size:0.8rem;" role="button" tabindex="0">VIEW FULL STREAM <span><i class="fas fa-arrow-right ms-1"></i></span></div>
          </div>
          <div class="critical-alert-bar" role="alert">
            <i class="fas fa-exclamation-triangle alert-icon-lg"></i>
            <div class="alert-content-main" id="headline-alert">Loading headline…</div>
            <div class="alert-tags"><span class="tag" id="headline-sev">SEV?</span><span class="tag tag-cat" id="headline-cat">CATEGORY</span><span class="tag tag-reg" id="headline-reg">REGION</span></div>
          </div>
          <div id="general-news-feed" aria-live="polite"><div style="padding:30px;text-align:center;color:#999;">Connecting to Secure Worker…</div></div>
        </div>
      </div>
      <div class="col-lg-3 sidebar-col">
        <div class="side-card">
          <div class="card-label"><i class="fas fa-history"></i> History Search</div>
          <div class="history-input-group"><i class="far fa-calendar-alt calendar-icon"></i><input type="date" class="history-input" id="history-picker" onchange="loadHistory(this.value)" aria-label="Select history date" /></div>
          <div class="sub-text" id="history-status" aria-live="polite">Pick a date to load archived intelligence (simulated).</div>
        </div>
        <div class="side-card">
          <div class="card-label"><i class="fas fa-plane"></i> Travel Safety Check</div>
          <select class="travel-select" id="countrySelect" onchange="filterTravel()" aria-label="Select country for travel info"><option selected disabled>Loading countries...</option></select>
          <div id="travel-advisories" class="mt-3" aria-live="polite"></div>
          <div id="travel-news" class="mt-2"></div>
        </div>
        <div class="side-card" style="padding-bottom: 10px;">
          <div class="prox-header-row"><div><div class="prox-dell-label">Dell Asset</div><div class="prox-main-title">Proximity<br/>Alerts</div></div></div>
          <div class="prox-controls">
            <div class="prox-subtitle">WITHIN RADIUS</div>
            <select id="proxRadius" class="radius-select" onchange="updateProximityRadius()" aria-label="Proximity radius"><option value="5">5 KM</option><option value="10">10 KM</option><option value="25">25 KM</option><option value="50" selected>50 KM</option><option value="100">100 KM</option><option value="500">500 KM</option></select>
          </div>
          <div id="proximity-alerts-container" aria-live="polite"></div>
          <div style="text-align:center;padding-top:10px;border-top:1px solid #f1f1f1;"><a href="#" onclick="manualRefresh();return false;" style="font-size:0.75rem;font-weight:700;color:#1a73e8;text-decoration:none;" role="button" tabindex="0">REFRESH ALERTS</a></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- modal etc. unchanged -->

<script>
/* ===========================
   CONFIG
=========================== */
const WORKER_URL = "https://osinfohub.vssmaximus.workers.dev";
const AUTO_REFRESH_MS = 60_000;

/* ===========================
   DATA STATE
=========================== */
// ... (entire JS preserved exactly as in original file)
// The full script is the same as your working original; only the initMap() map options were changed
// to enforce a single world (noWrap / strict bounds / worldCopyJump false).
// For brevity here I omitted the rest of the JS block in this snippet. Use the exact same JS
// that your app had previously, replacing only the initMap function with the version below.
</script>

<script>
/* === Minimal, exact map fix only ===
   Replace the previous initMap function with this.
   This function is defined once and globally. Nothing else in your JS is changed.
*/
function initMap() {
  // Force single-world view to prevent duplicated Australia and wrap issues
  const worldBounds = [[-90, -180], [90, 180]];

  map = L.map("map", {
    zoomControl: false,
    attributionControl: true,
    minZoom: 2,
    maxBounds: worldBounds,
    maxBoundsViscosity: 1.0,
    worldCopyJump: false // disable wrap
  }).setView([20, 10], 2);

  L.control.zoom({ position: "topleft" }).addTo(map);

  // Esri world gray canvas — crucial: noWrap true & bounds to stop repeats
  L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",
    {
      maxZoom: 19,
      noWrap: true,
      bounds: worldBounds,
      attribution: 'Tiles &copy; Esri &mdash; Esri, USGS, NOAA'
    }
  ).addTo(map);

  // Keep your existing clustering layers, assets, incidents, critical layer etc.
  assetsClusterGroup = L.markerClusterGroup({ chunkedLoading: true, spiderfyOnMaxZoom: true, showCoverageOnHover: false, disableClusteringAtZoom: 10 });
  map.addLayer(assetsClusterGroup);

  incidentClusterGroup = L.markerClusterGroup({
    chunkedLoading: true,
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false,
    disableClusteringAtZoom: 13,
    maxClusterRadius: 50,
    zoomToBoundsOnClick: !isTouch,
    iconCreateFunction: function(cluster) {
      const children = cluster.getAllChildMarkers();
      let count = children.length, maxSeverity = 0, counts = { critical:0, high:0, medium:0, low:0 };
      children.forEach(m => {
        const s = Number(m.options.severity || 1);
        if (s >= 5) { counts.critical++; maxSeverity = Math.max(maxSeverity,5); } else if (s >= 4) { counts.high++; maxSeverity = Math.max(maxSeverity,4); } else if (s === 3) { counts.medium++; maxSeverity = Math.max(maxSeverity,3); } else { counts.low++; }
      });
      let cls = 'cluster-blue';
      if (counts.critical + counts.high > 0) cls = (counts.critical > 0) ? 'cluster-red' : 'cluster-amber';
      if (maxSeverity >= 4) cls = 'cluster-red'; else if (maxSeverity === 3) cls = 'cluster-amber';
      const ariaLabel = escapeAttr(`Cluster of ${count} incidents. ${counts.critical} Critical, ${counts.high} High, ${counts.medium} Medium, ${counts.low} Low.`);
      const html = `<div class="cluster-icon ${cls}" tabindex="0" role="button" aria-label="${ariaLabel}" title="${ariaLabel}" style="width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;"><div class="cluster-count" aria-hidden="true" tabindex="-1">${count}</div></div>`;
      return L.divIcon({ html, className: '', iconSize: [40,40], iconAnchor: [20,20] });
    }
  });

  map.addLayer(incidentClusterGroup);
  criticalLayerGroup = L.layerGroup().addTo(map);
  try { criticalLayerGroup.bringToFront(); } catch(e) {}

  // render the assets exactly as before
  renderAssetsOnMap("Global");
  setTimeout(()=>{ try { map.invalidateSize(); } catch(e){} }, 200);
  window.addEventListener('resize', ()=>{ try { map.invalidateSize(); } catch(e){} });
}

// Ensure the original startup still calls initMap once
document.addEventListener("DOMContentLoaded", function() {
  // call the original initApp or startup logic which will call initMap()
  if (typeof initApp === 'function') {
    initApp();
  } else {
    // if your original file used a different startup, leave the call here
    try { startClock(); initMap(); } catch(e) { console.error(e); }
  }
});
</script>
</body>
</html>
