name: Update SRO Intelligence News & Reports

on:
  schedule:
    # Every hour â€“ adjust as needed
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-news-and-reports:
    runs-on: ubuntu-latest

    env:
      # Optional: default radius for proximity.json (can be overridden via repo/Org secrets)
      PROXIMITY_RADIUS_KM: ${{ secrets.PROXIMITY_RADIUS_KM || '50' }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Run news ingest (RSS -> public/data/news.json)
        run: |
          python scripts/news_agent.py

      - name: Generate proximity + daily HTML reports
        run: |
          python scripts/generate_reports.py

      - name: Show resulting files (for debugging)
        run: |
          ls -R
          echo "---- news.json ----"
          test -f public/data/news.json && head -c 2000 public/data/news.json || echo "news.json missing"
          echo
          echo "---- proximity.json ----"
          test -f public/data/proximity.json && head -c 2000 public/data/proximity.json || echo "proximity.json missing"

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update news, proximity alerts & daily reports"
          file_pattern: |
            public/data/news.json
            public/data/proximity.json
            public/reports/*.html
          branch: ${{ github.ref_name }}
          commit_user_name: "sro-intel-bot"
          commit_user_email: "sro-intel-bot@users.noreply.github.com"
