name: SRO Intel Feed Update

on:
  schedule:
    - cron: "*/15 * * * *"    # every 30 minutes
  workflow_dispatch:

jobs:
  update-feed:
    runs-on: ubuntu-latest

    steps:
    - name: Set up job
      run: echo "Starting update..."

    - name: Checkout Repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0            # IMPORTANT: allows git pull --rebase

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install feedparser folium requests beautifulsoup4 google-generativeai

    - name: Run Intelligence Agent
      run: |
        cd scripts
        python news_agent.py
        python generate_reports.py

    - name: Commit and Push Data
      run: |
        git config --global user.name "SRO-Bot"
        git config --global user.email "sro-bot@example.com"

        # Make sure local matches remote
        git fetch origin
        git checkout main
        git pull --rebase origin main

        # Stage updated files
        git add public/data/news.json || true
        git add public/data/proximity.json || true
        git add public/reports/*.html || true

        # If nothing to commit, exit cleanly
        if git diff --cached --quiet; then
          echo "No changes to commit."
          exit 0
        fi

        git commit -m "Auto-update: SRO Intel Feed"
        git push origin HEAD:main
