name: SRO Intel Feed Update

on:
  schedule:
    # run every 30 minutes
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  update-feed:
    runs-on: ubuntu-latest

    permissions:
      contents: write   # allow pushing back to the repo

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt

      - name: Run Intelligence Agent
        run: |
          cd scripts
          python news_agent.py
          python generate_reports.py

      - name: Commit and Push Data
        run: |
          git config user.name "SRO-Bot"
          git config user.email "sro-bot@users.noreply.github.com"

          # See if anything actually changed
          if [[ -z "$(git status --porcelain)" ]]; then
            echo "No changes to commit."
            exit 0
          fi

          # Add generated data + reports (whole dirs covers news.json, proximity.json, html reports, etc.)
          git add public/data public/reports || true

          # Nothing staged? then bail out cleanly
          if [[ -z "$(git diff --cached --name-only)" ]]; then
            echo "No tracked files changed, skipping commit."
            exit 0
          fi

          git commit -m "Auto-update: SRO Intel Feed"
          # IMPORTANT: no git pull / rebase here â€“ just push current HEAD to main
          git push origin HEAD:main
