<script>
    // --- LOGIN LOGIC (SIMPLE & ROBUST) ---
    function attemptLogin() {
        const input = document.getElementById('passwordInput').value.trim();
        const errorEl = document.getElementById('login-error');

        if (errorEl) errorEl.style.display = 'none';

        if (input === "DellSec2025") {
            document.getElementById('lock-screen').style.display = "none"; // Hide Lock
            document.getElementById('app-container').style.display = "block"; // Show App
            fetchNews(); // Load Data
        } else {
            if (errorEl) {
                errorEl.style.display = 'block';
            } else {
                alert("Incorrect PIN");
            }
        }
    }

    // Enable Enter Key for Login (safe to move script)
    window.addEventListener('DOMContentLoaded', () => {
        const pwd = document.getElementById('passwordInput');
        if (!pwd) return;
        pwd.addEventListener("keydown", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                attemptLogin();
            }
        });
    });

    // --- APP LOGIC ---
    let newsData = [];
    let myChart = null;

    function switchTab(ev, tab) {
        document.getElementById('feed-view').style.display = 'none';
        document.getElementById('map-frame').style.display = 'none';
        document.getElementById('chart-container').style.display = 'none';
        document.getElementById('travel-view').style.display = 'none';

        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));

        if (ev && ev.target) {
            ev.target.classList.add('active');
        }

        if (tab === 'feed') document.getElementById('feed-view').style.display = 'block';
        if (tab === 'map') document.getElementById('map-frame').style.display = 'block';
        if (tab === 'trends') {
            document.getElementById('chart-container').style.display = 'block';
            renderChart();
        }
        if (tab === 'travel') {
            document.getElementById('travel-view').style.display = 'block';
            populateCountries();
        }
    }

    async function fetchNews() {
        try {
            const ts = new Date().getTime();

            const r = await fetch('data/news.json?t=' + ts);
            if (r.ok) {
                newsData = await r.json();
                document.getElementById('last-updated').innerText =
                    "Live DB: " + newsData.length + " Items";
            }

            const r2 = await fetch('data/forecast.json?t=' + ts);
            if (r2.ok) {
                const fc = await r2.json();
                document.getElementById('forecast-display').style.display = 'block';
                document.getElementById('fc-title').innerText = fc.outlook_title;
                document.getElementById('fc-analysis').innerText = fc.analysis;

                const supplyEl = document.getElementById('fc-supply');
                if (supplyEl && fc.supply_chain_warning) {
                    supplyEl.innerText = fc.supply_chain_warning;
                }

                document.getElementById('fc-bottom').innerText = fc.bottom_line;
            }

            renderNews();
        } catch (e) {
            console.log("No data yet", e);
        }
    }

    function renderNews() {
        const dateF = document.getElementById('dateFilter').value;
        const reg = document.getElementById('regionFilter').value;
        const typ = document.getElementById('typeFilter').value;
        const src = document.getElementById('searchBox').value.toLowerCase();
        const con = document.getElementById('news-feed');
        con.innerHTML = '';

        const filtered = newsData.filter(i => {
            const dateMatch = dateF ? i.date_str === dateF : true;
            return (
                dateMatch &&
                (reg === 'All' || i.region === reg) &&
                (typ === 'All' || i.category === typ) &&
                (i.title.toLowerCase().includes(src) || i.snippet.toLowerCase().includes(src))
            );
        });

        if (filtered.length === 0) {
            con.innerHTML = '<div class="text-center text-muted mt-5">No active threats.</div>';
            return;
        }

        filtered.forEach(i => {
            let bCls = i.severity === 3 ? 'badge-critical' : 'badge-warning';
            let bTxt = i.severity === 3 ? 'CRITICAL' : 'WARNING';
            const niceDate = new Date(i.published).toLocaleString();
            con.innerHTML += `
                <div class="card severity-${i.severity}">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge-custom ${bCls}">${bTxt}</span>
                            <span class="badge bg-light text-dark border">${i.category}</span>
                            <span class="ms-auto text-muted small">${i.region}</span>
                        </div>
                        <h5 class="card-title">
                            <a href="${i.link}" target="_blank">${i.title}</a>
                        </h5>
                        <div class="text-muted small mb-2">
                            ${i.source} &bull; ${niceDate}
                        </div>
                        <p class="mb-0 small text-secondary">${i.snippet}</p>
                    </div>
                </div>`;
        });
    }

    function renderChart() {
        if (myChart) myChart.destroy();
        const dateCounts = {};
        newsData.forEach(item => {
            const d = item.date_str;
            if (!dateCounts[d]) dateCounts[d] = 0;
            dateCounts[d]++;
        });
        const sortedDates = Object.keys(dateCounts).sort().slice(-7);
        const counts = sortedDates.map(d => dateCounts[d]);
        const ctx = document.getElementById('riskChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sortedDates,
                datasets: [{
                    label: 'Incidents',
                    data: counts,
                    backgroundColor: '#0076CE'
                }]
            }
        });
    }

    function populateCountries() {
        const sel = document.getElementById('travelCountry');
        const countries = ["Australia", "Brazil", "China", "France", "Germany", "India", "Indonesia", "Israel", "Japan", "Korea", "Malaysia", "Mexico", "Philippines", "Singapore", "Taiwan", "Thailand", "UK", "USA", "Vietnam"];
        sel.innerHTML = '<option value="">Select a country...</option>';
        countries.sort().forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
    }

    function renderTravelCheck() {
        const c = document.getElementById('travelCountry').value;
        const con = document.getElementById('travel-feed');
        con.innerHTML = '';
        if (!c) return;
        const hits = newsData.filter(i => (i.title + i.snippet).includes(c));
        if (hits.length === 0) {
            con.innerHTML = "<div class='alert alert-success'>âœ… No critical threats detected.</div>";
        } else {
            hits.forEach(i => con.innerHTML += `<div class="alert alert-warning"><b>${i.date_str}</b>: ${i.title}</div>`);
        }
    }
</script>
